<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมประดิษฐภาษา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f3e8ff;
            --text-color: #1f2937; /* Default gray-800 */
            --modal-bg-color: rgba(0,0,0,0.5);
            --modal-content-bg-color: #ede9fe;
            --modal-content-text-color: #5b21b6;
            --btn-primary-bg-color: #7c3aed;
            --btn-primary-text-color: white;
            --btn-primary-hover-bg-color: #6d28d9;
            --btn-secondary-bg-color: #a78bfa;
            --btn-secondary-text-color: white;
            --btn-secondary-hover-bg-color: #8b5cf6;
            --section-title-color: #5b21b6;
            --section-title-border-color: #7c3aed;
            --tab-button-bg-color: #ddd6fe;
            --tab-button-text-color: #5b21b6;
            --tab-button-border-color: #c4b5fd;
            --tab-button-active-bg-color: #7c3aed;
            --tab-button-active-text-color: white;
            --header-bg-color: #6d28d9; /* Darker purple for header */
            --header-text-color: white;
            --footer-bg-color: #5b21b6; /* Even darker for footer */
            --footer-text-color: white;
            --link-color: #7c3aed;
            --link-hover-color: #5b21b6;
            --card-bg-color: white;
            --card-shadow-color: rgba(0,0,0,0.1);
            --border-color-light: #e5e7eb; /* gray-200 */
            --border-color-medium: #d1d5db; /* gray-300 */
            --input-bg-color: white;
            --input-border-color: #c4b5fd; /* purple-300 */
            --input-focus-ring-color: #a78bfa; /* purple-400 */
            --disabled-section-opacity: 0.5;
            --scrollbar-track-color: #f3e8ff;
            --scrollbar-thumb-color: #a78bfa;
            --scrollbar-thumb-hover-color: #8b5cf6;
            --pedigree-line-color: #7c3aed;
            --pedigree-node-bg-color: #ede9fe;
            --pedigree-node-border-color: #c4b5fd;
            --info-box-bg-color: #e9d5ff;
            --info-box-border-color: #c084fc;
            --info-box-strong-color: #5b21b6;

            --list-input-section-bg: #f5f3ff; /* purple-50 */
            --list-input-section-border: #dcd7fe; /* purple-200 */
            --list-input-label-color: #6b21a8; /* purple-700 */
            --chip-bg-color: #7c3aed; /* purple-500 */
            --chip-text-color: white;
            --chip-remove-hover-color: #ede9fe; /* purple-100 */

            --phonology-tab-bg: #f0e6ff;
            --phonology-tab-border: #e0cff7;
            --wordgen-tab-bg: #f0fff0;
            --wordgen-tab-border: #d4f7d4;
            --grammar-tab-bg: #e6f0ff;
            --grammar-tab-border: #d1e0f7;
            --dictionary-tab-bg: #ffffe6;
            --dictionary-tab-border: #f7f7d1;
            --orthography-tab-bg: #e6ffff;
            --orthography-tab-border: #d1f7f7;
            --etymology-tab-bg: #f0fff8;
            --etymology-tab-border: #d4f7e8;
            --evolution-tab-bg: #f8f0ff;
            --evolution-tab-border: #e8d4f7;
            --dialects-tab-bg: #fafff0;
            --dialects-tab-border: #eaf7d4;
            --sentencegen-tab-bg: #e6faff;
            --sentencegen-tab-border: #d1eaf7;
            --langfamily-tab-bg: #ffe6f0;
            --langfamily-tab-border: #f7d1e0;
            --soundchange-tab-bg: #ffe6e6;
            --soundchange-tab-border: #f7d1d1;
            --tools-tab-bg: #f0f0f0;
            --tools-tab-border: #e0e0e0;
        }

        body.dark-theme {
            --bg-color: #1f2937; /* gray-800 */
            --text-color: #f3f4f6; /* gray-100 */
            --modal-content-bg-color: #374151; /* gray-700 */
            --modal-content-text-color: #d1d5db; /* gray-300 */
            --btn-primary-bg-color: #8b5cf6; /* lighter purple */
            --btn-primary-hover-bg-color: #7c3aed;
            --btn-secondary-bg-color: #6b21a8; /* darker purple */
            --btn-secondary-hover-bg-color: #5b21b6;
            --section-title-color: #a78bfa; /* lighter purple */
            --section-title-border-color: #8b5cf6;
            --tab-button-bg-color: #4b5563; /* gray-600 */
            --tab-button-text-color: #e5e7eb; /* gray-200 */
            --tab-button-border-color: #5b21b6;
            --tab-button-active-bg-color: #8b5cf6;
            --tab-button-active-text-color: white;
            --header-bg-color: #111827; /* gray-900 */
            --footer-bg-color: #000000; /* black */
            --link-color: #a78bfa;
            --link-hover-color: #c4b5fd;
            --card-bg-color: #374151; /* gray-700 */
            --card-shadow-color: rgba(255,255,255,0.05);
            --border-color-light: #4b5563; /* gray-600 */
            --border-color-medium: #6b7280; /* gray-500 */
            --input-bg-color: #4b5563; /* gray-600 */
            --input-border-color: #6b21a8; /* darker purple */
            --input-focus-ring-color: #8b5cf6; /* lighter purple */
            --scrollbar-track-color: #1f2937;
            --scrollbar-thumb-color: #4b5563;
            --scrollbar-thumb-hover-color: #6b7280;
            --pedigree-line-color: #a78bfa;
            --pedigree-node-bg-color: #4b5563;
            --pedigree-node-border-color: #6b21a8;
            --info-box-bg-color: #2d213f; /* Dark purple variant */
            --info-box-border-color: #5b21b6;
            --info-box-strong-color: #a78bfa;

            --list-input-section-bg: #2a3038; /* dark-grayish */
            --list-input-section-border: #4b5563; /* gray-600 */
            --list-input-label-color: #c4b5fd; /* light-purple */
            --chip-bg-color: #6b21a8; /* dark-purple */
            --chip-text-color: #e5e7eb; /* gray-200 */
            --chip-remove-hover-color: #a78bfa; /* light-purple */

            --phonology-tab-bg: #2a3038;
            --phonology-tab-border: #3e324e;
            --wordgen-tab-bg: #2a382a;
            --wordgen-tab-border: #324e32;
            --grammar-tab-bg: #2a3038;
            --grammar-tab-border: #323e4e;
            --dictionary-tab-bg: #38382a;
            --dictionary-tab-border: #4e4e32;
            --orthography-tab-bg: #2a3838;
            --orthography-tab-border: #324e4e;
            --etymology-tab-bg: #2a3830;
            --etymology-tab-border: #324e40;
            --evolution-tab-bg: #302a38;
            --evolution-tab-border: #40324e;
            --dialects-tab-bg: #38382a;
            --dialects-tab-border: #4e4e32;
            --sentencegen-tab-bg: #2a3838;
            --sentencegen-tab-border: #324e4e;
            --langfamily-tab-bg: #382a30;
            --langfamily-tab-border: #4e3240;
            --soundchange-tab-bg: #382a2a;
            --soundchange-tab-border: #4e3232;
            --tools-tab-bg: #252525;
            --tools-tab-border: #3a3a3a;
        }

        body {
            font-family: 'Inter', 'Kanit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .modal {
            background-color: var(--modal-bg-color);
        }
        .modal-content {
            background-color: var(--modal-content-bg-color);
            color: var(--modal-content-text-color);
        }
        .btn-primary {
            background-color: var(--btn-primary-bg-color);
            color: var(--btn-primary-text-color);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg-color);
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg-color);
            color: var(--btn-secondary-text-color);
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover-bg-color);
        }
        .section-title {
            color: var(--section-title-color);
            border-bottom: 2px solid var(--section-title-border-color);
            padding-bottom: 8px;
        }
        .tab-button {
            background-color: var(--tab-button-bg-color);
            color: var(--tab-button-text-color);
            border-color: var(--tab-button-border-color);
        }
        .tab-button.active {
            background-color: var(--tab-button-active-bg-color);
            color: var(--tab-button-active-text-color);
            border-color: var(--tab-button-active-bg-color);
        }
        .disabled-section {
            opacity: var(--disabled-section-opacity);
            pointer-events: none;
        }
        header {
            background-color: var(--header-bg-color);
            color: var(--header-text-color);
        }
        footer {
            background-color: var(--footer-bg-color);
            color: var(--footer-text-color);
        }
        footer a {
            color: var(--link-color);
        }
        footer a:hover {
            color: var(--link-hover-color);
        }
        #mainContent > div { /* The main card */
            background-color: var(--card-bg-color);
            box-shadow: 0 4px 6px -1px var(--card-shadow-color), 0 2px 4px -1px var(--card-shadow-color);
        }
        input, select, textarea {
            background-color: var(--input-bg-color);
            color: var(--text-color); /* Use general text color for input text */
            border: 1px solid var(--input-border-color);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--input-focus-ring-color);
            box-shadow: 0 0 0 2px var(--input-focus-ring-color);
        }
        select option { /* For dropdown options specifically if they don't inherit well */
             background-color: var(--input-bg-color);
             color: var(--text-color);
        }
        body.dark-theme select option { /* Override for dark theme if necessary */
            background-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
        }
        .list-input-section {
            background-color: var(--list-input-section-bg) !important;
            border: 1px solid var(--list-input-section-border) !important;
        }
        .list-input-section label {
            color: var(--list-input-label-color) !important;
        }
        .list-input-section .bg-purple-500 { /* Chip color */
            background-color: var(--chip-bg-color) !important;
            color: var(--chip-text-color) !important;
        }
        .list-input-section .text-purple-200:hover {
            color: var(--chip-remove-hover-color) !important;
        }

        /* Specific tab background colors */
        .phonology-section-class { background-color: var(--phonology-tab-bg); border-color: var(--phonology-tab-border); }
        .word-gen-section-class { background-color: var(--wordgen-tab-bg); border-color: var(--wordgen-tab-border); }
        .grammar-section-class { background-color: var(--grammar-tab-bg); border-color: var(--grammar-tab-border); }
        .dictionary-section-class { background-color: var(--dictionary-tab-bg); border-color: var(--dictionary-tab-border); }
        .orthography-section-class { background-color: var(--orthography-tab-bg); border-color: var(--orthography-tab-border); }
        .etymology-section-class { background-color: var(--etymology-tab-bg); border-color: var(--etymology-tab-border); }
        .evolution-main-section { background-color: var(--evolution-tab-bg); border-color: var(--evolution-tab-border); }
        .dialects-main-section { background-color: var(--dialects-tab-bg); border-color: var(--dialects-tab-border); }
        .sentence-gen-main-section { background-color: var(--sentencegen-tab-bg); border-color: var(--sentencegen-tab-border); }
        .lang-family-main-section { background-color: var(--langfamily-tab-bg); border-color: var(--langfamily-tab-border); }
        .sound-change-main-section { background-color: var(--soundchange-tab-bg); border-color: var(--soundchange-tab-border); }
        .tools-main-section { background-color: var(--tools-tab-bg); border-color: var(--tools-tab-border); }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover-color);
        }
        .pedigree-chart ul {
            padding-left: 20px;
            list-style-type: none;
            position: relative;
        }
        .pedigree-chart li {
            margin: 10px 0;
            position: relative;
            padding-left: 25px;
        }
        .pedigree-chart li::before, .pedigree-chart li::after {
            content: '';
            position: absolute;
            left: 0;
            border-color: var(--pedigree-line-color);
        }
        .pedigree-chart li::before {
            border-top: 1px solid var(--pedigree-line-color);
            top: 10px;
            width: 20px;
            height: 0;
        }
        .pedigree-chart li:not(:last-child)::after {
            border-left: 1px solid var(--pedigree-line-color);
            height: 100%;
            width: 0px;
            top: 0px;
        }
        .pedigree-chart li:last-child::after {
            border-left: 1px solid var(--pedigree-line-color);
            height: 10px;
            width: 0px;
            top: 0px;
        }
        .pedigree-node {
            background-color: var(--pedigree-node-bg-color);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--pedigree-node-border-color);
            display: inline-block;
        }
        .animated-emoji {
            display: inline-block;
            animation: pulse 2.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        #hamburgerMenu {
            transition: transform 0.3s ease-in-out;
            background-color: var(--header-bg-color); /* Match header */
            color: var(--header-text-color);
        }
        #hamburgerMenu.open {
            transform: translateX(0);
        }
        #hamburgerMenu.closed {
            transform: translateX(-100%);
        }
        .word-detail-popup-field:not(:empty) {
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color-medium);
        }
        .word-detail-popup-field:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid var(--border-color-medium);
            background-color: var(--input-bg-color); /* Use input bg for consistency */
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
            color: var(--text-color); /* Ensure text color matches theme */
        }
        .autocomplete-suggestion:hover {
            background-color: var(--tab-button-bg-color); /* Use tab button bg for hover */
        }
        #languageSelector {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* background-image will be set by JS based on theme */
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em;
            background-color: var(--btn-secondary-bg-color); /* Match other header buttons */
            color: var(--btn-secondary-text-color);
        }
        .info-box {
            background-color: var(--info-box-bg-color);
            border: 1px solid var(--info-box-border-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .info-box p { margin-bottom: 0.5rem; }
        .info-box strong { color: var(--info-box-strong-color); }

        .era-stage {
            padding: 8px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            background-color: var(--list-input-section-bg);
            margin-bottom: 5px;
        }
        .lineage-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .lineage-era-node {
            background-color: var(--pedigree-node-bg-color);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--pedigree-node-border-color);
            margin-right: 15px;
            min-width: 150px;
            text-align: center;
            white-space: nowrap;
        }
        .lineage-arrow {
            font-size: 1.2em;
            color: var(--section-title-color);
            margin-right: 15px;
        }
        .lineage-era-node:last-child {
            margin-right: 0;
        }
        .dialect-forms-modal-content, .word-evolution-display-modal-content {
             background-color: var(--modal-content-bg-color);
             color: var(--modal-content-text-color);
             max-width: 90%;
             width: 600px; /* Default width */
        }
    </style>
</head>
<body class="text-gray-800"> <!-- text-gray-800 is a fallback, colors primarily from CSS vars -->

    <div id="languageNameModal" class="fixed inset-0 z-50 flex items-center justify-center modal">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-center">👋 ยินดีต้อนรับสู่โปรแกรมประดิษฐภาษา!</h2>
            
            <div id="existingLanguageLoaderSectionModal" class="hidden mb-3">
                 <p class="mb-1 text-center text-sm">เลือกภาษาที่สร้างไว้แล้ว:</p>
                 <select id="modalExistingLanguageSelector" class="w-full p-2 border rounded-md mb-2"></select>
                 <button id="loadSelectedLangFromModalBtn" class="w-full btn-secondary py-2 px-4 rounded-md font-semibold mb-2 text-sm">โหลดภาษาที่เลือก</button>
                 <hr class="my-3">
                 <p class="mb-1 text-center text-sm">หรือสร้างภาษาใหม่:</p>
            </div>

            <p class="mb-2 text-center">กรุณาตั้งชื่อภาษาของคุณ:</p>
            <input type="text" id="languageNameInput" class="w-full p-2 border rounded-md mb-3 focus:ring-2 focus:border-transparent" placeholder="เช่น 'นาคภาษ', 'สวาดิท'">
            <button id="submitLanguageName" class="w-full btn-primary py-2 px-4 rounded-md font-semibold mb-3">เริ่มสร้างภาษา ✨</button>
            <hr class="my-3">
            <label for="importDataFromModalInput" class="w-full btn-secondary py-2 px-4 rounded-md font-semibold text-sm cursor-pointer block text-center">นำเข้าข้อมูลจากไฟล์ .json</label>
            <input type="file" id="importDataFromModalInput" class="hidden" accept=".json">
        </div>
    </div>

    <div id="aboutModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden">
        <div class="modal-content p-8 rounded-lg shadow-xl w-full max-w-lg text-center">
            <h2 class="text-2xl font-bold mb-4">นวัตกรรมประดิษฐภาษา</h2>
            <p class="mb-2 text-lg">“การสร้างภาษาใหม่ เพื่อการเรียนรู้ในรายวิชาภาษาไทย”</p>
            <hr class="my-4">
            <h3 class="text-xl font-semibold mb-2">จัดทำโดย</h3>
            <ul class="list-none mb-4">
                <li>นายวิทยา หมายมั่น</li>
                <li>นายชาตรี แสนยากุล</li>
                <li>นายณัฐกานต์ เครือโย</li>
                <li>นางสาวนิชนิภา พั้วทัด</li>
                <li>นางสาวทิพยรัตน์ แสนประสิทธิ์</li>
            </ul>
            <h3 class="text-xl font-semibold mb-2">อาจารย์ที่ปรึกษานวัตกรรม</h3>
            <p class="mb-6">อาจารย์ ดร. พรทิพย์ ครามจันทึก</p>
             <h4 class="text-xl font-semibold mb-2">ระบบอยู่ระหว่างการพัฒนาอาจมีการหน่วงหรือช้า</43> 
            <button id="closeAboutModal" class="btn-secondary py-2 px-6 rounded-md font-semibold">ปิด</button>
        </div>
    </div>

    <div id="languageInfoModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="languageInfoTitle" class="text-2xl font-bold">🌍 ข้อมูลทั่วไปของภาษา</h3>
                <button id="closeLanguageInfoModal" class="hover:text-purple-700 text-2xl">&times;</button>
            </div>
            <div id="languageInfoContent" class="space-y-3">
                <div><label class="block text-sm font-medium">ชื่อภาษา:</label><input type="text" id="infoLangName" class="w-full p-2 border rounded-md bg-gray-100" readonly></div>
                <div><label class="block text-sm font-medium">ความหมาย/แนวคิด:</label><textarea id="infoLangDescription" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                <div><label class="block text-sm font-medium">พัฒนาการทางภาษา:</label><textarea id="infoLangHistory" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                <div><label class="block text-sm font-medium">ลักษณะเด่นของภาษา:</label><textarea id="infoLangFeatures" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                <div><label class="block text-sm font-medium">ระบบเสียง (สรุป):</label><textarea id="infoLangSoundSystem" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                <div><label class="block text-sm font-medium">ระบบการเขียน (สรุป):</label><textarea id="infoLangWritingSystem" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                <div><label class="block text-sm font-medium">จำนวนผู้ใช้ (โดยประมาณ):</label><input type="number" id="infoLangNumSpeakers" class="w-full p-2 border rounded-md" min="0"></div>
                <div><label class="block text-sm font-medium">ประเทศ/ถิ่นที่ใช้:</label><input type="text" id="infoLangCountries" class="w-full p-2 border rounded-md"></div>
                <div>
                    <label class="block text-sm font-medium">สถานะทางภาษา:</label>
                    <select id="infoLangStatus" class="w-full p-2 border rounded-md">
                        <option value="ใช้งานอยู่">ใช้งานอยู่ (Living)</option>
                        <option value="จารีต">จารีต/โบราณ (Classical/Ceremonial)</option>
                        <option value="ถูกประดิษฐ์">ถูกประดิษฐ์ (Constructed)</option>
                        <option value="ใกล้สูญ">ใกล้สูญ (Endangered)</option>
                        <option value="สูญแล้ว">สูญแล้ว (Extinct)</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="saveLanguageInfo" class="btn-primary px-4 py-2 rounded-md">บันทึกข้อมูลภาษา</button>
            </div>
        </div>
    </div>


    <div id="wordDetailModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="wordDetailTitle" class="text-2xl font-bold"></h3>
                <button id="closeWordDetailModal" class="hover:text-purple-700 text-2xl">&times;</button>
            </div>
            <div id="wordDetailContent" class="space-y-3"></div>
            <div id="wordDetailActions" class="mt-4 space-x-2 flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div id="wordDialectFormsModal" class="fixed inset-0 z-[60] flex items-center justify-center modal hidden p-4">
        <div class="dialect-forms-modal-content p-6 rounded-lg shadow-xl w-full max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="wordDialectFormsTitle" class="text-xl font-bold"></h3>
                <button id="closeWordDialectFormsModal" class="hover:text-lime-800 text-2xl">&times;</button>
            </div>
            <div id="wordDialectFormsContent" class="text-sm"></div>
             <div class="mt-4 flex justify-end">
                <button id="addNewDialectFormFromPopupBtn" class="btn-secondary bg-lime-500 hover:bg-lime-600 px-3 py-1 rounded-md text-xs">
                    <i class="fas fa-plus-circle mr-1"></i> เพิ่ม/แก้ไขรูปคำถิ่นอื่น
                </button>
            </div>
        </div>
    </div>

    <div id="wordEvolutionDisplayModal" class="fixed inset-0 z-[60] flex items-center justify-center modal hidden p-4">
        <div class="word-evolution-display-modal-content p-6 rounded-lg shadow-xl w-full max-h-[85vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-4">
                <h3 id="wordEvolutionDisplayTitle" class="text-xl font-bold"></h3>
                <button id="closeWordEvolutionDisplayModal" class="hover:text-purple-800 text-2xl">&times;</button>
            </div>
            <div id="wordEvolutionDisplayContent" class="text-sm lineage-container"></div>
        </div>
    </div>
    
    <div id="selectWordForEvolutionModal" class="fixed inset-0 z-[60] flex items-center justify-center modal hidden p-4">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-md max-h-[85vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">เลือกคำศัพท์ตั้งต้นสำหรับสายวิวัฒนาการ</h3>
            <div class="space-y-3">
                <div>
                    <label for="evolutionBaseWordSelect" class="block text-sm font-medium">คำศัพท์จากพจนานุกรม:</label>
                    <select id="evolutionBaseWordSelect" class="w-full p-2 border rounded-md"></select>
                </div>
                <div>
                    <label for="evolutionLineageConceptName" class="block text-sm font-medium">ชื่อแนวคิด/กลุ่ม (ถ้าต้องการ):</label>
                    <input type="text" id="evolutionLineageConceptName" class="w-full p-2 border rounded-md" placeholder="เช่น *Proto-Water, Sun-related">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelSelectWordForEvolution" class="btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm">ยกเลิก</button>
                <button id="confirmSelectWordForEvolution" class="btn-primary px-4 py-2 rounded-md text-sm">เริ่มสายวิวัฒนาการ</button>
            </div>
        </div>
    </div>


    <div id="hamburgerMenu" class="fixed top-0 left-0 h-full w-64 text-white p-5 z-40 closed shadow-lg">
        <button id="closeHamburgerMenu" class="absolute top-3 right-3 text-2xl hover:text-purple-300">&times;</button>
        <h2 class="text-xl font-semibold mb-6 mt-8">เมนูหลัก</h2>
        <nav>
            <ul>
                <li class="mb-3"><a href="#" id="menuLinkPhonology" class="hover:text-purple-300 block py-2 px-1 rounded"><i class="fas fa-cogs mr-2"></i> โปรแกรมประดิษฐภาษา</a></li>
                <li class="mb-3"><a href="YOUR_IPA_LINK_HERE" target="_blank" id="menuLinkIpa" class="hover:text-purple-300 block py-2 px-1 rounded"><i class="fas fa-microphone-alt mr-2"></i> โปรแกรมแสดงสัทอักษร <span class="text-xs">(ลิงก์ภายนอก)</span></a></li>
                <li class="mb-3"><a href="YOUR_THAI_USAGE_LINK_HERE" target="_blank" id="menuLinkThaiUsage" class="hover:text-purple-300 block py-2 px-1 rounded"><i class="fas fa-chalkboard-teacher mr-2"></i> การประยุกต์ใช้ในวิชาภาษาไทย <span class="text-xs">(ลิงก์ภายนอก)</span></a></li>
            </ul>
        </nav>
    </div>


    <div id="appWrapper" class="min-h-screen flex flex-col">
        <header class="p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <button id="openHamburgerMenu" class="text-2xl p-2 hover:bg-purple-500 rounded-md"><i class="fas fa-bars"></i></button>
                <h1 id="mainTitle" class="text-xl sm:text-3xl font-bold text-center flex-grow px-2">โปรแกรมประดิษฐภาษา <span class="animated-emoji">🧠</span></h1>
                <div class="flex items-center space-x-2">
                    <button id="themeToggleBtn" class="btn-secondary py-2 px-3 rounded-md font-semibold text-sm" title="Toggle Theme">☀️</button>
                    <button id="languageInfoButton" class="btn-secondary py-2 px-3 rounded-md font-semibold text-sm hidden sm:inline-block" title="ข้อมูลทั่วไปของภาษา"><i class="fas fa-info-circle"></i></button>
                    <div class="relative">
                        <select id="languageSelector" class="py-2 pl-3 pr-8 rounded-md text-sm focus:outline-none focus:ring-2 appearance-none">
                            <option value="">-- เลือกภาษา --</option>
                            </select>
                    </div>
                    <button id="addNewLangButton" class="btn-secondary py-2 px-3 rounded-md font-semibold text-sm whitespace-nowrap"><i class="fas fa-plus-circle mr-1"></i> สร้างภาษาใหม่</button>
                    <button id="aboutButton" class="btn-secondary py-2 px-3 rounded-md font-semibold text-sm hidden sm:inline-block">📜 เกี่ยวกับ</button>
                    </div>
            </div>
        </header>

        <main id="mainContent" class="container mx-auto p-4 flex-grow disabled-section">
            <div class="p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-2">ภาษาปัจจุบัน: <span id="currentLanguageNameDisplay" class="text-purple-600">N/A</span></h2>
                <div class="mb-4 border-b">
                    <nav class="flex space-x-1 overflow-x-auto pb-2" aria-label="Tabs">
                        </nav>
                </div>
                <div id="tabContent">
                    </div>
            </div>
        </main>

        <footer class="text-center p-4 mt-auto">
            <p>Developer: วิทยา หมายมั่น และคณะ</p>
            <p>อาจารย์ที่ปรึกษานวัตกรรม: อาจารย์ ดร. พรทิพย์ ครามจันทึก</p>
            <p>ระบบอยู่ระหว่างการพัฒนาอาจมีการหน่วงหรือช้าก็ขออภัยมา ณ ที่นี้</p>
            <p>ติดต่อ: <a href="https://kruarthurclassroom.blogspot.com/" target="_blank" class="hover:underline">kruarthurclassroom.blogspot.com</a></p>
            <p>© 2025-2026 All Rights Reserved</p>
        </footer>
    </div>

    <script>
        // --- Global State and Data Structures ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyQt6pWFF_y0LZBA38C8VheADB-bud0PshyYiUehFTWZxWUqzB5d0n_EzmMA7MDwAYnwQ/exec";
        let thaiWordDatabase = []; // Will store {word: string, pos: string, meaning: string}

        const DEFAULT_BASE_PARTS_OF_SPEECH = Object.freeze(['คำนาม', 'คำกริยา', 'คำคุณศัพท์', 'คำสรรพนาม', 'คำวิเศษณ์', 'คำบุพบท', 'คำสันธาน', 'คำอุทาน']);
        const DEFAULT_BASE_NOUN_GENDERS = Object.freeze(['ปุงลิงค์', 'อิตถีลิงค์', 'นปุงสกลิงค์']);
        const DEFAULT_BASE_DIALECT_REGIONS = Object.freeze(['มาตรฐาน', 'เหนือ', 'ใต้', 'ตะวันออก', 'ตะวันตก']);


        const DEFAULT_LANGUAGE_STATE = Object.freeze({
            name: '',
            info: {
                description: '',
                history: '',
                linguisticFeatures: '',
                soundSystemNotes: '',
                writingSystemNotes: '',
                numSpeakers: 0,
                countries: '',
                status: 'ถูกประดิษฐ์',
                referenceLanguages: [],
                parentLanguageName: null,
            },
            phonology: {
                consonants: ['k', 't', 'm', 'n', 'r'],
                vowels: ['a', 'e', 'i', 'o', 'u'],
                tones: [],
                syllableStructures: ['CV', 'CVC'],
                phonotactics: [
                    { rule: "ห้ามพยัญชนะซ้อน", type: "no_consonant_cluster", enabled: true, custom: false, pattern: "" },
                    { rule: "ห้ามขึ้นต้นด้วยสระ", type: "no_initial_vowel", enabled: false, custom: false, pattern: "" }
                ]
            },
            lexicon: [], // {id, word, phonetics, meaning, partOfSpeech, gender, example, synonyms, etymology: {roots, notes}}
            grammar: {
                sentenceStructure: 'SVO',
                partsOfSpeech: [...DEFAULT_BASE_PARTS_OF_SPEECH],
                customPartsOfSpeech: [],
                nounGenders: {
                    enabled: false,
                    genders: [...DEFAULT_BASE_NOUN_GENDERS],
                    customGenders: []
                },
                morphology: {
                    inflectionRules: [],
                },
                particles: []
            },
            orthography: {
                writingSystem: 'latin',
                customSymbols: [], // {sound: 'sh', symbol: 'š'}
                direction: 'ltr'
            },
            languageEras: ['Proto-Language', 'Old Language', 'Modern Language'],
            wordLineages: [], // {lineageId, baseName, forms: {eraName: {orthographic, phonemic_override, notes, linkedLexiconId}}}
            exampleSentences: [], // {conlang: "...", translation: "...", relatedWordId: null}
            soundChangeRules: [], // {from: 'p', to: 'f', contextBefore: 'V_', contextAfter: '_V'}
            dialects: {
                enabled: false,
                regions: [...DEFAULT_BASE_DIALECT_REGIONS],
                customRegions: [],
                dialectWords: [] // {standardWordId, region, dialectPhonetic, dialectOrthographic, dialectPhoneticsIPA, dialectMeaning, notes}
            },
            theme: 'default' // For future thematic elements, not visual theme
        });

        let currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
        let allLanguages = [];

        // --- UI Elements ---
        const languageNameModal = document.getElementById('languageNameModal');
        const languageNameInput = document.getElementById('languageNameInput');
        const submitLanguageNameButton = document.getElementById('submitLanguageName');
        const importDataFromModalInput = document.getElementById('importDataFromModalInput');
        const modalExistingLanguageSelector = document.getElementById('modalExistingLanguageSelector');
        const loadSelectedLangFromModalBtn = document.getElementById('loadSelectedLangFromModalBtn');
        const existingLanguageLoaderSectionModal = document.getElementById('existingLanguageLoaderSectionModal');


        const mainContent = document.getElementById('mainContent');
        const currentLanguageNameDisplay = document.getElementById('currentLanguageNameDisplay');
        const aboutModal = document.getElementById('aboutModal');
        const aboutButton = document.getElementById('aboutButton');
        const closeAboutModalButton = document.getElementById('closeAboutModal');
        const tabContainer = document.querySelector('nav[aria-label="Tabs"]');
        const tabContentContainer = document.getElementById('tabContent');
        const addNewLangButton = document.getElementById('addNewLangButton');
        const languageSelector = document.getElementById('languageSelector');
        const themeToggleBtn = document.getElementById('themeToggleBtn');


        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const openHamburgerMenuButton = document.getElementById('openHamburgerMenu');
        const closeHamburgerMenuButton = document.getElementById('closeHamburgerMenu');
        const menuLinkPhonology = document.getElementById('menuLinkPhonology');
        const menuLinkIpa = document.getElementById('menuLinkIpa');
        const menuLinkThaiUsage = document.getElementById('menuLinkThaiUsage');

        const wordDetailModal = document.getElementById('wordDetailModal');
        const wordDetailTitle = document.getElementById('wordDetailTitle');
        const wordDetailContent = document.getElementById('wordDetailContent');
        const wordDetailActions = document.getElementById('wordDetailActions');
        const closeWordDetailModalButton = document.getElementById('closeWordDetailModal');

        const languageInfoModal = document.getElementById('languageInfoModal');
        const languageInfoButton = document.getElementById('languageInfoButton');
        const closeLanguageInfoModalButton = document.getElementById('closeLanguageInfoModal');
        const saveLanguageInfoButton = document.getElementById('saveLanguageInfo');

        const wordDialectFormsModal = document.getElementById('wordDialectFormsModal');
        const wordDialectFormsTitle = document.getElementById('wordDialectFormsTitle');
        const wordDialectFormsContent = document.getElementById('wordDialectFormsContent');
        const closeWordDialectFormsModal = document.getElementById('closeWordDialectFormsModal');
        const addNewDialectFormFromPopupBtn = document.getElementById('addNewDialectFormFromPopupBtn');

        const wordEvolutionDisplayModal = document.getElementById('wordEvolutionDisplayModal');
        const wordEvolutionDisplayTitle = document.getElementById('wordEvolutionDisplayTitle');
        const wordEvolutionDisplayContent = document.getElementById('wordEvolutionDisplayContent');
        const closeWordEvolutionDisplayModal = document.getElementById('closeWordEvolutionDisplayModal');

        const selectWordForEvolutionModal = document.getElementById('selectWordForEvolutionModal');
        const evolutionBaseWordSelect = document.getElementById('evolutionBaseWordSelect');
        const evolutionLineageConceptName = document.getElementById('evolutionLineageConceptName');
        const confirmSelectWordForEvolutionBtn = document.getElementById('confirmSelectWordForEvolution');
        const cancelSelectWordForEvolutionBtn = document.getElementById('cancelSelectWordForEvolution');


        // --- Tabs Configuration ---
        const tabs = [
            { id: 'phonology', name: '🎶 ระบบเสียง', icon: 'fas fa-volume-up', contentFunc: renderPhonologyUI, sectionClass: 'phonology-section-class' },
            { id: 'wordGen', name: '✍️ สร้างคำ', icon: 'fas fa-pencil-alt', contentFunc: renderWordGeneratorUI, sectionClass: 'word-gen-section-class' },
            { id: 'grammar', name: '📖 ไวยากรณ์', icon: 'fas fa-book', contentFunc: renderGrammarUI, sectionClass: 'grammar-section-class' },
            { id: 'dictionary', name: '📚 พจนานุกรม', icon: 'fas fa-atlas', contentFunc: renderDictionaryUI, sectionClass: 'dictionary-section-class' },
            { id: 'orthography', name: '🔤 อักขรวิธี', icon: 'fas fa-spell-check', contentFunc: renderOrthographyUI, sectionClass: 'orthography-section-class' },
            { id: 'etymology', name: '🌱 ศัพทมูล', icon: 'fas fa-seedling', contentFunc: renderEtymologyUI, sectionClass: 'etymology-section-class' },
            { id: 'evolution', name: '⏳ วิวัฒนาการคำ', icon: 'fas fa-stream', contentFunc: renderEvolutionUI, sectionClass: 'evolution-main-section' },
            { id: 'dialects', name: '🗺️ ภาษาถิ่น', icon: 'fas fa-map-signs', contentFunc: renderDialectsUI, sectionClass: 'dialects-main-section' },
            { id: 'sentenceGen', name: '📝 สร้างประโยค', icon: 'fas fa-comments', contentFunc: renderSentenceGeneratorUI, sectionClass: 'sentence-gen-main-section' },
            { id: 'langFamily', name: '🌳 ตระกูลภาษา', icon: 'fas fa-sitemap', contentFunc: renderLangFamilyUI, sectionClass: 'lang-family-main-section' },
            { id: 'soundChange', name: '🗣️ เทียบเสียง/รูป', icon: 'fas fa-exchange-alt', contentFunc: renderSoundChangeUI, sectionClass: 'sound-change-main-section' },
            { id: 'tools', name: '🛠️ เครื่องมือ', icon: 'fas fa-tools', contentFunc: renderToolsUI, sectionClass: 'tools-main-section' }
        ];
        let activeTab = tabs[0].id;

        // --- Initialization ---
        window.onload = async () => {
            initTheme();
            await fetchThaiWordDatabase();
            loadData();

            if (allLanguages.length === 0) {
                languageNameModal.classList.remove('hidden');
                mainContent.classList.add('disabled-section');
                existingLanguageLoaderSectionModal.classList.add('hidden');
            } else {
                mainContent.classList.remove('disabled-section');
                languageNameModal.classList.add('hidden'); // Default to hidden if languages exist
                
                modalExistingLanguageSelector.innerHTML = '<option value="">-- เลือกภาษา --</option>';
                allLanguages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang.name;
                    option.textContent = lang.name;
                    modalExistingLanguageSelector.appendChild(option);
                });
                existingLanguageLoaderSectionModal.classList.remove('hidden');


                if (!currentLanguage.name || !allLanguages.some(l => l.name === currentLanguage.name)) {
                    switchLanguage(allLanguages[0].name);
                } else {
                    currentLanguageNameDisplay.textContent = currentLanguage.name;
                    if(languageSelector) languageSelector.value = currentLanguage.name;
                    updateUI();
                }
            }

            submitLanguageNameButton.addEventListener('click', handleNewLanguageNameSubmission);
            importDataFromModalInput.addEventListener('change', importAllData);
            loadSelectedLangFromModalBtn.addEventListener('click', () => {
                const selectedLangName = modalExistingLanguageSelector.value;
                if (selectedLangName) {
                    languageNameModal.classList.add('hidden');
                    mainContent.classList.remove('disabled-section');
                    switchLanguage(selectedLangName);
                } else {
                    alert("กรุณาเลือกภาษาจากรายการ");
                }
            });


            addNewLangButton.addEventListener('click', promptForNewLanguage);
            if(languageSelector) languageSelector.addEventListener('change', handleLanguageSelectionChange);

            aboutButton.addEventListener('click', () => aboutModal.classList.remove('hidden'));
            closeAboutModalButton.addEventListener('click', () => aboutModal.classList.add('hidden'));
            themeToggleBtn.addEventListener('click', toggleTheme);


            languageInfoButton.addEventListener('click', showLanguageInfoModal);
            closeLanguageInfoModalButton.addEventListener('click', () => languageInfoModal.classList.add('hidden'));
            saveLanguageInfoButton.addEventListener('click', handleSaveLanguageInfo);

            openHamburgerMenuButton.addEventListener('click', () => {
                hamburgerMenu.classList.remove('closed');
                hamburgerMenu.classList.add('open');
            });
            closeHamburgerMenuButton.addEventListener('click', () => {
                hamburgerMenu.classList.remove('open');
                hamburgerMenu.classList.add('closed');
            });
            menuLinkPhonology.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab('phonology');
                hamburgerMenu.classList.remove('open');
                hamburgerMenu.classList.add('closed');
            });

            if (menuLinkIpa) menuLinkIpa.href = "https://ipa.typeit.org/";
            if (menuLinkThaiUsage) menuLinkThaiUsage.href = "https://kruarthurclassroom.blogspot.com/p/blog-page_12.html";


            closeWordDetailModalButton.addEventListener('click', () => wordDetailModal.classList.add('hidden'));
            closeWordDialectFormsModal.addEventListener('click', () => wordDialectFormsModal.classList.add('hidden'));
            closeWordEvolutionDisplayModal.addEventListener('click', () => wordEvolutionDisplayModal.classList.add('hidden'));
            addNewDialectFormFromPopupBtn.addEventListener('click', () => {
                const standardWordId = parseInt(wordDialectFormsModal.dataset.standardWordId);
                if (standardWordId) {
                    wordDialectFormsModal.classList.add('hidden');
                    showDialectWordFormModal(standardWordId, null, null);
                }
            });

            confirmSelectWordForEvolutionBtn.addEventListener('click', handleConfirmSelectWordForEvolution);
            cancelSelectWordForEvolutionBtn.addEventListener('click', () => selectWordForEvolutionModal.classList.add('hidden'));


            renderTabs();
            if (currentLanguage.name) {
                 switchTab(activeTab);
            }
        };

        async function fetchThaiWordDatabase() {
            try {
                const response = await fetch(`${API_URL}?action=findAllRegister`);
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    thaiWordDatabase = result.data.map(item => ({
                        word: item.คำศัพท์ || "N/A", 
                        pos: item.ประเภทของคำ || "N/A",
                        meaning: item.ความหมาย || "N/A",
                    }));
                    console.log("Thai word database loaded:", thaiWordDatabase.length, "entries");
                } else {
                    console.error("Failed to load Thai word database or data is not an array:", result.message, result.error);
                    thaiWordDatabase = [];
                }
            } catch (error) {
                console.error("Error fetching Thai word database:", error);
                thaiWordDatabase = [];
            }
        }


        function handleNewLanguageNameSubmission() {
            const name = languageNameInput.value.trim();
            if (name) {
                if (allLanguages.some(lang => lang.name === name)) {
                    alert("ชื่อภาษานี้มีอยู่แล้ว กรุณาเลือกชื่ออื่น");
                    return;
                }
                currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
                currentLanguage.name = name;
                languageNameModal.classList.add('hidden');
                mainContent.classList.remove('disabled-section');
                currentLanguageNameDisplay.textContent = currentLanguage.name;

                allLanguages.push(JSON.parse(JSON.stringify(currentLanguage)));
                saveData();
                updateUI(); 
                if (languageSelector) renderLanguageSelector();
                if (languageSelector) languageSelector.value = currentLanguage.name;

            } else {
                alert('กรุณาตั้งชื่อภาษาของคุณ');
            }
        }

        function promptForNewLanguage() {
            if (confirm('คุณต้องการสร้างภาษาใหม่หรือไม่? การเปลี่ยนแปลงในภาษาปัจจุบันจะถูกบันทึกอัตโนมัติ')) {
                saveData();

                currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));

                languageNameInput.value = '';
                languageNameModal.classList.remove('hidden');
                existingLanguageLoaderSectionModal.classList.toggle('hidden', allLanguages.length === 0);
                 if (allLanguages.length > 0) {
                    modalExistingLanguageSelector.innerHTML = '<option value="">-- เลือกภาษา --</option>';
                    allLanguages.forEach(lang => {
                        const option = document.createElement('option');
                        option.value = lang.name;
                        option.textContent = lang.name;
                        modalExistingLanguageSelector.appendChild(option);
                    });
                }


                mainContent.classList.add('disabled-section');
                currentLanguageNameDisplay.textContent = 'N/A';
                if(languageSelector) languageSelector.value = "";

                if (activeTab !== tabs[0].id) {
                    switchTab(tabs[0].id);
                } else {
                    tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาตั้งชื่อภาษาใหม่</p>`;
                }
            }
        }

        function handleLanguageSelectionChange(event) {
            const selectedLangName = event.target.value;
            if (selectedLangName && selectedLangName !== currentLanguage.name) {
                switchLanguage(selectedLangName);
            }
        }

        function switchLanguage(langName) {
            saveData(); 

            const targetLanguageData = allLanguages.find(lang => lang.name === langName);
            if (targetLanguageData) {
                currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), JSON.parse(JSON.stringify(targetLanguageData)));

                currentLanguageNameDisplay.textContent = currentLanguage.name;
                if (languageSelector.value !== currentLanguage.name) {
                     languageSelector.value = currentLanguage.name;
                }

                mainContent.classList.remove('disabled-section');
                updateUI(); 
                localStorage.setItem('currentLanguageData', JSON.stringify(currentLanguage)); 
                console.log(`Switched to language: ${currentLanguage.name}`);
            } else {
                console.error(`Language ${langName} not found in allLanguages.`);
                if (allLanguages.length > 0) {
                    switchLanguage(allLanguages[0].name); 
                } else {
                    currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
                    promptForNewLanguage();
                }
            }
        }

        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }

       function deepMerge(target, source) {
            let output = { ...target };

            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target) || !isObject(target[key])) {
                            output[key] = JSON.parse(JSON.stringify(source[key]));
                        } else {
                            output[key] = deepMerge(target[key], source[key]);
                        }
                    } else if (Array.isArray(source[key])) {
                        output[key] = JSON.parse(JSON.stringify(source[key]));
                    } else {
                        output[key] = source[key];
                    }
                });
            }

            Object.keys(DEFAULT_LANGUAGE_STATE).forEach(defaultKey => {
                if (!output.hasOwnProperty(defaultKey)) { 
                    if (isObject(DEFAULT_LANGUAGE_STATE[defaultKey]) || Array.isArray(DEFAULT_LANGUAGE_STATE[defaultKey])) {
                        output[defaultKey] = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE[defaultKey]));
                    } else {
                        output[defaultKey] = DEFAULT_LANGUAGE_STATE[defaultKey];
                    }
                } else if (isObject(DEFAULT_LANGUAGE_STATE[defaultKey]) && isObject(output[defaultKey])) {
                    output[defaultKey] = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE[defaultKey])), output[defaultKey]);
                }
                else if (Array.isArray(DEFAULT_LANGUAGE_STATE[defaultKey]) && !Array.isArray(output[defaultKey])) {
                     output[defaultKey] = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE[defaultKey]));
                }
            });
            return output;
        }


        function saveData() {
            if (!currentLanguage || !currentLanguage.name) {
                console.log("Autosave skipped: current language or name is invalid.");
                return;
            }

            currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), currentLanguage);


            const existingLangIndex = allLanguages.findIndex(lang => lang.name === currentLanguage.name);
            if (existingLangIndex > -1) {
                allLanguages[existingLangIndex] = JSON.parse(JSON.stringify(currentLanguage));
            } else {
                allLanguages.push(JSON.parse(JSON.stringify(currentLanguage)));
            }
            if (languageSelector) renderLanguageSelector(); 

            localStorage.setItem('currentLanguageData', JSON.stringify(currentLanguage));
            localStorage.setItem('allLanguagesData', JSON.stringify(allLanguages));
        }

        function loadData() {
            const savedAllLangs = localStorage.getItem('allLanguagesData');
            if (savedAllLangs) {
                try {
                    const parsedAllLangs = JSON.parse(savedAllLangs);
                    allLanguages = parsedAllLangs.map(lang => deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), lang));
                } catch (e) {
                    console.error("Error parsing allLanguagesData from localStorage", e);
                    allLanguages = [];
                }
            } else {
                allLanguages = [];
            }

            const savedLang = localStorage.getItem('currentLanguageData');
            if (savedLang) {
                 try {
                    const parsedLang = JSON.parse(savedLang);
                    if (allLanguages.some(l => l.name === parsedLang.name)) {
                        currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), parsedLang);
                    } else if (allLanguages.length > 0) { 
                        currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), JSON.parse(JSON.stringify(allLanguages[0])));
                    } else { 
                         currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), parsedLang);
                         if (currentLanguage.name && !allLanguages.some(l => l.name === currentLanguage.name)) {
                             allLanguages.push(JSON.parse(JSON.stringify(currentLanguage)));
                         } else if (!currentLanguage.name) {
                            currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
                         }
                    }
                 } catch (e) {
                    console.error("Error parsing currentLanguageData from localStorage", e);
                    if (allLanguages.length > 0) {
                        currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), JSON.parse(JSON.stringify(allLanguages[0])));
                    } else {
                        currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
                    }
                 }
            } else if (allLanguages.length > 0) { 
                currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), JSON.parse(JSON.stringify(allLanguages[0])));
            } else { 
                currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
            }

            console.log("Data loaded. Current Lang:", currentLanguage.name, "All Langs Count:", allLanguages.length);
            if(languageSelector) renderLanguageSelector();
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggleBtn.textContent = '🌙';
            } else {
                document.body.classList.remove('dark-theme');
                themeToggleBtn.textContent = '☀️';
            }
            const arrowFillColor = document.body.classList.contains('dark-theme') ? 'FFFFFF' : 'FFFFFF'; // White for both for now, as header is dark
            if (languageSelector) {
                 languageSelector.style.backgroundImage = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${arrowFillColor}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E')`;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            let newTheme = 'light';
            if (document.body.classList.contains('dark-theme')) {
                themeToggleBtn.textContent = '🌙';
                newTheme = 'dark';
            } else {
                themeToggleBtn.textContent = '☀️';
            }
            localStorage.setItem('theme', newTheme);
            initTheme(); 
        }


        function calculateNextWordId(lexicon = []) {
            if (!lexicon || lexicon.length === 0) return 1;
            return lexicon.reduce((max, word) => Math.max(max, word.id || 0), 0) + 1;
        }

        function renderLanguageSelector() {
            if (!languageSelector) return;
            const currentSelectedValue = languageSelector.value;
            languageSelector.innerHTML = ''; 
            
            const placeholderOption = document.createElement('option');
            placeholderOption.value = "";
            placeholderOption.textContent = "-- เลือกภาษา --";
            languageSelector.appendChild(placeholderOption);

            allLanguages.forEach(lang => {
                if (lang.name) {
                    const option = document.createElement('option');
                    option.value = lang.name;
                    option.textContent = lang.name;
                    languageSelector.appendChild(option);
                }
            });
            if (currentLanguage.name && allLanguages.some(l => l.name === currentLanguage.name)) {
                languageSelector.value = currentLanguage.name;
            } else if (currentSelectedValue && allLanguages.some(l => l.name === currentSelectedValue)) {
                 languageSelector.value = currentSelectedValue;
            } else if (allLanguages.length > 0 && allLanguages[0].name) { 
                languageSelector.value = allLanguages[0].name;
            } else {
                languageSelector.value = ""; 
            }
        }


        function updateUI() {
            if (currentLanguage && currentLanguage.name) {
                 currentLanguageNameDisplay.textContent = currentLanguage.name;
                 if (languageSelector && languageSelector.value !== currentLanguage.name) {
                    languageSelector.value = currentLanguage.name;
                 }
                 mainContent.classList.remove('disabled-section');
                 languageInfoButton.classList.remove('sm:hidden'); 
            } else { 
                currentLanguageNameDisplay.textContent = 'N/A';
                languageInfoButton.classList.add('sm:hidden'); 

                if (allLanguages.length === 0 && languageNameModal.classList.contains('hidden')) {
                    languageNameModal.classList.remove('hidden');
                    existingLanguageLoaderSectionModal.classList.add('hidden');
                    mainContent.classList.add('disabled-section');
                    tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาสร้างภาษาใหม่เพื่อเริ่มใช้งาน</p>`;
                    renderTabs(); 
                    return;
                } else if (allLanguages.length > 0 && !languageNameModal.classList.contains('hidden')) {
                     mainContent.classList.add('disabled-section');
                     existingLanguageLoaderSectionModal.classList.remove('hidden');
                        modalExistingLanguageSelector.innerHTML = '<option value="">-- เลือกภาษา --</option>';
                        allLanguages.forEach(lang => {
                            const option = document.createElement('option');
                            option.value = lang.name;
                            option.textContent = lang.name;
                            modalExistingLanguageSelector.appendChild(option);
                        });

                } else if (allLanguages.length > 0 && currentLanguage && !currentLanguage.name) {
                    mainContent.classList.add('disabled-section');
                    tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาเลือกภาษาจากรายการ</p>`;
                } else {
                     mainContent.classList.remove('disabled-section');
                }
            }

            const currentTabConfig = tabs.find(t => t.id === activeTab);
            if (currentTabConfig && currentLanguage.name) { 
                 tabContentContainer.innerHTML = ''; 
                 const titleEl = document.createElement('h3');
                 titleEl.className = "text-xl font-semibold mb-4"; 
                 titleEl.style.color = "var(--section-title-color)";
                 titleEl.textContent = currentTabConfig.name;
                 tabContentContainer.appendChild(titleEl);
                 currentTabConfig.contentFunc(tabContentContainer); 
            } else if (!currentLanguage.name && allLanguages.length > 0) {
                tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาเลือกภาษาจากรายการ หรือสร้างภาษาใหม่ให้เสร็จสิ้น</p>`;
            } else if (!currentLanguage.name && allLanguages.length === 0 && languageNameModal.classList.contains('hidden')) {
                 languageNameModal.classList.remove('hidden');
                 existingLanguageLoaderSectionModal.classList.add('hidden');
                 mainContent.classList.add('disabled-section');
                 tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาสร้างภาษาใหม่เพื่อเริ่มใช้งาน</p>`;
            }
             renderTabs(); 
        }


        function renderTabs() {
            tabContainer.innerHTML = '';
            tabs.forEach(tab => {
                const button = document.createElement('button');
                button.className = `tab-button py-2 px-4 font-medium text-sm rounded-t-lg border-b-2 whitespace-nowrap ${activeTab === tab.id ? 'active' : ''}`;
                button.innerHTML = `<i class="${tab.icon} mr-2"></i>${tab.name}`;
                button.addEventListener('click', () => switchTab(tab.id));
                tabContainer.appendChild(button);
            });
        }

        function switchTab(tabId) {
            activeTab = tabId;
            if (!currentLanguage.name) {
                if (allLanguages.length === 0 && !languageNameModal.classList.contains('hidden')) {
                } else if (allLanguages.length === 0) {
                    tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาสร้างภาษาใหม่เพื่อเริ่มใช้งาน</p>`;
                }
                else { 
                     tabContentContainer.innerHTML = `<p class="text-center text-gray-500">กรุณาเลือกภาษาหรือสร้างภาษาใหม่ให้เสร็จสิ้น</p>`;
                }
                renderTabs(); 
                return;
            }

            const currentTabConfig = tabs.find(t => t.id === tabId);
            if (currentTabConfig) {
                tabContentContainer.innerHTML = ''; 
                const titleEl = document.createElement('h3');
                titleEl.className = "text-xl font-semibold mb-4";
                titleEl.style.color = "var(--section-title-color)";
                titleEl.textContent = currentTabConfig.name;
                tabContentContainer.appendChild(titleEl);
                currentTabConfig.contentFunc(tabContentContainer); 
            }
            renderTabs(); 
        }

        function showLanguageInfoModal() {
            if (!currentLanguage || !currentLanguage.name) {
                alert("กรุณาสร้างหรือเลือกภาษาก่อน");
                return;
            }
            currentLanguage.info = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.info)), currentLanguage.info || {});

            document.getElementById('infoLangName').value = currentLanguage.name;
            document.getElementById('infoLangDescription').value = currentLanguage.info.description || '';
            document.getElementById('infoLangHistory').value = currentLanguage.info.history || '';
            document.getElementById('infoLangFeatures').value = currentLanguage.info.linguisticFeatures || ''; 
            document.getElementById('infoLangSoundSystem').value = currentLanguage.info.soundSystemNotes || ''; 
            document.getElementById('infoLangWritingSystem').value = currentLanguage.info.writingSystemNotes || ''; 
            document.getElementById('infoLangNumSpeakers').value = currentLanguage.info.numSpeakers || 0;
            document.getElementById('infoLangCountries').value = currentLanguage.info.countries || '';
            document.getElementById('infoLangStatus').value = currentLanguage.info.status || 'ถูกประดิษฐ์';
            languageInfoModal.classList.remove('hidden');
        }

        function handleSaveLanguageInfo() {
            if (!currentLanguage.info) currentLanguage.info = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.info));

            currentLanguage.info.description = document.getElementById('infoLangDescription').value;
            currentLanguage.info.history = document.getElementById('infoLangHistory').value;
            currentLanguage.info.linguisticFeatures = document.getElementById('infoLangFeatures').value; 
            currentLanguage.info.soundSystemNotes = document.getElementById('infoLangSoundSystem').value; 
            currentLanguage.info.writingSystemNotes = document.getElementById('infoLangWritingSystem').value; 
            currentLanguage.info.numSpeakers = parseInt(document.getElementById('infoLangNumSpeakers').value) || 0;
            currentLanguage.info.countries = document.getElementById('infoLangCountries').value;
            currentLanguage.info.status = document.getElementById('infoLangStatus').value;

            saveData();
            languageInfoModal.classList.add('hidden');
            alert("บันทึกข้อมูลทั่วไปของภาษาแล้ว");
        }


        function createListInput(container, label, itemsArray, placeholder, addItemCallback, removeItemCallback, options = {}) {
            const section = document.createElement('div');
            section.className = 'mb-4 p-3 border rounded-md list-input-section'; 
            const labelEl = document.createElement('label');
            labelEl.className = 'block text-sm font-medium mb-1'; 
            labelEl.textContent = label;
            if (options.tooltip) {
                labelEl.title = options.tooltip;
                labelEl.innerHTML += ` <i class="fas fa-info-circle text-xs text-purple-400"></i>`;
            }
            section.appendChild(labelEl);

            const listContainer = document.createElement('div');
            listContainer.className = 'flex flex-wrap gap-2 mb-2';
            if (itemsArray && Array.isArray(itemsArray)) {
                itemsArray.forEach((item, index) => {
                    const chip = document.createElement('span');
                    chip.className = 'bg-purple-500 text-white px-2 py-1 rounded-full text-xs flex items-center'; 
                    chip.textContent = item;
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'ml-2 text-purple-200 hover:text-white'; 
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => { removeItemCallback(index); };
                    chip.appendChild(removeBtn);
                    listContainer.appendChild(chip);
                });
            }
            section.appendChild(listContainer);

            const inputGroup = document.createElement('div');
            inputGroup.className = 'flex gap-2';
            const inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.className = 'w-full p-2 border rounded-md'; 
            inputEl.placeholder = placeholder;
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-secondary px-3 py-1 rounded-md text-sm';
            addBtn.textContent = 'เพิ่ม';
            addBtn.onclick = () => {
                if (inputEl.value.trim()) {
                    addItemCallback(inputEl.value.trim());
                    inputEl.value = '';
                }
            };
            inputGroup.appendChild(inputEl);
            inputGroup.appendChild(addBtn);
            section.appendChild(inputGroup);

            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            const existingListInputs = Array.from(container.querySelectorAll('.list-input-section'));
            let insertAfterElement = titleElement;

            if (existingListInputs.length > 0) {
                if (options.subSectionTargetId && container.querySelector(`#${options.subSectionTargetId}`)) {
                    const subSectionContainer = container.querySelector(`#${options.subSectionTargetId}`);
                    const lastListInputInSubSection = Array.from(subSectionContainer.querySelectorAll('.list-input-section')).pop();
                    if (lastListInputInSubSection) {
                        lastListInputInSubSection.insertAdjacentElement('afterend', section);
                    } else {
                        const baseRegionsPara = subSectionContainer.querySelector('p.text-xs.text-gray-600');
                        if (baseRegionsPara) {
                             baseRegionsPara.insertAdjacentElement('afterend', section);
                        } else {
                            subSectionContainer.appendChild(section);
                        }
                    }
                    return section; 
                } else {
                     insertAfterElement = existingListInputs[existingListInputs.length - 1];
                }
            }

            if (insertAfterElement) {
                insertAfterElement.insertAdjacentElement('afterend', section);
            } else {
                container.appendChild(section); 
            }
            return section;
        }


        function renderPhonologyUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'phonology').sectionClass);
            const existingSections = container.querySelectorAll('.list-input-section, .phonotactics-section-class');
            existingSections.forEach(sec => sec.remove());


            const { consonants, vowels, tones, syllableStructures, phonotactics } = currentLanguage.phonology;

            createListInput(container, '🗣️ พยัญชนะ (Consonants)', consonants, "เช่น p, t, k",
                (item) => { currentLanguage.phonology.consonants.push(item); renderPhonologyUI(tabContentContainer); saveData(); },
                (index) => { currentLanguage.phonology.consonants.splice(index, 1); renderPhonologyUI(tabContentContainer); saveData(); }
            );
            createListInput(container, '🎤 สระ (Vowels)', vowels, "เช่น a, i, u",
                (item) => { currentLanguage.phonology.vowels.push(item); renderPhonologyUI(tabContentContainer); saveData(); },
                (index) => { currentLanguage.phonology.vowels.splice(index, 1); renderPhonologyUI(tabContentContainer); saveData(); }
            );
            createListInput(container, '🎼 วรรณยุกต์ (Tones - ถ้ามี)', tones, "เช่น high, low, rising",
                (item) => { currentLanguage.phonology.tones.push(item); renderPhonologyUI(tabContentContainer); saveData(); },
                (index) => { currentLanguage.phonology.tones.splice(index, 1); renderPhonologyUI(tabContentContainer); saveData(); }
            );
            createListInput(container, '🧱 โครงสร้างพยางค์ (Syllable Structures)', syllableStructures, "เช่น CV, CVC, VCV",
                (item) => { currentLanguage.phonology.syllableStructures.push(item.toUpperCase()); renderPhonologyUI(tabContentContainer); saveData(); },
                (index) => { currentLanguage.phonology.syllableStructures.splice(index, 1); renderPhonologyUI(tabContentContainer); saveData(); }
            );

            const phonotacticsSection = document.createElement('div');
            phonotacticsSection.className = 'mb-4 p-3 border rounded-md phonotactics-section-class list-input-section'; 
            phonotacticsSection.innerHTML = `<label class="block text-sm font-medium mb-1">📜 กฎการออกเสียง (Phonotactics)</label>`;
            const rulesList = document.createElement('div');
            (currentLanguage.phonology.phonotactics || []).forEach((rule, index) => {
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'flex items-center justify-between p-2 mb-1 bg-white rounded border'; 
                ruleDiv.style.borderColor = 'var(--border-color-light)';
                ruleDiv.innerHTML = `
                    <span class="text-sm ${rule.enabled ? 'text-green-600' : 'text-red-600'}">${rule.rule} ${rule.custom && rule.pattern ? `(${rule.pattern})` : ''}</span>
                    <div>
                        <button class="text-xs ${rule.enabled ? 'bg-yellow-400 hover:bg-yellow-500' : 'bg-green-400 hover:bg-green-500'} text-white px-2 py-1 rounded" onclick="togglePhonotacticRule(${index})">${rule.enabled ? 'ปิดใช้งาน' : 'เปิดใช้งาน'}</button>
                        ${rule.custom ? `<button class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded ml-1" onclick="removeCustomPhonotacticRule(${index})">ลบ</button>` : ''}
                    </div>
                `;
                rulesList.appendChild(ruleDiv);
            });
            phonotacticsSection.appendChild(rulesList);

            const addRuleGroup = document.createElement('div');
            addRuleGroup.className = 'mt-3 flex gap-2 items-center flex-wrap';
            const ruleDescInput = document.createElement('input');
            ruleDescInput.type = 'text';
            ruleDescInput.placeholder = "คำอธิบายกฎ (เช่น ห้าม m สะกด)";
            ruleDescInput.className = 'flex-grow p-2 border rounded-md min-w-[200px]';
            const rulePatternInput = document.createElement('input');
            rulePatternInput.type = 'text';
            rulePatternInput.placeholder = "รูปแบบ (เช่น *m#)";
            rulePatternInput.className = 'flex-grow p-2 border rounded-md min-w-[150px]';
            const addRuleBtn = document.createElement('button');
            addRuleBtn.className = 'btn-secondary px-3 py-2 rounded-md text-sm';
            addRuleBtn.textContent = 'เพิ่มกฎเอง';
            addRuleBtn.onclick = () => {
                const desc = ruleDescInput.value.trim();
                const pattern = rulePatternInput.value.trim();
                if (desc) {
                    if(!currentLanguage.phonology.phonotactics) currentLanguage.phonology.phonotactics = [];
                    currentLanguage.phonology.phonotactics.push({ rule: desc, type: "custom", enabled: true, custom: true, pattern: pattern });
                    ruleDescInput.value = '';
                    rulePatternInput.value = '';
                    renderPhonologyUI(tabContentContainer);
                    saveData();
                }
            };
            addRuleGroup.appendChild(ruleDescInput);
            addRuleGroup.appendChild(rulePatternInput);
            addRuleGroup.appendChild(addRuleBtn);
            phonotacticsSection.appendChild(addRuleGroup);

            const titleElementPhono = container.querySelector('h3.text-xl.font-semibold');
            let lastListInput = Array.from(container.querySelectorAll('.list-input-section:not(.phonotactics-section-class)')).pop();

            if (lastListInput) {
                lastListInput.insertAdjacentElement('afterend', phonotacticsSection);
            } else if (titleElementPhono) {
                titleElementPhono.insertAdjacentElement('afterend', phonotacticsSection);
            } else {
                container.appendChild(phonotacticsSection);
            }
        }

        window.togglePhonotacticRule = (index) => {
            currentLanguage.phonology.phonotactics[index].enabled = !currentLanguage.phonology.phonotactics[index].enabled;
            renderPhonologyUI(tabContentContainer); saveData();
        };
        window.removeCustomPhonotacticRule = (index) => {
            if (currentLanguage.phonology.phonotactics[index].custom) {
                currentLanguage.phonology.phonotactics.splice(index, 1);
                renderPhonologyUI(tabContentContainer); saveData();
            }
        };

        function renderWordGeneratorUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'wordGen').sectionClass);
            const existingSection = container.querySelector('.word-gen-section-class');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'space-y-4 p-3 border rounded-md word-gen-section-class'; 
            let refLangHtml = '';
            if (currentLanguage.info && currentLanguage.info.referenceLanguages && currentLanguage.info.referenceLanguages.length > 0) {
                refLangHtml = `<p class="text-xs text-green-600">อ้างอิงจาก: ${currentLanguage.info.referenceLanguages.join(', ')} (การนำเสียง/รูปคำมาปรับใช้จะพัฒนาในอนาคต)</p>`;
            } else {
                refLangHtml = `<p class="text-xs text-gray-500">ไม่ได้ตั้งค่าภาษาอ้างอิง (ไปที่ เครื่องมือ > จัดการภาษาอ้างอิง)</p>`;
            }

            section.innerHTML = `
                ${refLangHtml}
                <div>
                    <label class="block text-sm font-medium text-green-700">จำนวนพยางค์ต่อคำ:</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="minSyllables" value="1" min="1" max="5" class="w-20 p-2 border rounded-md">
                        <span>ถึง</span>
                        <input type="number" id="maxSyllables" value="3" min="1" max="5" class="w-20 p-2 border rounded-md">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-green-700">จำนวนคำที่ต้องการสร้าง:</label>
                    <input type="number" id="numWordsToGenerate" value="5" min="1" max="20" class="w-20 p-2 border rounded-md">
                </div>
                <button id="generateWordsButton" class="btn-primary bg-green-500 hover:bg-green-600 py-2 px-4 rounded-md">สร้างคำ 🎲</button>
                <div id="generatedWordsArea" class="mt-4 p-3 bg-white rounded-md shadow">
                    <h4 class="font-semibold text-green-700">คำที่สร้างได้:</h4>
                    <ul id="generatedWordsList" class="list-disc list-inside text-sm"></ul>
                </div>
            `;
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            document.getElementById('generateWordsButton').addEventListener('click', generateAndDisplayWords);
        }

        function phonemicToOrthographic(phonemicString) {
            if (!phonemicString) return '';
            if (!currentLanguage.orthography || currentLanguage.orthography.writingSystem !== 'custom' || !currentLanguage.orthography.customSymbols || currentLanguage.orthography.customSymbols.length === 0) {
                return phonemicString;
            }

            let orthographic = '';
            let remainingPhonemic = phonemicString;
            const sortedSymbols = [...currentLanguage.orthography.customSymbols].sort((a, b) => b.sound.length - a.sound.length);

            while (remainingPhonemic.length > 0) {
                let foundMatch = false;
                for (const sym of sortedSymbols) {
                    if (remainingPhonemic.startsWith(sym.sound)) {
                        orthographic += sym.symbol;
                        remainingPhonemic = remainingPhonemic.substring(sym.sound.length);
                        foundMatch = true;
                        break;
                    }
                }
                if (!foundMatch) {
                    orthographic += remainingPhonemic[0];
                    remainingPhonemic = remainingPhonemic.substring(1);
                }
            }
            return orthographic;
        }

        function orthographicToImpliedPhonemic(orthographicString) {
            if (!orthographicString) return '';
            if (!currentLanguage.orthography || currentLanguage.orthography.writingSystem === 'latin' || !currentLanguage.orthography.customSymbols || currentLanguage.orthography.customSymbols.length === 0) {
                return orthographicString; 
            }
            if (currentLanguage.orthography.writingSystem === 'custom') {
                let phonemic = '';
                let remainingOrthographic = orthographicString;
                const sortedSymbols = [...currentLanguage.orthography.customSymbols].sort((a,b) => b.symbol.length - a.symbol.length);

                while (remainingOrthographic.length > 0) {
                    let foundMatch = false;
                    for (const sym of sortedSymbols) {
                        if (remainingOrthographic.startsWith(sym.symbol)) {
                            phonemic += sym.sound; 
                            remainingOrthographic = remainingOrthographic.substring(sym.symbol.length);
                            foundMatch = true;
                            break;
                        }
                    }
                    if (!foundMatch) {
                        phonemic += remainingOrthographic[0];
                        remainingOrthographic = remainingOrthographic.substring(1);
                    }
                }
                return phonemic;
            }
            return orthographicString;
        }


        function generateAndDisplayWords() {
            const minSyllables = parseInt(document.getElementById('minSyllables').value);
            const maxSyllables = parseInt(document.getElementById('maxSyllables').value);
            const numWords = parseInt(document.getElementById('numWordsToGenerate').value);
            const listElement = document.getElementById('generatedWordsList');
            listElement.innerHTML = '';

            if (minSyllables > maxSyllables) {
                alert("จำนวนพยางค์ต่ำสุดต้องไม่มากกว่าจำนวนพยางค์สูงสุด");
                return;
            }
            if (!currentLanguage.phonology.consonants || currentLanguage.phonology.consonants.length === 0 ||
                !currentLanguage.phonology.vowels || currentLanguage.phonology.vowels.length === 0) {
                alert("กรุณากำหนดพยัญชนะและสระในระบบเสียงก่อน");
                return;
            }


            for (let i = 0; i < numWords; i++) {
                const numSyllToGenerate = Math.floor(Math.random() * (maxSyllables - minSyllables + 1)) + minSyllables;
                let generatedPhonemicWord = '';
                let wordSyllables = [];

                for (let j = 0; j < numSyllToGenerate; j++) {
                    const syllable = generateSyllable();
                    generatedPhonemicWord += syllable;
                    wordSyllables.push(syllable);
                }

                const orthographicWordToDisplay = phonemicToOrthographic(generatedPhonemicWord);
                const autoIPA = `/${wordSyllables.join('.')}/`; 


                let randomThaiMeaning = "N/A (ไม่มีข้อมูล)";
                let randomThaiPOS = getPartsOfSpeech()[0] || DEFAULT_BASE_PARTS_OF_SPEECH[0];

                if (thaiWordDatabase.length > 0) {
                    const thaiEntry = thaiWordDatabase[Math.floor(Math.random() * thaiWordDatabase.length)];
                    
                    randomThaiMeaning = thaiEntry.word || "N/A (ไม่มีคำศัพท์จากฐานข้อมูล)"; 
                    
                    let posFromDb = thaiEntry.pos;
                    const conlangPOSList = getPartsOfSpeech();
                    if (conlangPOSList.includes(posFromDb)) {
                        randomThaiPOS = posFromDb;
                    } else if (conlangPOSList.length > 0) {
                        // If POS from DB is not in conlang's list, pick a random valid conlang POS
                        randomThaiPOS = conlangPOSList[Math.floor(Math.random() * conlangPOSList.length)];
                    }
                    // Otherwise, randomThaiPOS retains its initially set default value.

                    // Truncate if necessary for display in the generated list
                    randomThaiMeaning = randomThaiMeaning.substring(0, 50) + (randomThaiMeaning.length > 50 ? "..." : "");

                } else {
                     randomThaiMeaning = "N/A (ฐานข้อมูลคำไทยว่างเปล่า)";
                     // randomThaiPOS retains its initial default value.
                }


                const listItem = document.createElement('li');
                listItem.className = 'p-2 my-1 bg-gray-50 hover:bg-green-50 rounded flex justify-between items-center flex-wrap'; 

                const wordDisplaySpan = document.createElement('span');
                wordDisplaySpan.className = 'font-semibold mr-2';
                wordDisplaySpan.textContent = orthographicWordToDisplay;
                wordDisplaySpan.title = `รูปหน่วยเสียง: ${generatedPhonemicWord}`;
                if (orthographicWordToDisplay !== generatedPhonemicWord) {
                     wordDisplaySpan.innerHTML += ` <span class="text-xs text-gray-500">(${generatedPhonemicWord})</span>`;
                }
                wordDisplaySpan.innerHTML += ` <small class="text-blue-500 ml-1">(${randomThaiMeaning} - ${randomThaiPOS})</small>`;
                listItem.appendChild(wordDisplaySpan);

                const addButton = document.createElement('button');
                addButton.innerHTML = '➕ <span class="hidden sm:inline">เพิ่มในพจนานุกรม</span>';
                addButton.className = 'ml-auto text-xs btn-secondary bg-green-400 hover:bg-green-500 px-2 py-1 rounded whitespace-nowrap';
                // When adding to dictionary, use the full (non-truncated) thaiEntry.word if available
                const fullMeaningForModal = (thaiWordDatabase.length > 0 && thaiWordDatabase.find(entry => entry.word === randomThaiMeaning.replace("...", ""))) 
                                         ? (thaiWordDatabase.find(entry => entry.word === randomThaiMeaning.replace("...", ""))).word
                                         : randomThaiMeaning;
                addButton.onclick = () => showWordModal(null, orthographicWordToDisplay, autoIPA, fullMeaningForModal, randomThaiPOS, generatedPhonemicWord);
                listItem.appendChild(addButton);
                listElement.appendChild(listItem);
            }
        }


        function generateSyllable() {
            const { consonants, vowels, syllableStructures, phonotactics } = currentLanguage.phonology;
            if (!syllableStructures || syllableStructures.length === 0) {
                if (consonants && consonants.length > 0 && vowels && vowels.length > 0) return consonants[Math.floor(Math.random() * consonants.length)] + vowels[Math.floor(Math.random() * vowels.length)];
                if (vowels && vowels.length > 0) return vowels[Math.floor(Math.random() * vowels.length)];
                if (consonants && consonants.length > 0) return consonants[Math.floor(Math.random() * consonants.length)];
                return '???'; 
            }


            let attempts = 0;
            while(attempts < 50) { 
                const structure = syllableStructures[Math.floor(Math.random() * syllableStructures.length)];
                let syllable = '';
                let validSyllableConstruction = true;

                for (const char of structure) {
                    if (char === 'C') {
                        if (consonants && consonants.length > 0) {
                            syllable += consonants[Math.floor(Math.random() * consonants.length)];
                        } else { validSyllableConstruction = false; break; } 
                    } else if (char === 'V') {
                        if (vowels && vowels.length > 0) {
                            syllable += vowels[Math.floor(Math.random() * vowels.length)];
                        } else { validSyllableConstruction = false; break; } 
                    } else {
                        syllable += char; 
                    }
                }

                if (!validSyllableConstruction) { attempts++; continue; } 


                let passesPhonotactics = true;
                const activeRules = (phonotactics || []).filter(r => r.enabled);
                for (const rule of activeRules) {
                    if (rule.type === "no_consonant_cluster" && hasConsonantCluster(syllable, consonants)) {
                        passesPhonotactics = false; break;
                    }
                    if (rule.type === "no_initial_vowel" && vowels && vowels.includes(syllable[0])) {
                        if (structure.startsWith('V')) { 
                            passesPhonotactics = false; break;
                        }
                    }
                    if (rule.custom && rule.pattern) {
                        if (rule.pattern.startsWith('*') && rule.pattern.endsWith('#') && rule.pattern.length > 2) { 
                            const charToNotEndWith = rule.pattern.substring(1, rule.pattern.length - 1);
                            if (syllable.endsWith(charToNotEndWith)) { passesPhonotactics = false; break; }
                        }
                         else if (rule.pattern.endsWith('*') && !rule.pattern.startsWith('*') && rule.pattern.length > 1) { 
                           const charToNotStartWith = rule.pattern.substring(0, rule.pattern.length - 1);
                           if (syllable.startsWith(charToNotStartWith)) { passesPhonotactics = false; break; }
                        }
                        else if (rule.pattern.startsWith('*') && rule.pattern.endsWith('*') && rule.pattern.length > 2) { 
                            const charNotToContain = rule.pattern.substring(1, rule.pattern.length - 1);
                            if (syllable.includes(charNotToContain)) { passesPhonotactics = false; break; }
                        }
                        else if (!rule.pattern.includes('*') && !rule.pattern.includes('#') && rule.pattern.length > 0) {
                            if (syllable === rule.pattern) { passesPhonotactics = false; break; }
                        }
                    }
                }

                if (passesPhonotactics) return syllable;
                attempts++;
            }
            if (consonants && consonants.length > 0 && vowels && vowels.length > 0) return consonants[0] + vowels[0];
            if (vowels && vowels.length > 0) return vowels[0];
            if (consonants && consonants.length > 0) return consonants[0];
            return "???"; 
        }

        function hasConsonantCluster(text, consonantsList) {
            if (!consonantsList || consonantsList.length === 0 || !text) return false;
            let consonantCount = 0;
            for (const char of text) {
                if (consonantsList.includes(char)) {
                    consonantCount++;
                    if (consonantCount > 1) return true; 
                } else {
                    consonantCount = 0; 
                }
            }
            return false;
        }

        function getPartsOfSpeech() {
            return [...(currentLanguage.grammar.partsOfSpeech || DEFAULT_BASE_PARTS_OF_SPEECH), ...(currentLanguage.grammar.customPartsOfSpeech || [])];
        }

        function getNounGenders() {
            if (!currentLanguage.grammar.nounGenders || !currentLanguage.grammar.nounGenders.enabled) return [];
            return [...(currentLanguage.grammar.nounGenders.genders || DEFAULT_BASE_NOUN_GENDERS), ...(currentLanguage.grammar.nounGenders.customGenders || [])];
        }


        function renderGrammarUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'grammar').sectionClass);
            const existingSection = container.querySelector('.grammar-section-class');
            if(existingSection) existingSection.remove(); 

            const grammar = currentLanguage.grammar;
            const section = document.createElement('div');
            section.className = 'space-y-6 p-3 border rounded-md grammar-section-class'; 

            const sentenceStructureHTML = `
                <div>
                    <label for="sentenceStructureSelect" class="block text-sm font-medium mb-1">รูปแบบประโยค (Syntax Structure):</label>
                    <select id="sentenceStructureSelect" class="w-full p-2 border rounded-md">
                        <option value="SVO" ${grammar.sentenceStructure === 'SVO' ? 'selected' : ''}>SVO (ประธาน-กริยา-กรรม)</option>
                        <option value="SOV" ${grammar.sentenceStructure === 'SOV' ? 'selected' : ''}>SOV (ประธาน-กรรม-กริยา)</option>
                        <option value="VSO" ${grammar.sentenceStructure === 'VSO' ? 'selected' : ''}>VSO (กริยา-ประธาน-กรรม)</option>
                        <option value="VOS" ${grammar.sentenceStructure === 'VOS' ? 'selected' : ''}>VOS (กริยา-กรรม-ประธาน)</option>
                        <option value="OSV" ${grammar.sentenceStructure === 'OSV' ? 'selected' : ''}>OSV (กรรม-ประธาน-กริยา)</option>
                        <option value="OVS" ${grammar.sentenceStructure === 'OVS' ? 'selected' : ''}>OVS (กรรม-กริยา-ประธาน)</option>
                        <option value="FREE" ${grammar.sentenceStructure === 'FREE' ? 'selected' : ''}>Free Word Order (with case marking or adpositions)</option>
                    </select>
                </div>
            `;
            section.innerHTML += sentenceStructureHTML;

            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const posSectionContainer = document.createElement('div'); 
            section.appendChild(posSectionContainer); 
            const customPosList = createListInput(posSectionContainer, 'ชนิดของคำ (Parts of Speech - เพิ่มเติม)', grammar.customPartsOfSpeech || [], "เช่น 'คำเชื่อมอนุภาค'",
                (item) => {
                    if (!grammar.customPartsOfSpeech) grammar.customPartsOfSpeech = [];
                    if (![...(grammar.partsOfSpeech || []), ...grammar.customPartsOfSpeech].includes(item)) {
                        grammar.customPartsOfSpeech.push(item);
                    }
                    renderGrammarUI(tabContentContainer); saveData();
                },
                (index) => { grammar.customPartsOfSpeech.splice(index, 1); renderGrammarUI(tabContentContainer); saveData(); }
            );
            const basePOSDisplay = document.createElement('p');
            basePOSDisplay.className = 'text-xs text-gray-600 mt-1 ml-3';
            basePOSDisplay.textContent = `ชนิดของคำพื้นฐาน: ${(grammar.partsOfSpeech || DEFAULT_BASE_PARTS_OF_SPEECH).join(', ')} (ไม่สามารถลบได้)`;
            const inputGroupInPos = customPosList.querySelector('.flex.gap-2');
            if (inputGroupInPos) {
                 inputGroupInPos.insertAdjacentElement('afterend', basePOSDisplay);
            } else { 
                customPosList.appendChild(basePOSDisplay);
            }


            const nounGenderSection = document.createElement('div');
            nounGenderSection.className = 'mb-4 p-3 border rounded-md'; 
            nounGenderSection.style.backgroundColor = 'var(--list-input-section-bg)'; 
            nounGenderSection.style.borderColor = 'var(--list-input-section-border)';
            nounGenderSection.innerHTML = `<label class="block text-sm font-medium mb-2" style="color: var(--list-input-label-color);">ระบบเพศของคำนาม (Noun Genders)</label>`;
            const enableGenderDiv = document.createElement('div');
            enableGenderDiv.className = 'flex items-center mb-2';
            enableGenderDiv.innerHTML = `
                <input type="checkbox" id="enableNounGenders" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${grammar.nounGenders && grammar.nounGenders.enabled ? 'checked' : ''}>
                <label for="enableNounGenders" class="text-sm">เปิดใช้งานระบบเพศของคำนาม</label>
            `;
            nounGenderSection.appendChild(enableGenderDiv);

            const genderManagementDiv = document.createElement('div');
            genderManagementDiv.id = 'genderManagementDiv';
            genderManagementDiv.className = (grammar.nounGenders && grammar.nounGenders.enabled) ? '' : 'hidden';

            const customGenderListContainer = document.createElement('div'); 
            genderManagementDiv.appendChild(customGenderListContainer);
            const customGenderListInput = createListInput(customGenderListContainer, 'เพศของคำนาม (เพิ่มเติม)', grammar.nounGenders ? (grammar.nounGenders.customGenders || []) : [], "เช่น 'เพศคู่'",
                (item) => {
                    if (!grammar.nounGenders.customGenders) grammar.nounGenders.customGenders = [];
                     if (![...(grammar.nounGenders.genders || []), ...grammar.nounGenders.customGenders].includes(item)) {
                        grammar.nounGenders.customGenders.push(item);
                     }
                    renderGrammarUI(tabContentContainer); saveData();
                },
                (index) => { grammar.nounGenders.customGenders.splice(index, 1); renderGrammarUI(tabContentContainer); saveData(); }
            );
            const baseGenderDisplay = document.createElement('p');
            baseGenderDisplay.className = 'text-xs text-gray-600 mt-1 ml-3'; 
            baseGenderDisplay.textContent = `เพศพื้นฐาน: ${(grammar.nounGenders ? (grammar.nounGenders.genders || DEFAULT_BASE_NOUN_GENDERS) : DEFAULT_BASE_NOUN_GENDERS).join(', ')} (ไม่สามารถลบได้)`;
            
            const inputGroupInGender = customGenderListInput.querySelector('.flex.gap-2');
            if (inputGroupInGender) {
                 inputGroupInGender.insertAdjacentElement('afterend', baseGenderDisplay);
            } else {
                customGenderListInput.appendChild(baseGenderDisplay);
            }

            nounGenderSection.appendChild(genderManagementDiv);
            section.appendChild(nounGenderSection); 


            const inflectionSection = document.createElement('div');
            inflectionSection.className = 'p-3 border rounded-md'; 
            inflectionSection.style.backgroundColor = 'var(--list-input-section-bg)';
            inflectionSection.style.borderColor = 'var(--list-input-section-border)';

            inflectionSection.innerHTML = `<h4 class="font-semibold mb-2" style="color: var(--list-input-label-color);">กฎการผันคำ (Inflection Rules)</h4>
                                     <p class="text-xs text-gray-500 mb-2">ระบบการสร้างตารางผันคำแบบละเอียดจะพัฒนาในอนาคต</p>`;
            const inflectionList = document.createElement('div');
            inflectionList.id = 'inflectionRuleList';
            (grammar.morphology.inflectionRules || []).forEach((rule, index) => {
                inflectionList.innerHTML += `
                    <div class="flex items-center gap-2 mb-2 p-2 bg-white rounded border text-sm">
                        <span><strong>ชนิดคำเป้าหมาย:</strong> ${rule.partOfSpeechTarget || 'N/A'}, <strong>ลักษณะ:</strong> ${rule.characteristic}, <strong>กฎ:</strong> ${rule.ruleType} '${rule.ruleValue}' ${rule.example ? `(เช่น ${rule.example})` : ''}</span>
                        <button class="text-xs text-red-500 hover:text-red-700 ml-auto" onclick="removeInflectionRule(${index})">ลบ</button>
                    </div>`;
            });
            inflectionSection.appendChild(inflectionList);

            const addInflectionDiv = document.createElement('div');
            addInflectionDiv.className = 'flex gap-2 mt-2 items-center flex-wrap';

            const posTargetSelect = document.createElement('select');
            posTargetSelect.id = 'inflectionPosTarget';
            posTargetSelect.className = 'p-1 border rounded-md text-sm';
            posTargetSelect.innerHTML = '<option value="">-- เลือกชนิดคำ --</option>';
            getPartsOfSpeech().forEach(pos => posTargetSelect.innerHTML += `<option value="${pos}">${pos}</option>`);

            const inflectionInputsHTML = `
                <input type="text" id="inflectionCharacteristic" placeholder="ลักษณะ/กาล (เช่น อดีต, พหูพจน์)" class="p-1 border rounded-md text-sm flex-grow sm:flex-grow-0 min-w-[150px]">
                <select id="inflectionRuleType" class="p-1 border rounded-md text-sm">
                    <option value="suffix">เติมท้าย (Suffix)</option>
                    <option value="prefix">เติมหน้า (Prefix)</option>
                    <option value="infix">แทรกกลาง (Infix)</option>
                    <option value="reduplication_full">ซ้ำคำทั้งคำ (Full Reduplication)</option>
                    <option value="reduplication_partial">ซ้ำคำบางส่วน (Partial Reduplication)</option>
                    <option value="ablaut">เปลี่ยนเสียงสระ (Ablaut/Vowel Change)</option>
                    <option value="suppletion">การใช้คำอื่นแทน (Suppletion)</option>
                    <option value="tonal_change">เปลี่ยนวรรณยุกต์ (Tonal Change)</option>
                </select>
                <input type="text" id="inflectionRuleValue" placeholder="ค่า/รูปแบบ (เช่น -ed, *a>i, CVC-)" class="p-1 border rounded-md text-sm flex-grow sm:flex-grow-0 min-w-[150px]">
                <input type="text" id="inflectionExample" placeholder="ตัวอย่าง (เช่น run > ran)" class="p-1 border rounded-md text-sm flex-grow sm:flex-grow-0 min-w-[150px]">
                <button id="addInflectionRuleBtn" class="btn-secondary bg-blue-400 hover:bg-blue-500 px-2 py-1 rounded-md text-xs">เพิ่มกฎ</button>
            `;
            addInflectionDiv.appendChild(posTargetSelect);
            addInflectionDiv.innerHTML += inflectionInputsHTML;
            inflectionSection.appendChild(addInflectionDiv);
            section.appendChild(inflectionSection); 

            document.getElementById('sentenceStructureSelect').addEventListener('change', (e) => {
                grammar.sentenceStructure = e.target.value; saveData();
            });
            document.getElementById('enableNounGenders').addEventListener('change', (e) => {
                if (!grammar.nounGenders) grammar.nounGenders = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.grammar.nounGenders));
                grammar.nounGenders.enabled = e.target.checked;
                document.getElementById('genderManagementDiv').classList.toggle('hidden', !e.target.checked);
                saveData();
                renderGrammarUI(tabContentContainer); 
                if (activeTab === 'dictionary') { 
                     const currentSearchTerm = document.getElementById(`dictionarySearch_${(tabContentContainer.querySelector('[id^=dictionarySearch_]')||{}).id ? tabContentContainer.querySelector('[id^=dictionarySearch_]').id.split('_')[1] : Date.now()}`)?.value || '';
                     renderDictionaryTable(currentSearchTerm);
                }
            });
            document.getElementById('addInflectionRuleBtn').addEventListener('click', () => {
                const posTarget = document.getElementById('inflectionPosTarget').value;
                const characteristic = document.getElementById('inflectionCharacteristic').value.trim();
                const ruleType = document.getElementById('inflectionRuleType').value;
                const ruleValue = document.getElementById('inflectionRuleValue').value.trim();
                const example = document.getElementById('inflectionExample').value.trim();
                if (posTarget && characteristic && ruleValue) {
                    if (!grammar.morphology.inflectionRules) grammar.morphology.inflectionRules = [];
                    grammar.morphology.inflectionRules.push({ partOfSpeechTarget: posTarget, characteristic, ruleType, ruleValue, example });
                    renderGrammarUI(tabContentContainer); saveData();
                } else {
                    alert("กรุณากรอก ชนิดคำเป้าหมาย, ลักษณะ และ ค่า/รูปแบบ ของกฎการผันคำ");
                }
            });
        }

        window.removeInflectionRule = (index) => {
            currentLanguage.grammar.morphology.inflectionRules.splice(index, 1);
            renderGrammarUI(tabContentContainer); saveData();
        };


        function renderDictionaryUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'dictionary').sectionClass);
            const existingSection = container.querySelector('.dictionary-section-class');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'p-3 border rounded-md dictionary-section-class'; 
            const searchId = `dictionarySearch_${Date.now()}`;
            const suggestionsId = `autocompleteSuggestionsContainer_${Date.now()}`;

            section.innerHTML = `
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <div class="relative flex-grow min-w-[200px]">
                        <input type="text" id="${searchId}" placeholder="🔍 ค้นหาคำศัพท์ (รูปอักขรวิธี, รูปหน่วยเสียง, หรือความหมาย)..." class="w-full p-2 border rounded-md">
                        <div id="${suggestionsId}" class="autocomplete-suggestions hidden shadow-lg" style="width: calc(100% - 0px); top: 100%; left:0;"></div>
                    </div>
                    <button id="searchSynonymBtn" class="btn-secondary bg-yellow-400 hover:bg-yellow-500 px-3 py-2 rounded-md text-sm whitespace-nowrap"><i class="fas fa-search-plus mr-1"></i> ค้นหาไวพจน์</button>
                </div>
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <button id="exportJsonBtn" class="btn-secondary bg-amber-400 hover:bg-amber-500 px-3 py-1 rounded-md text-sm">Export JSON</button>
                    <button id="exportCsvBtn" class="btn-secondary bg-amber-400 hover:bg-amber-500 px-3 py-1 rounded-md text-sm">Export CSV</button>
                </div>
                <button id="showAddWordModalBtn" class="btn-primary bg-yellow-500 hover:bg-yellow-600 py-2 px-4 rounded-md mb-4">➕ เพิ่มคำศัพท์ใหม่</button>
                <div id="dictionaryTableContainer" class="overflow-x-auto">
                     <p class="text-center text-gray-500">พิมพ์ในช่องค้นหาเพื่อแสดงคำศัพท์ หรือเพิ่มคำศัพท์ใหม่</p>
                </div>
            `;
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const searchInput = document.getElementById(searchId);
            const suggestionsContainer = document.getElementById(suggestionsId);

            searchInput.addEventListener('input', () => {
                const rawSearchTerm = searchInput.value.trim();
                renderDictionaryTable(rawSearchTerm); 

                if (rawSearchTerm.length > 0) {
                     const lowerSearchTerm = rawSearchTerm.toLowerCase();
                    const suggestions = (currentLanguage.lexicon || [])
                        .filter(entry => {
                            const orthographic = entry.word.toLowerCase();
                            const impliedPhonemic = orthographicToImpliedPhonemic(entry.word).toLowerCase();
                            return orthographic.startsWith(lowerSearchTerm) ||
                                   impliedPhonemic.startsWith(lowerSearchTerm) ||
                                   entry.meaning.toLowerCase().includes(lowerSearchTerm);
                        })
                        .slice(0, 10);

                    suggestionsContainer.innerHTML = '';
                    if (suggestions.length > 0) {
                        suggestions.forEach(suggestion => {
                            const div = document.createElement('div');
                            div.textContent = `${suggestion.word} (${orthographicToImpliedPhonemic(suggestion.word)}) - ${suggestion.meaning.substring(0,30)}...`;
                            div.className = 'autocomplete-suggestion p-2 hover:bg-gray-100 cursor-pointer';
                            div.onclick = () => {
                                searchInput.value = suggestion.word; 
                                suggestionsContainer.classList.add('hidden');
                                renderDictionaryTable(suggestion.word); 
                            };
                            suggestionsContainer.appendChild(div);
                        });
                        suggestionsContainer.classList.remove('hidden');
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                } else { 
                    suggestionsContainer.classList.add('hidden');
                    document.getElementById('dictionaryTableContainer').innerHTML = '<p class="text-center text-gray-500">พิมพ์ในช่องค้นหาเพื่อแสดงคำศัพท์ หรือเพิ่มคำศัพท์ใหม่</p>';
                }
            });

            document.addEventListener('click', function(event) {
                if (searchInput && suggestionsContainer && !searchInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });


            document.getElementById('searchSynonymBtn').addEventListener('click', () => {
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) {
                    alert("กรุณาป้อนคำไวพจน์ที่ต้องการค้นหา");
                    return;
                }
                renderDictionaryTable(searchTerm, true);
            });

            document.getElementById('exportJsonBtn').addEventListener('click', exportDictionaryAsJSON);
            document.getElementById('exportCsvBtn').addEventListener('click', exportDictionaryAsCSV);
            document.getElementById('showAddWordModalBtn').addEventListener('click', () => showWordModal());
            renderDictionaryTable(); 
        }


        function generateSimpleIPA(orthoOrPhonemicString) {
            if (!orthoOrPhonemicString) return '';
            
            let phonemicToProcess = orthoOrPhonemicString;
            if (currentLanguage.orthography.writingSystem === 'custom' && currentLanguage.orthography.customSymbols && currentLanguage.orthography.customSymbols.length > 0) {
                phonemicToProcess = orthographicToImpliedPhonemic(orthoOrPhonemicString);
            }
            return `/${phonemicToProcess.split('').join('.')}/`;
        }


        function renderDictionaryTable(searchTerm = '', searchSynonyms = false) {
            const container = document.getElementById('dictionaryTableContainer');
            if (!container) return;

            container.innerHTML = ''; 
            const lowerSearchTerm = searchTerm.toLowerCase();

            let filteredLexicon = (currentLanguage.lexicon || []).filter(entry => {
                if (!searchTerm && !searchSynonyms) return true; 

                const orthographicWord = entry.word.toLowerCase();
                const impliedPhonemic = orthographicToImpliedPhonemic(entry.word).toLowerCase(); 
                const meaning = entry.meaning.toLowerCase();

                if (searchSynonyms) {
                    return entry.synonyms && entry.synonyms.some(syn => syn.toLowerCase().includes(lowerSearchTerm));
                } else {
                    return orthographicWord.includes(lowerSearchTerm) ||
                           impliedPhonemic.includes(lowerSearchTerm) || 
                           meaning.includes(lowerSearchTerm);
                }
            });


            if (filteredLexicon.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบคำศัพท์ที่ตรงกับเงื่อนไข</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y shadow-sm rounded-lg'; 
            table.style.backgroundColor = 'var(--card-bg-color)'; 
            table.style.borderColor = 'var(--border-color-medium)'; 

            let tableHeadHTML = `
                <thead style="background-color: var(--list-input-section-bg);">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--list-input-label-color);">คำศัพท์ (รูปอักขรวิธี)</th>
                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--list-input-label-color);">สัททอักษร (IPA)</th>
                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--list-input-label-color);">ความหมาย</th>
                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--list-input-label-color);">ชนิดของคำ</th>`;

            if (currentLanguage.grammar.nounGenders && currentLanguage.grammar.nounGenders.enabled) {
                tableHeadHTML += `<th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider hidden md:table-cell" style="color: var(--list-input-label-color);">เพศ</th>`;
            }
            tableHeadHTML += `
                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--list-input-label-color);">จัดการ</th>
                    </tr>
                </thead>
                <tbody class="divide-y" style="border-color: var(--border-color-light);"></tbody>
            `;
            table.innerHTML = tableHeadHTML;

            const tbody = table.querySelector('tbody');
            filteredLexicon.forEach(entry => {
                const row = tbody.insertRow();
                row.style.borderColor = 'var(--border-color-light)';
                const displayOrtho = entry.word;
                const phonemicForIPA = entry.phonetics ? entry.phonetics : orthographicToImpliedPhonemic(entry.word);
                const displayIPA = entry.phonetics || generateSimpleIPA(phonemicForIPA);


                let cellsHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm"><a href="#" style="color: var(--link-color);" class="hover:underline" onclick="event.preventDefault(); showWordDetailPopup(${entry.id})">${displayOrtho}</a></td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${displayIPA}</td>
                    <td class="px-4 py-2 text-sm">${entry.meaning}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${entry.partOfSpeech}</td>
                `;
                if (currentLanguage.grammar.nounGenders && currentLanguage.grammar.nounGenders.enabled) {
                    cellsHTML += `<td class="px-4 py-2 text-sm text-gray-500 hidden md:table-cell">${(entry.partOfSpeech === 'คำนาม' && entry.gender) ? entry.gender : 'N/A'}</td>`;
                }
                cellsHTML += `
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="showWordModal(${entry.id})"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteWordFromDictionary(${entry.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                row.innerHTML = cellsHTML;
            });
            container.appendChild(table);
        }

        window.showWordDetailPopup = (wordId) => {
            const word = (currentLanguage.lexicon || []).find(w => w.id === wordId);
            if (!word) return;

            wordDetailTitle.textContent = word.word;
            wordDetailTitle.style.color = "var(--section-title-color)"; 
            let contentHtml = '';

            const impliedPhonemic = orthographicToImpliedPhonemic(word.word);
            const phonemicForIPA = word.phonetics ? word.phonetics : impliedPhonemic;
            const displayIPA = word.phonetics || generateSimpleIPA(phonemicForIPA);


            const fields = [
                { label: 'รูปหน่วยเสียง (Implied Phonemic)', value: impliedPhonemic },
                { label: 'การออกเสียง (สัททอักษร/IPA)', value: displayIPA },
                { label: 'ความหมาย', value: word.meaning },
                { label: 'ชนิดของคำ', value: word.partOfSpeech },
            ];
             if (currentLanguage.grammar.nounGenders && currentLanguage.grammar.nounGenders.enabled && word.partOfSpeech === 'คำนาม') {
                fields.push({ label: 'เพศ', value: word.gender || 'N/A' });
            }
            fields.push(
                { label: 'ตัวอย่างประโยค', value: word.example },
                { label: 'คำไวพจน์', value: word.synonyms ? word.synonyms.join(', ') : null }
            );


            fields.forEach(field => {
                if (field.value && field.value.toString().trim() !== '') {
                    contentHtml += `<div class="word-detail-popup-field"><strong style="color: var(--link-color);">${field.label}:</strong> ${field.value}</div>`;
                }
            });

            if (word.etymology) {
                let etymologyHtml = '';
                if (word.etymology.notes && word.etymology.notes.trim() !== '') {
                    etymologyHtml += `<p><strong>หมายเหตุ:</strong> ${word.etymology.notes}</p>`;
                }
                if (word.etymology.roots && word.etymology.roots.length > 0) {
                    etymologyHtml += `<p class="mt-1"><strong>รากศัพท์:</strong></p><ul class="list-disc list-inside ml-4 text-sm">`;
                    word.etymology.roots.forEach(root => {
                        if (root.wordId) {
                            const parentWord = (currentLanguage.lexicon || []).find(w => w.id === root.wordId);
                            etymologyHtml += `<li>มาจากคำว่า: <strong>${parentWord ? parentWord.word + ' (' + orthographicToImpliedPhonemic(parentWord.word) +')' : 'คำที่ถูกลบ'}</strong></li>`;
                        } else if (root.customRoot) {
                            etymologyHtml += `<li>มาจาก: <strong>${root.customRoot}</strong> (ภาษา: ${root.sourceLang || 'ไม่ระบุ'})</li>`;
                        }
                    });
                    etymologyHtml += `</ul>`;
                }
                if (etymologyHtml) {
                     contentHtml += `<div class="word-detail-popup-field"><strong style="color: var(--link-color);">ศัพทมูลวิทยา:</strong>${etymologyHtml}</div>`;
                }
            }
            wordDetailContent.innerHTML = contentHtml || '<p class="text-gray-500">ไม่มีรายละเอียดเพิ่มเติม</p>';
            wordDetailModal.dataset.wordId = wordId; 

            wordDetailActions.innerHTML = ''; 

            const applicableInflectionRules = (currentLanguage.grammar.morphology.inflectionRules || []).filter(rule => rule.partOfSpeechTarget === word.partOfSpeech);
            if (applicableInflectionRules.length > 0) {
                const inflectBtn = document.createElement('button');
                inflectBtn.className = 'btn-secondary text-xs px-2 py-1';
                inflectBtn.innerHTML = `<i class="fas fa-list-ol mr-1"></i> แสดงการผันคำ (ตัวอย่าง)`;
                wordDetailActions.appendChild(inflectBtn);
            }

            if (currentLanguage.dialects && currentLanguage.dialects.enabled) {
                const dialectBtn = document.createElement('button');
                dialectBtn.className = 'btn-secondary bg-lime-500 hover:bg-lime-600 text-xs px-2 py-1';
                dialectBtn.innerHTML = `<i class="fas fa-map-signs mr-1"></i> ดู/แก้ไขคำถิ่น`;
                dialectBtn.onclick = () => showWordDialectFormsPopup(word.id);
                wordDetailActions.appendChild(dialectBtn);
            }

            const lineageForThisWord = (currentLanguage.wordLineages || []).find(lin =>
                Object.values(lin.forms).some(form => form.linkedLexiconId === word.id)
            );
            if (lineageForThisWord) {
                const evolutionBtn = document.createElement('button');
                evolutionBtn.className = 'btn-secondary bg-purple-500 hover:bg-purple-600 text-xs px-2 py-1';
                evolutionBtn.innerHTML = `<i class="fas fa-stream mr-1"></i> ดูสายวิวัฒนาการ`;
                evolutionBtn.onclick = () => showWordEvolutionLineagePopup(lineageForThisWord.lineageId, word.word);
                wordDetailActions.appendChild(evolutionBtn);
            }

            wordDetailModal.classList.remove('hidden');
        };

        window.showWordModal = (wordId = null, generatedOrthographicWord = null, generatedIPA = null, generatedMeaning = null, generatedPOS = null, generatedPhonemicForNew = null) => {
            const existingWord = wordId ? (currentLanguage.lexicon || []).find(w => w.id === wordId) : null;
            const modalId = 'wordEditModal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal p-4';

            const initialOrthographicWord = existingWord ? existingWord.word : (generatedOrthographicWord || '');
            const phonemicBaseForIPA = existingWord ? (existingWord.phonetics || orthographicToImpliedPhonemic(existingWord.word)) : (generatedPhonemicForNew || orthographicToImpliedPhonemic(initialOrthographicWord));
            const initialPhoneticsIPA = existingWord ? existingWord.phonetics : (generatedIPA || generateSimpleIPA(phonemicBaseForIPA));
            const initialMeaning = existingWord ? existingWord.meaning : (generatedMeaning || '');

            const initialPartOfSpeech = existingWord ? existingWord.partOfSpeech : (generatedPOS && getPartsOfSpeech().includes(generatedPOS) ? generatedPOS : (getPartsOfSpeech()[0] || DEFAULT_BASE_PARTS_OF_SPEECH[0]));
            const initialGender = existingWord ? existingWord.gender : '';
            const initialExample = existingWord ? existingWord.example : '';
            const initialSynonyms = existingWord && existingWord.synonyms ? existingWord.synonyms.join(', ') : '';
            const initialEtymologyNotes = existingWord && existingWord.etymology ? existingWord.etymology.notes : '';

            let posOptionsHtml = '';
            getPartsOfSpeech().forEach(pos => {
                posOptionsHtml += `<option value="${pos}" ${initialPartOfSpeech === pos ? 'selected' : ''}>${pos}</option>`;
            });

            let genderDropdownHtml = '';
            const buildGenderDropdown = (selectedPos, currentGender) => {
                const availableGenders = getNounGenders();
                if (selectedPos === 'คำนาม' && currentLanguage.grammar.nounGenders && currentLanguage.grammar.nounGenders.enabled && availableGenders.length > 0) {
                    let genderOptionsHtml = '<option value="">-- ไม่ระบุเพศ --</option>';
                    availableGenders.forEach(g => {
                        genderOptionsHtml += `<option value="${g}" ${currentGender === g ? 'selected' : ''}>${g}</option>`;
                    });
                    return `
                        <div id="modalGenderDiv">
                            <label class="block text-sm font-medium">เพศ (สำหรับคำนาม):</label>
                            <select id="modalGender" class="w-full p-2 border rounded-md">${genderOptionsHtml}</select>
                        </div>`;
                }
                return '<div id="modalGenderDiv" class="hidden"></div>'; 
            };
            genderDropdownHtml = buildGenderDropdown(initialPartOfSpeech, initialGender); 


            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">${existingWord ? 'แก้ไขคำศัพท์: ' + existingWord.word : 'เพิ่มคำศัพท์ใหม่'}</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium">คำศัพท์ (รูปอักขรวิธี - Orthographic Form):</label>
                            <input type="text" id="modalWordOrthographic" value="${initialOrthographicWord}" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">การออกเสียง (สัททอักษร/IPA - Custom):</label>
                            <div class="flex">
                                <input type="text" id="modalPhoneticsIPA" value="${initialPhoneticsIPA}" class="w-full p-2 border rounded-md rounded-r-none" placeholder="/พยางค์1.พยางค์2/">
                                <button id="autoGenerateIPABtnModal" title="สร้าง IPA อัตโนมัติ (พื้นฐาน จากรูปอักขรวิธี/หน่วยเสียง)" class="btn-secondary p-2 rounded-l-none"><i class="fas fa-magic"></i></button>
                            </div>
                        </div>
                         <div>
                            <label class="block text-sm font-medium">ความหมาย (ภาษาไทย):</label>
                            <div class="flex">
                                <input type="text" id="modalMeaning" value="${initialMeaning}" class="w-full p-2 border rounded-md rounded-r-none">
                                <button id="getRandomThaiMeaningBtn" title="สุ่มความหมายและชนิดคำภาษาไทย" class="btn-secondary p-2 rounded-l-none"><i class="fas fa-dice"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">ชนิดของคำ:</label>
                            <select id="modalPartOfSpeech" class="w-full p-2 border rounded-md">${posOptionsHtml}</select>
                        </div>
                        <div id="genderDropdownContainer">${genderDropdownHtml}</div>
                        <div>
                            <label class="block text-sm font-medium">ตัวอย่างประโยค:</label>
                            <textarea id="modalExample" class="w-full p-2 border rounded-md" rows="2">${initialExample}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">คำไวพจน์ (Synonyms - คั่นด้วยจุลภาค):</label>
                            <input type="text" id="modalSynonyms" value="${initialSynonyms}" class="w-full p-2 border rounded-md">
                        </div>
                        <div id="etymologySectionModal">
                            <label class="block text-sm font-medium mb-1">ศัพทมูลวิทยา (Etymology):</label>
                            <div id="etymologyRootsContainerModal" class="space-y-2 mb-2"></div>
                            <button id="addEtymologyRootModalBtn" class="text-xs btn-secondary bg-purple-400 hover:bg-purple-500 px-2 py-1 rounded-md">เพิ่มรากศัพท์</button>
                            <div class="mt-2">
                                <label class="block text-sm font-medium">หมายเหตุศัพทมูลวิทยา:</label>
                                <textarea id="modalEtymologyNotes" class="w-full p-2 border rounded-md" rows="2">${initialEtymologyNotes}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancelWordModalBtn" class="btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">ยกเลิก</button>
                        <button id="saveWordModalBtn" class="btn-primary px-4 py-2 rounded-md">${existingWord ? 'บันทึกการเปลี่ยนแปลง' : 'เพิ่มคำศัพท์'}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#autoGenerateIPABtnModal').addEventListener('click', () => {
                const orthographicForm = modal.querySelector('#modalWordOrthographic').value.trim();
                const impliedPhonemicForIPA = orthographicToImpliedPhonemic(orthographicForm);
                modal.querySelector('#modalPhoneticsIPA').value = generateSimpleIPA(impliedPhonemicForIPA);
            });


            modal.querySelector('#getRandomThaiMeaningBtn').addEventListener('click', () => {
                 if (thaiWordDatabase.length > 0) {
                    const meaningInput = modal.querySelector('#modalMeaning');
                    const posSelect = modal.querySelector('#modalPartOfSpeech');
                    
                    const thaiEntry = thaiWordDatabase[Math.floor(Math.random() * thaiWordDatabase.length)];
                    meaningInput.value = thaiEntry.word || "N/A (ไม่มีคำศัพท์)"; // Use the 'word' field from DB
                    
                    let posFromDb = thaiEntry.pos;
                    const conlangPOSList = getPartsOfSpeech();
                    if (conlangPOSList.includes(posFromDb)) {
                        posSelect.value = posFromDb;
                    } else if (conlangPOSList.length > 0) {
                         posSelect.value = conlangPOSList[Math.floor(Math.random() * conlangPOSList.length)];
                    }
                    // If posSelect is not updated, it retains its current value or default.

                    const event = new Event('change', { bubbles: true }); // Trigger change for gender dropdown update
                    posSelect.dispatchEvent(event);
                } else {
                    alert("ฐานข้อมูลคำศัพท์ไทยยังไม่ได้โหลดหรือว่างเปล่า");
                }
            });

            const modalPOSSelect = modal.querySelector('#modalPartOfSpeech');
            const genderDropdownContainer = modal.querySelector('#genderDropdownContainer');
            modalPOSSelect.addEventListener('change', () => {
                const genderSelectInModal = modal.querySelector('#modalGender'); 
                const selectedGender = genderSelectInModal ? genderSelectInModal.value : ''; 
                genderDropdownContainer.innerHTML = buildGenderDropdown(modalPOSSelect.value, selectedGender); 
            });


            const etymologyRootsContainerModal = modal.querySelector('#etymologyRootsContainerModal');
            let tempEtymologyRoots = existingWord && existingWord.etymology && existingWord.etymology.roots ? JSON.parse(JSON.stringify(existingWord.etymology.roots)) : [];

            const renderEtymologyRootsModal = () => {
                etymologyRootsContainerModal.innerHTML = '';
                tempEtymologyRoots.forEach((root, index) => {
                    const rootDiv = document.createElement('div');
                    rootDiv.className = 'flex items-center gap-2 p-2 border rounded bg-purple-50 flex-wrap sm:flex-nowrap'; 

                    const selectEl = document.createElement('select');
                    selectEl.className = 'p-1 border rounded text-sm flex-grow modal-etymology-root-word w-full sm:w-auto mb-1 sm:mb-0';
                    selectEl.innerHTML = '<option value="">-- เลือกคำที่มีอยู่ --</option>';
                    (currentLanguage.lexicon || []).forEach(w => {
                        if (!existingWord || w.id !== existingWord.id) { 
                             selectEl.innerHTML += `<option value="${w.id}" ${root.wordId === w.id ? 'selected' : ''}>${w.word} (${orthographicToImpliedPhonemic(w.word)})</option>`;
                        }
                    });
                    selectEl.innerHTML += '<option value="custom">-- เพิ่มรากศัพท์เอง --</option>';
                    if (root.customRoot && !root.wordId) selectEl.value = "custom"; 

                    const customRootInput = document.createElement('input');
                    customRootInput.type = 'text';
                    customRootInput.placeholder = 'รากศัพท์';
                    customRootInput.className = `p-1 border rounded text-sm flex-grow modal-etymology-custom-root w-full sm:w-auto mb-1 sm:mb-0 ${(!root.wordId && root.customRoot) || selectEl.value === "custom" ? '' : 'hidden'}`;
                    customRootInput.value = root.customRoot || '';

                    const sourceLangInput = document.createElement('input');
                    sourceLangInput.type = 'text';
                    sourceLangInput.placeholder = 'ภาษาต้นทาง';
                    sourceLangInput.className = `p-1 border rounded text-sm modal-etymology-source-lang w-full sm:w-auto mb-1 sm:mb-0 ${(!root.wordId && root.customRoot) || selectEl.value === "custom" ? '' : 'hidden'}`;
                    sourceLangInput.value = root.sourceLang || '';

                    selectEl.onchange = (e) => {
                        const isCustom = e.target.value === "custom";
                        customRootInput.classList.toggle('hidden', !isCustom);
                        sourceLangInput.classList.toggle('hidden', !isCustom);
                        if (tempEtymologyRoots[index]) { 
                            tempEtymologyRoots[index].wordId = isCustom ? null : (e.target.value ? parseInt(e.target.value) : null);
                            if (!isCustom) { 
                                tempEtymologyRoots[index].customRoot = '';
                                tempEtymologyRoots[index].sourceLang = '';
                                customRootInput.value = ''; 
                                sourceLangInput.value = '';
                            }
                        }
                    };
                    customRootInput.oninput = (e) => { if(tempEtymologyRoots[index]) tempEtymologyRoots[index].customRoot = e.target.value; };
                    sourceLangInput.oninput = (e) => { if(tempEtymologyRoots[index]) tempEtymologyRoots[index].sourceLang = e.target.value; };


                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'ลบ';
                    removeBtn.className = 'text-xs bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded h-fit';
                    removeBtn.onclick = () => {
                        tempEtymologyRoots.splice(index,1);
                        renderEtymologyRootsModal();
                    };

                    rootDiv.appendChild(selectEl);
                    rootDiv.appendChild(customRootInput);
                    rootDiv.appendChild(sourceLangInput);
                    rootDiv.appendChild(removeBtn);
                    etymologyRootsContainerModal.appendChild(rootDiv);
                });
            };
            renderEtymologyRootsModal();

            modal.querySelector('#addEtymologyRootModalBtn').onclick = () => {
                tempEtymologyRoots.push({ wordId: null, customRoot: '', sourceLang: '' });
                renderEtymologyRootsModal();
            };

            modal.querySelector('#cancelWordModalBtn').onclick = () => modal.remove();
            modal.querySelector('#saveWordModalBtn').onclick = () => {
                const newWordId = existingWord ? existingWord.id : calculateNextWordId(currentLanguage.lexicon);
                let genderValue = '';
                const genderSelect = modal.querySelector('#modalGender');
                if (genderSelect && genderSelect.closest('#modalGenderDiv') && !genderSelect.closest('#modalGenderDiv').classList.contains('hidden')) {
                    genderValue = genderSelect.value;
                }

                const orthographicFormValue = modal.querySelector('#modalWordOrthographic').value.trim();

                const updatedWord = {
                    id: newWordId,
                    word: orthographicFormValue,
                    phonetics: modal.querySelector('#modalPhoneticsIPA').value.trim(),
                    meaning: modal.querySelector('#modalMeaning').value.trim(),
                    partOfSpeech: modal.querySelector('#modalPartOfSpeech').value,
                    gender: genderValue,
                    example: modal.querySelector('#modalExample').value.trim(),
                    synonyms: modal.querySelector('#modalSynonyms').value.split(',').map(s => s.trim()).filter(s => s),
                    etymology: { 
                        roots: tempEtymologyRoots.filter(r => r.wordId || (r.customRoot && r.customRoot.trim() !== '')),
                        notes: modal.querySelector('#modalEtymologyNotes').value.trim()
                    }
                };

                if (!updatedWord.word || !updatedWord.meaning || !updatedWord.partOfSpeech) {
                    alert('กรุณากรอกข้อมูล: คำศัพท์ (รูปอักขรวิธี), ความหมาย, และชนิดของคำ');
                    return;
                }

                if (existingWord) {
                    const index = (currentLanguage.lexicon || []).findIndex(w => w.id === wordId);
                    if (index > -1) currentLanguage.lexicon[index] = updatedWord;
                } else {
                    if(!currentLanguage.lexicon) currentLanguage.lexicon = [];
                    currentLanguage.lexicon.push(updatedWord);
                }
                modal.remove();
                const currentSearchTerm = document.getElementById(`dictionarySearch_${(tabContentContainer.querySelector('[id^=dictionarySearch_]')||{}).id ? tabContentContainer.querySelector('[id^=dictionarySearch_]').id.split('_')[1] : Date.now()}`)?.value || '';
                if (activeTab === 'dictionary') renderDictionaryTable(currentSearchTerm);
                else if (activeTab === 'etymology') renderEtymologyUI(tabContentContainer);
                saveData();
            };
        };

        window.deleteWordFromDictionary = (wordId) => {
            if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบคำนี้? การกระทำนี้อาจส่งผลต่อข้อมูลศัพทมูลวิทยาของคำอื่น และคำที่ใช้ในสายวิวัฒนาการ')) {
                currentLanguage.lexicon = (currentLanguage.lexicon || []).filter(w => w.id !== wordId);
                (currentLanguage.lexicon || []).forEach(word => {
                    if (word.etymology && word.etymology.roots) {
                        word.etymology.roots = word.etymology.roots.filter(root => root.wordId !== wordId);
                    }
                });
                if (currentLanguage.wordLineages) {
                    currentLanguage.wordLineages.forEach(lineage => {
                        Object.keys(lineage.forms).forEach(eraName => {
                            if (lineage.forms[eraName] && lineage.forms[eraName].linkedLexiconId === wordId) {
                                lineage.forms[eraName].linkedLexiconId = null; 
                            }
                        });
                    });
                }
                if (currentLanguage.dialects && currentLanguage.dialects.dialectWords) {
                    currentLanguage.dialects.dialectWords = currentLanguage.dialects.dialectWords.filter(dw => dw.standardWordId !== wordId);
                }


                const currentSearchTerm = document.getElementById(`dictionarySearch_${(tabContentContainer.querySelector('[id^=dictionarySearch_]')||{}).id ? tabContentContainer.querySelector('[id^=dictionarySearch_]').id.split('_')[1] : Date.now()}`)?.value || '';
                if (activeTab === 'dictionary') renderDictionaryTable(currentSearchTerm);
                else if (activeTab === 'etymology') renderEtymologyUI(tabContentContainer);
                else if (activeTab === 'evolution') renderEvolutionUI(tabContentContainer);
                else if (activeTab === 'dialects') renderDialectsUI(tabContentContainer); 
                saveData();
            }
        };

        function exportDictionaryAsJSON() {
            const jsonData = JSON.stringify(currentLanguage.lexicon || [], null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentLanguage.name}_dictionary.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportDictionaryAsCSV() {
            if (!currentLanguage.lexicon || currentLanguage.lexicon.length === 0) {
                alert("พจนานุกรมว่างเปล่า ไม่มีอะไรให้ export");
                return;
            }
            const headers = ['OrthographicWord', 'ImpliedPhonemicForm', 'PhoneticsIPA', 'Meaning', 'PartOfSpeech', 'Gender', 'Example', 'Synonyms', 'EtymologyRoots', 'EtymologyNotes'];
            const rows = (currentLanguage.lexicon || []).map(entry => {
                const phonemicForIPA = entry.phonetics ? entry.phonetics : orthographicToImpliedPhonemic(entry.word);
                return [
                    entry.word,
                    orthographicToImpliedPhonemic(entry.word),
                    entry.phonetics || generateSimpleIPA(phonemicForIPA),
                    entry.meaning,
                    entry.partOfSpeech,
                    (currentLanguage.grammar.nounGenders.enabled && entry.partOfSpeech === 'คำนาม' && entry.gender) ? entry.gender : '',
                    entry.example,
                    entry.synonyms ? entry.synonyms.join(';') : '', 
                    entry.etymology && entry.etymology.roots ? entry.etymology.roots.map(r => r.wordId ? `id:${r.wordId}` : `${r.customRoot}(${r.sourceLang || ''})`).join(' | ') : '',
                    entry.etymology ? entry.etymology.notes : ''
                ];
            });

            let csvContent = "\ufeff"; 
            csvContent += headers.join(",") + "\n"
                + rows.map(e => e.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(",")).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${currentLanguage.name}_dictionary.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        function renderOrthographyUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'orthography').sectionClass);
            const existingSection = container.querySelector('.orthography-section-class');
            if(existingSection) existingSection.remove();

            const { writingSystem, customSymbols, direction } = currentLanguage.orthography;
            const section = document.createElement('div');
            section.className = 'space-y-4 p-3 border rounded-md orthography-section-class'; 

            const soundDatalistId = 'phonemeSuggestionsDatalistOrtho';
            let soundOptionsHtml = '';
            const consonants = (currentLanguage.phonology && currentLanguage.phonology.consonants) || [];
            const vowels = (currentLanguage.phonology && currentLanguage.phonology.vowels) || [];
            const allPhonemes = [...new Set([...consonants, ...vowels])];

            allPhonemes.forEach(p => {
                soundOptionsHtml += `<option value="${p}"></option>`;
            });
            const datalistHtml = `<datalist id="${soundDatalistId}">${soundOptionsHtml}</datalist>`;

            section.innerHTML = `
                ${datalistHtml}
                <div>
                    <label class="block text-sm font-medium">ระบบการเขียน:</label>
                    <select id="writingSystemSelect" class="w-full p-2 border rounded-md">
                        <option value="latin" ${writingSystem === 'latin' ? 'selected' : ''}>ใช้ตัวอักษรละติน (A-Z) - รูปอักขรวิธีเหมือนรูปหน่วยเสียง</option>
                        <option value="custom" ${writingSystem === 'custom' ? 'selected' : ''}>ใช้สัญลักษณ์กำหนดเอง</option>
                    </select>
                </div>
                <div id="customSymbolsSection" class="${writingSystem === 'custom' ? '' : 'hidden'}">
                    <label class="block text-sm font-medium mb-1">สัญลักษณ์กำหนดเอง (หน่วยเสียง <i class="fas fa-arrow-right mx-1"></i> สัญลักษณ์อักขรวิธี):</label>
                    <div id="customSymbolList" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2 items-center flex-wrap">
                        <input type="text" id="customSymbolSound" list="${soundDatalistId}" placeholder="หน่วยเสียง (เช่น k, sh, a)" class="p-1 border rounded-md text-sm flex-grow sm:flex-grow-0">
                        <input type="text" id="customSymbolChar" placeholder="สัญลักษณ์ (เช่น ⚶, ✶)" class="p-1 border rounded-md text-sm flex-grow sm:flex-grow-0">
                        <button id="addCustomSymbolBtn" class="btn-secondary px-2 py-1 rounded-md text-xs">เพิ่มสัญลักษณ์</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ระบบจะใช้สัญลักษณ์เหล่านี้เพื่อแปลง 'รูปหน่วยเสียง' เป็น 'รูปอักขรวิธี' สำหรับแสดงผล</p>
                </div>
                <div>
                    <label class="block text-sm font-medium">ทิศทางการเขียน:</label>
                    <select id="writingDirectionSelect" class="w-full p-2 border rounded-md">
                        <option value="ltr" ${direction === 'ltr' ? 'selected' : ''}>ซ้ายไปขวา (Left-to-Right)</option>
                        <option value="rtl" ${direction === 'rtl' ? 'selected' : ''}>ขวาไปซ้าย (Right-to-Left)</option>
                        <option value="ttb" ${direction === 'ttb' ? 'selected' : ''}>บนลงล่าง (Top-to-Bottom)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">ตัวอย่างการแปลงหน่วยเสียงเป็นอักขรวิธี:</label>
                    <input type="text" id="orthoTestPhonemicInput" placeholder="ป้อนรูปหน่วยเสียง (phonemic form)" class="w-full p-2 border rounded-md mb-1">
                    <button id="transliteratePhonemicBtn" class="btn-primary px-3 py-1 rounded-md text-sm">แปลงเป็นอักขรวิธี</button>
                    <p id="transliteratedOrthographicOutput" class="mt-2 p-2 bg-white rounded border min-h-[2.5em]"></p>
                </div>
            `;
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const writingSystemSelect = document.getElementById('writingSystemSelect');
            const customSymbolsSectionEl = document.getElementById('customSymbolsSection');
            const customSymbolList = document.getElementById('customSymbolList');
            const addCustomSymbolBtn = document.getElementById('addCustomSymbolBtn');
            const writingDirectionSelect = document.getElementById('writingDirectionSelect');
            const transliteratePhonemicBtn = document.getElementById('transliteratePhonemicBtn');

            const renderCustomSymbols = () => {
                customSymbolList.innerHTML = '';
                (currentLanguage.orthography.customSymbols || []).forEach((sym, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-1 bg-white rounded border text-sm'; 
                    div.style.borderColor = 'var(--border-color-light)';
                    div.innerHTML = `<span>หน่วยเสียง '${sym.sound}' <i class="fas fa-arrow-right mx-1"></i> สัญลักษณ์ '${sym.symbol}'</span>
                                     <button class="text-xs text-red-500 hover:text-red-700" onclick="removeCustomSymbol(${index})">&times; ลบ</button>`;
                    customSymbolList.appendChild(div);
                });
            };

            if (writingSystem === 'custom') renderCustomSymbols();

            writingSystemSelect.onchange = (e) => {
                currentLanguage.orthography.writingSystem = e.target.value;
                customSymbolsSectionEl.classList.toggle('hidden', e.target.value !== 'custom');
                if (e.target.value === 'custom') renderCustomSymbols();
                saveData();
                const currentSearchTerm = document.getElementById(`dictionarySearch_${(tabContentContainer.querySelector('[id^=dictionarySearch_]')||{}).id ? tabContentContainer.querySelector('[id^=dictionarySearch_]').id.split('_')[1] : Date.now()}`)?.value || '';
                if(activeTab === 'dictionary') renderDictionaryTable(currentSearchTerm);
                if(activeTab === 'wordGen') renderWordGeneratorUI(tabContentContainer); 
                if(activeTab === 'etymology') renderEtymologyUI(tabContentContainer); 
                if(activeTab === 'evolution') renderEvolutionUI(tabContentContainer); 
            };

            addCustomSymbolBtn.onclick = () => {
                const sound = document.getElementById('customSymbolSound').value.trim();
                const symbol = document.getElementById('customSymbolChar').value.trim();
                if (sound && symbol) {
                    if(!currentLanguage.orthography.customSymbols) currentLanguage.orthography.customSymbols = [];
                    currentLanguage.orthography.customSymbols.push({ sound, symbol });
                    document.getElementById('customSymbolSound').value = '';
                    document.getElementById('customSymbolChar').value = '';
                    renderCustomSymbols();
                    saveData();
                }
            };

            writingDirectionSelect.onchange = (e) => {
                currentLanguage.orthography.direction = e.target.value;
                const outputP = document.getElementById('transliteratedOrthographicOutput');
                if (outputP) {
                    outputP.style.direction = (e.target.value === 'rtl' ? 'rtl' : 'ltr');
                    outputP.style.writingMode = (e.target.value === 'ttb' ? 'vertical-rl' : 'horizontal-tb'); 
                }
                saveData();
            };
            const outputPInitial = document.getElementById('transliteratedOrthographicOutput');
            if (outputPInitial) {
                outputPInitial.style.direction = (currentLanguage.orthography.direction === 'rtl' ? 'rtl' : 'ltr');
                outputPInitial.style.writingMode = (currentLanguage.orthography.direction === 'ttb' ? 'vertical-rl' : 'horizontal-tb');
            }


            transliteratePhonemicBtn.onclick = () => {
                const phonemicInput = document.getElementById('orthoTestPhonemicInput').value.trim();
                const outputP = document.getElementById('transliteratedOrthographicOutput');
                if (!phonemicInput) {
                    outputP.textContent = 'กรุณาป้อนรูปหน่วยเสียง';
                    return;
                }
                outputP.textContent = phonemicToOrthographic(phonemicInput);
            };
        }

        window.removeCustomSymbol = (index) => {
            currentLanguage.orthography.customSymbols.splice(index, 1);
            renderOrthographyUI(tabContentContainer); 
            saveData();
        };

        function renderEtymologyUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'etymology').sectionClass);
            const existingSection = container.querySelector('.etymology-section-class');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'p-3 border rounded-md space-y-4 etymology-section-class'; 
            const etymologyDatalistId = `dictionaryWordsForEtymologyDatalist_${Date.now()}`;

            section.innerHTML = `
                <div>
                    <label for="etymologyWordSearch" class="block text-sm font-medium">ค้นหาคำศัพท์ (รูปอักขรวิธี) เพื่อดูรากศัพท์และคำสืบทอด:</label>
                    <div class="flex gap-2">
                        <input type="text" id="etymologyWordSearch" list="${etymologyDatalistId}" placeholder="พิมพ์ชื่อคำ (รูปอักขรวิธี)..." class="flex-grow p-2 border rounded-md">
                        <datalist id="${etymologyDatalistId}"></datalist>
                        <button id="searchEtymologyBtn" class="btn-primary px-3 py-1 rounded-md text-sm">ค้นหา</button>
                    </div>
                </div>
                <div id="etymologyResults" class="p-3 bg-white rounded-md shadow min-h-[100px]">
                    <p class="text-center text-gray-400">ผลการค้นหาศัพทมูลวิทยาจะแสดงที่นี่</p>
                </div>
                <h4 class="font-semibold pt-2 border-t">ผังศัพทมูลวิทยา (รากคำ <i class="fas fa-arrow-left"></i> คำปัจจุบัน <i class="fas fa-arrow-right"></i> คำสืบทอด):</h4>
                <div id="wordEvolutionChartEtymology" class="pedigree-chart p-2 bg-white rounded-md shadow min-h-[150px] overflow-auto">
                    <p class="text-center text-gray-400">เลือกคำเพื่อดูผัง</p>
                </div>
            `;
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const wordSearchInput = document.getElementById('etymologyWordSearch');
            const datalist = document.getElementById(etymologyDatalistId);
            datalist.innerHTML = ''; 
            (currentLanguage.lexicon || []).forEach(w => {
                const option = document.createElement('option');
                option.value = w.word; 
                option.label = `${w.word} (${orthographicToImpliedPhonemic(w.word)})`; 
                datalist.appendChild(option);
            });

            document.getElementById('searchEtymologyBtn').addEventListener('click', () => {
                const searchTermOrthographic = wordSearchInput.value.trim();
                displayEtymologyForWord(searchTermOrthographic);
            });
        }

        function displayEtymologyForWord(orthographicWordName) {
            const resultsContainer = document.getElementById('etymologyResults');
            const evolutionChartContainer = document.getElementById('wordEvolutionChartEtymology');
            resultsContainer.innerHTML = ''; 
            evolutionChartContainer.innerHTML = ''; 

            const wordEntry = (currentLanguage.lexicon || []).find(w => w.word === orthographicWordName);

            if (!wordEntry) {
                resultsContainer.innerHTML = `<p class="text-red-500">ไม่พบคำว่า "${orthographicWordName}" (รูปอักขรวิธี) ในพจนานุกรม</p>`;
                evolutionChartContainer.innerHTML = '<p class="text-center text-gray-400">เลือกคำเพื่อดูผัง</p>';
                return;
            }

            const impliedPhonemic = orthographicToImpliedPhonemic(wordEntry.word);
            let resultHTML = `<h3 class="text-lg font-semibold" style="color: var(--link-color);">${wordEntry.word} <span class="text-sm text-gray-500">(${impliedPhonemic})</span></h3>`;

            if (wordEntry.etymology && ((wordEntry.etymology.roots && wordEntry.etymology.roots.length > 0) || (wordEntry.etymology.notes && wordEntry.etymology.notes.trim() !== ''))) {
                resultHTML += `<p class="text-sm text-gray-600"><strong>ความหมาย:</strong> ${wordEntry.meaning}</p>`;
                if (wordEntry.etymology.notes && wordEntry.etymology.notes.trim() !== '') {
                    resultHTML += `<p class="text-sm mt-1"><strong>หมายเหตุศัพทมูลวิทยา:</strong> ${wordEntry.etymology.notes}</p>`;
                }
                if (wordEntry.etymology.roots && wordEntry.etymology.roots.length > 0) {
                    resultHTML += `<h4 class="text-md font-medium mt-2" style="color: var(--section-title-color);">รากศัพท์ (Parents):</h4><ul class="list-disc list-inside ml-4 text-sm">`;
                    wordEntry.etymology.roots.forEach(root => {
                        if (root.wordId) {
                            const parentWord = (currentLanguage.lexicon || []).find(w => w.id === root.wordId);
                            resultHTML += `<li>มาจากคำว่า: <strong>${parentWord ? parentWord.word + ' (' + orthographicToImpliedPhonemic(parentWord.word) + ')' : 'คำที่ถูกลบ'}</strong></li>`;
                        } else if (root.customRoot) {
                            resultHTML += `<li>มาจาก: <strong>${root.customRoot}</strong> (ภาษา: ${root.sourceLang || 'ไม่ระบุ'})</li>`;
                        }
                    });
                    resultHTML += `</ul>`;
                }
            } else {
                resultHTML += `<p class="text-sm text-gray-500">ไม่มีข้อมูลรากศัพท์สำหรับคำนี้</p>`;
            }

            const childWords = (currentLanguage.lexicon || []).filter(w =>
                w.etymology && w.etymology.roots && w.etymology.roots.some(r => r.wordId === wordEntry.id)
            );
            if (childWords.length > 0) {
                 resultHTML += `<h4 class="text-md font-medium mt-2" style="color: var(--section-title-color);">คำสืบทอด (Children):</h4><ul class="list-disc list-inside ml-4 text-sm">`;
                 childWords.forEach(child => {
                     resultHTML += `<li><strong>${child.word} (${orthographicToImpliedPhonemic(child.word)})</strong> - ${child.meaning}</li>`;
                 });
                 resultHTML += `</ul>`;
            } else {
                 resultHTML += `<p class="text-sm text-gray-500 mt-1">ไม่มีคำสืบทอดโดยตรงจากคำนี้ในพจนานุกรม</p>`;
            }

            resultsContainer.innerHTML = resultHTML;

            const chart = buildEvolutionChart(wordEntry); 
            if (chart.hasChildNodes()) { 
                while (evolutionChartContainer.firstChild) { 
                    evolutionChartContainer.removeChild(evolutionChartContainer.firstChild);
                }
                evolutionChartContainer.appendChild(chart);
            } else {
                evolutionChartContainer.innerHTML = '<p class="text-center text-gray-400">คำนี้ไม่มีรากศัพท์ที่เชื่อมโยงในผัง</p>';
            }
        }


        function buildEvolutionChart(wordEntry, visited = new Set()) {
            if (!wordEntry || visited.has(wordEntry.id)) {
                const emptyUl = document.createElement('ul');
                if (wordEntry && visited.has(wordEntry.id)) { 
                     const li = document.createElement('li');
                     li.innerHTML = `<span class="pedigree-node italic text-xs">อ้างอิงซ้ำ: ${wordEntry.word}</span>`;
                     emptyUl.appendChild(li);
                }
                return emptyUl;
            }
            visited.add(wordEntry.id);

            const ul = document.createElement('ul');
            const li = document.createElement('li');
            const impliedPhonemic = orthographicToImpliedPhonemic(wordEntry.word);
            li.innerHTML = `<span class="pedigree-node font-semibold" title="Phonemic: ${impliedPhonemic}">${wordEntry.word}</span> <span class="text-xs text-gray-500">(${wordEntry.meaning})</span>`;

            if (wordEntry.etymology && wordEntry.etymology.roots && wordEntry.etymology.roots.length > 0) {
                const parentsUl = document.createElement('ul'); 
                wordEntry.etymology.roots.forEach(root => {
                    let parentBranchUl = null;
                    if (root.wordId) {
                        const parentWord = (currentLanguage.lexicon || []).find(w => w.id === root.wordId);
                        if (parentWord) {
                             parentBranchUl = buildEvolutionChart(parentWord, new Set(visited));
                        }
                    } else if (root.customRoot) { 
                        const customLi = document.createElement('li');
                        customLi.innerHTML = `<span class="pedigree-node text-sm"><i>${root.customRoot}</i> (${root.sourceLang || 'ไม่ระบุ'})</span>`;
                        parentBranchUl = document.createElement('ul'); 
                        parentBranchUl.appendChild(customLi);
                    }

                    if (parentBranchUl && parentBranchUl.hasChildNodes()) {
                         while(parentBranchUl.firstChild) {
                            parentsUl.appendChild(parentBranchUl.firstChild);
                         }
                    }
                });
                if (parentsUl.hasChildNodes()) {
                    li.appendChild(parentsUl); 
                }
            }
            ul.appendChild(li); 
            return ul;
        }

        function generateUUID() { 
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        function renderEvolutionUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'evolution').sectionClass);
            const existingSection = container.querySelector('.evolution-main-section');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'evolution-main-section p-3 border rounded-md space-y-4'; 
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const erasSection = document.createElement('div');
            erasSection.id = 'erasManagementSection'; 
            createListInput(erasSection, '🕰️ ยุคภาษา (Language Eras - เรียงจากเก่าสุดไปใหม่สุด)',
                currentLanguage.languageEras || [],
                "เช่น Proto-Elvish, Old Elvish",
                (item) => {
                    if (!currentLanguage.languageEras) currentLanguage.languageEras = [];
                    currentLanguage.languageEras.push(item);
                    renderEvolutionUI(tabContentContainer); saveData();
                },
                (index) => {
                    const eraToRemove = currentLanguage.languageEras[index];
                    currentLanguage.languageEras.splice(index, 1);
                    (currentLanguage.wordLineages || []).forEach(lineage => {
                        if (lineage.forms && lineage.forms[eraToRemove]) {
                            delete lineage.forms[eraToRemove];
                        }
                    });
                    renderEvolutionUI(tabContentContainer); saveData();
                },
                { tooltip: "กำหนดลำดับยุคของภาษาสำหรับการติดตามวิวัฒนาการคำ" }
            );
            section.appendChild(erasSection); 



            const lineagesSection = document.createElement('div');
            lineagesSection.innerHTML = `
                <h4 class="text-md font-semibold mt-4" style="color: var(--section-title-color);">สายวิวัฒนาการของคำ (Word Lineages)</h4>
                <button id="addNewLineageBtnEvolution" class="btn-primary py-1 px-3 rounded-md text-sm mb-2">➕ เพิ่มวิวัฒนาการคำ</button>
                <div id="wordLineagesList" class="space-y-3"></div>
            `;
            section.appendChild(lineagesSection);

            document.getElementById('addNewLineageBtnEvolution').addEventListener('click', handleAddNewWordLineage);
            renderWordLineagesList(); 
        }
        
        function handleAddNewWordLineage() {
            if (!currentLanguage.lexicon || currentLanguage.lexicon.length === 0) {
                alert("กรุณาเพิ่มคำศัพท์ในพจนานุกรมก่อน เพื่อเริ่มสายวิวัฒนาการ");
                return;
            }
            evolutionBaseWordSelect.innerHTML = '<option value="">-- เลือกคำศัพท์ --</option>';
            currentLanguage.lexicon.forEach(word => {
                const option = document.createElement('option');
                option.value = word.id;
                option.textContent = `${word.word} (${orthographicToImpliedPhonemic(word.word)}) - "${word.meaning.substring(0,30)}..."`;
                evolutionBaseWordSelect.appendChild(option);
            });
            evolutionLineageConceptName.value = ''; 
            selectWordForEvolutionModal.classList.remove('hidden');
        }

        function handleConfirmSelectWordForEvolution() {
            const selectedWordId = parseInt(evolutionBaseWordSelect.value);
            const conceptName = evolutionLineageConceptName.value.trim();

            if (!selectedWordId) {
                alert("กรุณาเลือกคำศัพท์ตั้งต้น");
                return;
            }

            const baseWordEntry = currentLanguage.lexicon.find(w => w.id === selectedWordId);
            if (!baseWordEntry) {
                alert("ไม่พบคำศัพท์ที่เลือก");
                return;
            }

            if (!currentLanguage.wordLineages) currentLanguage.wordLineages = [];

            const newLineage = {
                lineageId: generateUUID(),
                baseName: conceptName || baseWordEntry.word, 
                forms: {} 
            };

            if (currentLanguage.languageEras && currentLanguage.languageEras.length > 0) {
                const firstEraName = currentLanguage.languageEras[0];
                newLineage.forms[firstEraName] = {
                    orthographic: baseWordEntry.word,
                    phonemic_override: baseWordEntry.phonetics || orthographicToImpliedPhonemic(baseWordEntry.word), 
                    notes: `Initial form from lexicon entry: ${baseWordEntry.word}`,
                    linkedLexiconId: baseWordEntry.id
                };
            } else {
                 console.warn("No language eras defined. Cannot pre-fill first era form for new lineage.");
            }


            currentLanguage.wordLineages.push(newLineage);
            renderWordLineagesList();
            saveData();
            selectWordForEvolutionModal.classList.add('hidden');
        }


        function renderWordLineagesList() {
            const listContainer = document.getElementById('wordLineagesList');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            if (!currentLanguage.wordLineages || currentLanguage.wordLineages.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีสายวิวัฒนาการของคำ สร้างใหม่ได้เลย!</p>';
                return;
            }

            (currentLanguage.wordLineages || []).forEach((lineage, lineageIndex) => {
                const lineageDiv = document.createElement('div');
                lineageDiv.className = 'p-3 bg-white rounded shadow border'; 
                lineageDiv.style.borderColor = 'var(--border-color-light)';
                let lineageHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="text-lg font-medium" style="color: var(--link-color);">${lineage.baseName}</h5>
                        <button class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" onclick="deleteWordLineage(${lineageIndex})">ลบสายนี้</button>
                    </div>
                    <div class="lineage-container">`; 

                (currentLanguage.languageEras || []).forEach((eraName, eraIndex) => {
                    const form = lineage.forms[eraName] || { orthographic: '', phonemic_override: '', notes: '', linkedLexiconId: null };
                    const displayOrtho = form.orthographic;
                    const displayPhonemic = form.phonemic_override || orthographicToImpliedPhonemic(form.orthographic);
                    const linkedWord = form.linkedLexiconId ? currentLanguage.lexicon.find(w => w.id === form.linkedLexiconId) : null;

                    lineageHTML += `
                        <div class="lineage-era-node">
                            <strong class="block text-sm" style="color: var(--section-title-color);">${eraName}</strong>
                            <p class="text-md font-semibold my-1" title="รูปหน่วยเสียง: ${displayPhonemic || 'N/A'}">${displayOrtho || 'N/A'}</p>
                            ${linkedWord ? `<p class="text-xs text-blue-500" title="Linked to: ${linkedWord.word} - ${linkedWord.meaning}"><i class="fas fa-link"></i> ${linkedWord.word.substring(0,10)}...</p>` : ''}
                            <p class="text-xs text-gray-500 truncate" title="${form.notes || 'ไม่มีหมายเหตุ'}">${form.notes || '-'}</p>
                            <button class="text-xs btn-secondary mt-1" onclick="editLineageEraForm(${lineageIndex}, '${eraName.replace(/'/g, "\\'")}')">แก้ไข</button>
                        </div>
                    `;
                    if (eraIndex < (currentLanguage.languageEras || []).length - 1) { 
                        lineageHTML += `<span class="lineage-arrow fas fa-long-arrow-alt-right"></span>`;
                    }
                });
                lineageHTML += `</div>`; 
                lineageDiv.innerHTML = lineageHTML;
                listContainer.appendChild(lineageDiv);
            });
        }

        window.editLineageEraForm = (lineageIndex, eraName) => {
            const lineage = currentLanguage.wordLineages[lineageIndex];
            const currentForm = lineage.forms[eraName] || { orthographic: '', phonemic_override: '', notes: '', linkedLexiconId: null };

            const modalId = 'editLineageEraModal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal p-4';
            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-lg">
                    <h3 class="text-xl font-bold mb-4">แก้ไขรูปคำสำหรับ "${lineage.baseName}" ในยุค "${eraName}"</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium">รูปอักขรวิธี (Orthographic):</label>
                            <input type="text" id="lineageOrthographicInput" value="${currentForm.orthographic}" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">รูปหน่วยเสียง (Phonemic Override - หากไม่ใส่จะใช้ตามรูปอักขรวิธี):</label>
                            <input type="text" id="lineagePhonemicOverrideInput" value="${currentForm.phonemic_override}" class="w-full p-2 border rounded-md">
                        </div>
                         <div>
                            <label class="block text-sm font-medium">แสดงผลรูปหน่วยเสียงจริง:</label>
                            <p id="lineageActualPhonemicDisplay" class="w-full p-2 bg-gray-100 rounded-md min-h-[1.5em]"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">หมายเหตุ:</label>
                            <textarea id="lineageNotesInput" class="w-full p-2 border rounded-md" rows="2">${currentForm.notes}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">เชื่อมโยงกับคำในพจนานุกรม:</label>
                            <select id="lineageLinkLexiconSelect" class="w-full p-2 border rounded-md">
                                <option value="">-- ไม่เชื่อมโยง --</option>
                                ${ (currentLanguage.lexicon || []).map(w => `<option value="${w.id}" ${currentForm.linkedLexiconId === w.id ? 'selected' : ''}>${w.word} (${orthographicToImpliedPhonemic(w.word)}) - ${w.meaning.substring(0,20)}...</option>`).join('') }
                            </select>
                        </div>
                         <button id="lineageEvolveHelperBtn" class="btn-secondary text-sm w-full">คัดลอกจากยุคก่อนหน้า และใช้กฎการเปลี่ยนแปลงเสียง (ถ้ามี)</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="document.getElementById('${modalId}').remove()" class="btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">ยกเลิก</button>
                        <button id="saveLineageEraFormBtn" class="btn-primary px-4 py-2 rounded-md">บันทึก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const orthographicInput = modal.querySelector('#lineageOrthographicInput');
            const phonemicOverrideInput = modal.querySelector('#lineagePhonemicOverrideInput');
            const actualPhonemicDisplay = modal.querySelector('#lineageActualPhonemicDisplay');

            function updateActualPhonemicDisplay() {
                actualPhonemicDisplay.textContent = phonemicOverrideInput.value.trim() || orthographicToImpliedPhonemic(orthographicInput.value.trim()) || 'N/A';
            }
            orthographicInput.addEventListener('input', updateActualPhonemicDisplay);
            phonemicOverrideInput.addEventListener('input', updateActualPhonemicDisplay);
            updateActualPhonemicDisplay(); 


            modal.querySelector('#lineageEvolveHelperBtn').onclick = () => {
                const eraIndex = (currentLanguage.languageEras || []).indexOf(eraName);
                if (eraIndex > 0) {
                    const prevEraName = currentLanguage.languageEras[eraIndex - 1];
                    const prevForm = lineage.forms[prevEraName];
                    if (prevForm && prevForm.orthographic) { 
                        let phonemicToEvolve = prevForm.phonemic_override || orthographicToImpliedPhonemic(prevForm.orthographic);
                        
                        if (currentLanguage.soundChangeRules && currentLanguage.soundChangeRules.length > 0) {
                            currentLanguage.soundChangeRules.forEach(rule => {
                                let regexPattern = rule.from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                if (rule.contextBefore.endsWith('_')) regexPattern = `(?<=(${rule.contextBefore.slice(0,-1).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}))${regexPattern}`;
                                else if (rule.contextBefore) regexPattern = `(?<=(${rule.contextBefore.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}))${regexPattern}`;
                                
                                if (rule.contextAfter.startsWith('_')) regexPattern = `${regexPattern}(?=(${rule.contextAfter.slice(1).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}))`;
                                else if (rule.contextAfter) regexPattern = `${regexPattern}(?=(${rule.contextAfter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}))`;
                                
                                try {
                                    const regex = new RegExp(regexPattern, 'g');
                                    phonemicToEvolve = phonemicToEvolve.replace(regex, rule.to);
                                } catch (e) { console.warn("Sound change rule error in evolution helper:", e); }
                            });
                             alert("ใช้กฎการเปลี่ยนแปลงเสียงแล้ว (ถ้ามี). ผลลัพธ์: " + phonemicToEvolve);
                        } else {
                             alert("คัดลอกรูปคำจากยุคก่อนหน้าแล้ว ไม่มีกฎการเปลี่ยนแปลงเสียงให้ใช้.");
                        }

                        orthographicInput.value = phonemicToOrthographic(phonemicToEvolve); 
                        phonemicOverrideInput.value = ''; 
                        updateActualPhonemicDisplay();
                        modal.querySelector('#lineageNotesInput').value = (modal.querySelector('#lineageNotesInput').value || "") + ` Evolved from ${prevEraName}.`;

                    } else {
                        alert("ไม่พบรูปคำในยุคก่อนหน้า (" + prevEraName + ") หรือรูปคำว่างเปล่า");
                    }
                } else {
                    alert("นี่เป็นยุคแรกสุด ไม่มีรูปคำก่อนหน้าให้คัดลอก");
                }
            };


            modal.querySelector('#saveLineageEraFormBtn').onclick = () => {
                lineage.forms[eraName] = {
                    orthographic: orthographicInput.value.trim(),
                    phonemic_override: phonemicOverrideInput.value.trim(),
                    notes: modal.querySelector('#lineageNotesInput').value.trim(),
                    linkedLexiconId: modal.querySelector('#lineageLinkLexiconSelect').value ? parseInt(modal.querySelector('#lineageLinkLexiconSelect').value) : null
                };
                renderWordLineagesList();
                saveData();
                modal.remove();
            };
        };

        window.deleteWordLineage = (lineageIndex) => {
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบสายวิวัฒนาการ "${currentLanguage.wordLineages[lineageIndex].baseName}" ทั้งหมด?`)) {
                currentLanguage.wordLineages.splice(lineageIndex, 1);
                renderWordLineagesList();
                saveData();
            }
        };

        // --- DIALECTS ---
        function renderDialectsUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'dialects').sectionClass);
            const existingSection = container.querySelector('.dialects-main-section');
            if (existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'dialects-main-section p-3 border rounded-md space-y-4'; 
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            if (!currentLanguage.dialects) {
                currentLanguage.dialects = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.dialects));
            }
             if (!currentLanguage.dialects.regions || currentLanguage.dialects.regions.length === 0) { 
                currentLanguage.dialects.regions = [...DEFAULT_LANGUAGE_STATE.dialects.regions];
            }


            const enableDialectDiv = document.createElement('div');
            enableDialectDiv.className = 'flex items-center mb-3 p-2 bg-white rounded shadow-sm'; 
            const enableCheckbox = document.createElement('input');
            enableCheckbox.type = 'checkbox';
            enableCheckbox.id = 'enableDialectSystemCheckbox';
            enableCheckbox.className = 'mr-2 h-4 w-4 text-lime-600 border-gray-300 rounded focus:ring-lime-500';
            enableCheckbox.checked = currentLanguage.dialects.enabled;
            enableCheckbox.onchange = () => {
                currentLanguage.dialects.enabled = enableCheckbox.checked;
                saveData();
                renderDialectsUI(tabContentContainer); 
                if (activeTab === 'dictionary') { 
                    const currentSearchTerm = document.getElementById(`dictionarySearch_${(tabContentContainer.querySelector('[id^=dictionarySearch_]')||{}).id ? tabContentContainer.querySelector('[id^=dictionarySearch_]').id.split('_')[1] : Date.now()}`)?.value || '';
                    renderDictionaryTable(currentSearchTerm);
                }
                if (!wordDetailModal.classList.contains('hidden')) { 
                    const wordId = parseInt(wordDetailModal.dataset.wordId);
                    if(wordId) showWordDetailPopup(wordId);
                }
            };
            const enableLabel = document.createElement('label');
            enableLabel.htmlFor = 'enableDialectSystemCheckbox';
            enableLabel.className = 'text-sm font-medium';
            enableLabel.textContent = 'เปิดใช้งานระบบภาษาถิ่น (Enable Dialect System)';
            enableDialectDiv.appendChild(enableCheckbox);
            enableDialectDiv.appendChild(enableLabel);
            section.appendChild(enableDialectDiv);

            const dialectControlsContainer = document.createElement('div');
            dialectControlsContainer.id = 'dialectControlsContainer';
            dialectControlsContainer.className = currentLanguage.dialects.enabled ? 'space-y-4' : 'hidden space-y-4';
            section.appendChild(dialectControlsContainer);


            const regionsSectionContainer = document.createElement('div'); 
            regionsSectionContainer.id = 'dialectRegionsManagementContainer';
            dialectControlsContainer.appendChild(regionsSectionContainer);

            const baseRegionsDisplay = document.createElement('p');
            baseRegionsDisplay.className = 'text-xs text-gray-600 mt-1 ml-1 mb-2'; 
            baseRegionsDisplay.innerHTML = `<strong>ภูมิภาคพื้นฐาน:</strong> ${(currentLanguage.dialects.regions || []).join(', ')} (ไม่สามารถลบได้)`;
            regionsSectionContainer.appendChild(baseRegionsDisplay);

            createListInput(regionsSectionContainer, 'ภูมิภาคภาษาถิ่น (เพิ่มเติม - Custom Dialect Regions)',
                currentLanguage.dialects.customRegions || [],
                "เช่น ภาคกลางตอนบน, ภาษาถิ่นชาวเล",
                (item) => {
                    if (!currentLanguage.dialects.customRegions) currentLanguage.dialects.customRegions = [];
                    if (![...(currentLanguage.dialects.regions || []), ...currentLanguage.dialects.customRegions].includes(item)) {
                        currentLanguage.dialects.customRegions.push(item);
                    }
                    renderDialectsUI(tabContentContainer); saveData();
                },
                (index) => {
                    currentLanguage.dialects.customRegions.splice(index, 1);
                    renderDialectsUI(tabContentContainer); saveData();
                },
                { tooltip: "กำหนดภูมิภาคภาษาถิ่นเพิ่มเติม นอกจากภูมิภาคพื้นฐาน", subSectionTargetId: 'dialectRegionsManagementContainer' } 
            );


            const wordSelectionSection = document.createElement('div');
            wordSelectionSection.className = 'mt-4 p-3 bg-white rounded shadow'; 
            const wordSelectDatalistId = `dialectStdWordSearchDatalist_${Date.now()}`;
            wordSelectionSection.innerHTML = `
                <h4 class="text-md font-semibold mb-2" style="color: var(--section-title-color);">จัดการคำภาษาถิ่นสำหรับคำมาตรฐาน</h4>
                <label for="dialectStandardWordInput" class="block text-sm font-medium text-gray-700">เลือกคำมาตรฐาน (รูปอักขรวิธี):</label>
                <div class="flex gap-2 items-center">
                    <input type="text" id="dialectStandardWordInput" list="${wordSelectDatalistId}" placeholder="พิมพ์เพื่อค้นหารูปอักขรวิธี..." class="flex-grow p-2 border rounded-md">
                    <datalist id="${wordSelectDatalistId}"></datalist>
                    <button id="showDialectFormsForWordBtn" class="btn-primary px-3 py-2 rounded-md text-sm whitespace-nowrap">แสดง/แก้ไขคำถิ่น</button>
                </div>
                <div id="selectedWordDialectFormsContainer" class="mt-3 min-h-[100px] p-2 border rounded bg-lime-50">
                    <p class="text-center text-sm text-gray-500">กรุณาเลือกคำมาตรฐานและกดปุ่ม "แสดง/แก้ไขคำถิ่น"</p>
                </div>
            `;
            dialectControlsContainer.appendChild(wordSelectionSection);

            const stdWordDatalist = dialectControlsContainer.querySelector(`#${wordSelectDatalistId}`);
             if (stdWordDatalist) {
                (currentLanguage.lexicon || []).forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.word; 
                    option.label = `${w.word} (${orthographicToImpliedPhonemic(w.word)}) - ${w.meaning.substring(0, 30)}...`;
                    stdWordDatalist.appendChild(option);
                });
            }


            const showDialectFormsBtn = dialectControlsContainer.querySelector('#showDialectFormsForWordBtn');
            if (showDialectFormsBtn) {
                showDialectFormsBtn.addEventListener('click', () => {
                    const orthographicWord = dialectControlsContainer.querySelector('#dialectStandardWordInput').value.trim();
                    const standardWord = (currentLanguage.lexicon || []).find(w => w.word === orthographicWord); 
                    const formsContainer = document.getElementById('selectedWordDialectFormsContainer');

                    if (standardWord && formsContainer) {
                        renderDialectFormsForStandardWord(standardWord.id, formsContainer);
                    } else if (formsContainer) {
                        alert("ไม่พบคำมาตรฐานนี้ในพจนานุกรม (กรุณาเลือกจากรายการที่มีให้)");
                        formsContainer.innerHTML = '<p class="text-center text-sm text-red-500">ไม่พบคำมาตรฐานที่ระบุ</p>';
                    }
                });
            }
        }

        function getAllDialectRegions() {
            return [...(currentLanguage.dialects.regions || DEFAULT_BASE_DIALECT_REGIONS), ...(currentLanguage.dialects.customRegions || [])];
        }

        function renderDialectFormsForStandardWord(standardWordId, targetDisplayContainer) {
            const container = targetDisplayContainer || document.getElementById('selectedWordDialectFormsContainer');
            if (!container) return;

            const standardWord = (currentLanguage.lexicon || []).find(w => w.id === standardWordId);
            if (!standardWord) {
                container.innerHTML = '<p class="text-center text-sm text-red-500">เกิดข้อผิดพลาด: ไม่พบคำมาตรฐาน</p>';
                return;
            }
            const impliedPhonemicStd = orthographicToImpliedPhonemic(standardWord.word);

            if (container.id === 'selectedWordDialectFormsContainer') { 
                container.innerHTML = `
                    <h5 class="text-md font-semibold text-lime-800 mb-2">
                        คำถิ่นสำหรับ: <strong class="text-purple-600">${standardWord.word}</strong>
                        <span class="text-sm text-gray-600">(${impliedPhonemicStd} - "${standardWord.meaning}")</span>
                    </h5>
                    <div id="dialectFormsTableContainerInTab" class="overflow-x-auto"></div>
                    <button class="btn-secondary bg-lime-400 hover:bg-lime-500 px-3 py-1 rounded-md text-xs mt-3" onclick="showDialectWordFormModal(${standardWord.id})">
                        <i class="fas fa-plus-circle mr-1"></i> เพิ่มรูปคำภาษาถิ่นใหม่
                    </button>
                `;
            } else { 
                container.innerHTML = `<div id="dialectFormsTableContainerInModal" class="overflow-x-auto"></div>`;
            }

            const tableContainer = container.querySelector("#dialectFormsTableContainerInTab, #dialectFormsTableContainerInModal"); 
            if (!tableContainer) return;
            tableContainer.innerHTML = '';

            const allRegions = getAllDialectRegions();
            const existingDialectForms = (currentLanguage.dialects.dialectWords || []).filter(dw => dw.standardWordId === standardWordId);

            if (allRegions.length === 0 && existingDialectForms.length === 0 && container.id === 'selectedWordDialectFormsContainer') {
                tableContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีการกำหนดภูมิภาค หรือยังไม่มีรูปคำภาษาถิ่นสำหรับคำนี้</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y bg-white shadow-sm rounded-lg text-sm'; 
            table.style.backgroundColor = 'var(--card-bg-color)';
            table.style.borderColor = 'var(--border-color-medium)';
            table.innerHTML = `
                <thead style="background-color: var(--list-input-section-bg);">
                    <tr>
                        <th class="px-3 py-2 text-left font-medium" style="color: var(--list-input-label-color);">ภูมิภาค</th>
                        <th class="px-3 py-2 text-left font-medium" style="color: var(--list-input-label-color);">รูปอักขรวิธีถิ่น</th>
                        <th class="px-3 py-2 text-left font-medium hidden md:table-cell" style="color: var(--list-input-label-color);">รูปหน่วยเสียงถิ่น</th>
                        <th class="px-3 py-2 text-left font-medium hidden lg:table-cell" style="color: var(--list-input-label-color);">IPA ถิ่น</th>
                        <th class="px-3 py-2 text-left font-medium" style="color: var(--list-input-label-color);">ความหมายถิ่น</th>
                        <th class="px-3 py-2 text-left font-medium hidden lg:table-cell" style="color: var(--list-input-label-color);">หมายเหตุ</th>
                        <th class="px-3 py-2 text-left font-medium" style="color: var(--list-input-label-color);">จัดการ</th>
                    </tr>
                </thead>
                <tbody class="divide-y" style="border-color: var(--border-color-light);"></tbody>
            `;
            const tbody = table.querySelector('tbody');

            allRegions.forEach(region => {
                const dialectWordEntry = existingDialectForms.find(dw => dw.region === region);
                const row = tbody.insertRow();
                row.style.borderColor = 'var(--border-color-light)';

                let cellsHTML = `<td class="px-3 py-2 whitespace-nowrap">${region}</td>`;
                if (dialectWordEntry) {
                    const displayDialectOrtho = dialectWordEntry.dialectOrthographic || phonemicToOrthographic(dialectWordEntry.dialectPhonetic);
                    cellsHTML += `
                        <td class="px-3 py-2 whitespace-nowrap font-semibold">${displayDialectOrtho}</td>
                        <td class="px-3 py-2 whitespace-nowrap hidden md:table-cell">${dialectWordEntry.dialectPhonetic}</td>
                        <td class="px-3 py-2 whitespace-nowrap hidden lg:table-cell">${dialectWordEntry.dialectPhoneticsIPA || generateSimpleIPA(dialectWordEntry.dialectPhonetic)}</td>
                        <td class="px-3 py-2">${dialectWordEntry.dialectMeaning || '<span class="text-xs text-gray-400">(เหมือนมาตรฐาน)</span>'}</td>
                        <td class="px-3 py-2 hidden lg:table-cell">${dialectWordEntry.notes || '-'}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button class="text-blue-500 hover:text-blue-700 mr-1 text-xs" onclick="showDialectWordFormModal(${standardWordId}, '${region.replace(/'/g, "\\'")}')"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700 text-xs" onclick="deleteDialectWordForm(${standardWordId}, '${region.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                } else {
                    cellsHTML += `
                        <td class="px-3 py-2 text-gray-400 italic" colspan="5">(ยังไม่มีรูปคำสำหรับภูมิภาคนี้)</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button class="text-green-500 hover:text-green-700 text-xs" onclick="showDialectWordFormModal(${standardWordId}, null, '${region.replace(/'/g, "\\'")}')"><i class="fas fa-plus"></i> เพิ่ม</button>
                        </td>
                    `;
                }
                row.innerHTML = cellsHTML;
            });
            tableContainer.appendChild(table);
        }

        function showWordDialectFormsPopup(standardWordId) {
            const standardWord = (currentLanguage.lexicon || []).find(w => w.id === standardWordId);
            if (!standardWord) return;

            wordDialectFormsModal.dataset.standardWordId = standardWordId;
            wordDialectFormsTitle.textContent = `คำถิ่นสำหรับ: ${standardWord.word}`;
            wordDialectFormsTitle.style.color = "var(--link-color)";
            renderDialectFormsForStandardWord(standardWordId, wordDialectFormsContent);
            wordDialectFormsModal.classList.remove('hidden');
        }


        window.showDialectWordFormModal = (standardWordId, regionToEdit = null, regionForNew = null) => {
            const standardWord = (currentLanguage.lexicon || []).find(w => w.id === standardWordId);
            if (!standardWord) {
                alert("Error: Standard word not found.");
                return;
            }

            let existingDialectWord = null;
            if (regionToEdit) {
                existingDialectWord = (currentLanguage.dialects.dialectWords || []).find(
                    dw => dw.standardWordId === standardWordId && dw.region === regionToEdit
                );
            }

            const modalId = 'dialectWordFormModalMainEdit';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-[70] flex items-center justify-center modal p-4';

            const selectedRegion = regionToEdit || regionForNew || getAllDialectRegions()[0] || '';
            const isEditing = !!regionToEdit;

            const initialPhonetic = existingDialectWord ? existingDialectWord.dialectPhonetic : orthographicToImpliedPhonemic(standardWord.word);
            const initialOrthographic = existingDialectWord ? existingDialectWord.dialectOrthographic : ''; 
            const initialIPA = existingDialectWord ? existingDialectWord.dialectPhoneticsIPA : generateSimpleIPA(initialPhonetic);
            const initialMeaning = existingDialectWord ? existingDialectWord.dialectMeaning : ''; 
            const initialNotes = existingDialectWord ? existingDialectWord.notes : '';


            modal.innerHTML = `
                <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4" style="color: var(--list-input-label-color);">${isEditing ? 'แก้ไข' : 'เพิ่ม'}คำถิ่นสำหรับ "${standardWord.word}"</h3>
                    <div class="space-y-3 text-sm">
                        <div>
                            <label class="block font-medium">ภูมิภาค (Region):</label>
                            <select id="modalDialectRegionMainEdit" class="w-full p-2 border rounded-md bg-gray-50" ${isEditing ? 'disabled' : ''}>
                                ${getAllDialectRegions().map(r => `<option value="${r}" ${selectedRegion === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium">รูปหน่วยเสียงถิ่น (Dialect Phonemic Form):</label>
                            <input type="text" id="modalDialectPhoneticMainEdit" value="${initialPhonetic}" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label class="block font-medium">รูปอักขรวิธีถิ่น (Dialect Orthography - ถ้าไม่ใส่จะใช้ตามรูปหน่วยเสียงถิ่น):</label>
                            <input type="text" id="modalDialectOrthographicMainEdit" value="${initialOrthographic}" class="w-full p-2 border rounded-md">
                            <p id="modalDialectOrthographicDisplayMainEdit" class="text-xs p-1 bg-gray-100 rounded mt-1 min-h-[1.5em]"></p>
                        </div>
                        <div>
                            <label class="block font-medium">IPA ถิ่น (Dialect IPA - ถ้ามี):</label>
                             <div class="flex">
                                <input type="text" id="modalDialectIPAMainEdit" value="${initialIPA}" class="w-full p-2 border rounded-md rounded-r-none">
                                <button id="autoGenDialectIPABtnMainEdit" title="สร้าง IPA อัตโนมัติ (พื้นฐาน)" class="btn-secondary p-2 rounded-l-none"><i class="fas fa-magic"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-medium">ความหมายถิ่น (Dialect Meaning - ถ้าไม่ใส่จะเหมือนคำมาตรฐาน):</label>
                            <input type="text" id="modalDialectMeaningMainEdit" value="${initialMeaning}" class="w-full p-2 border rounded-md" placeholder="${standardWord.meaning}">
                        </div>
                        <div>
                            <label class="block font-medium">หมายเหตุ (Notes):</label>
                            <textarea id="modalDialectNotesMainEdit" class="w-full p-2 border rounded-md" rows="2">${initialNotes}</textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="document.getElementById('${modalId}').remove()" class="btn-secondary bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md text-sm">ยกเลิก</button>
                        <button id="saveDialectWordFormBtnMainEdit" class="btn-primary bg-lime-600 hover:bg-lime-700 px-4 py-2 rounded-md text-sm">บันทึก</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const phoneticInput = modal.querySelector('#modalDialectPhoneticMainEdit');
            const orthographicInput = modal.querySelector('#modalDialectOrthographicMainEdit');
            const orthographicDisplay = modal.querySelector('#modalDialectOrthographicDisplayMainEdit');

            function updateDialectOrthoDisplay() {
                const phoneticVal = phoneticInput.value.trim();
                const orthoVal = orthographicInput.value.trim();
                orthographicDisplay.textContent = orthoVal || phonemicToOrthographic(phoneticVal) || 'N/A';
            }
            phoneticInput.addEventListener('input', updateDialectOrthoDisplay);
            orthographicInput.addEventListener('input', updateDialectOrthoDisplay);
            updateDialectOrthoDisplay(); 

            modal.querySelector('#autoGenDialectIPABtnMainEdit').addEventListener('click', () => {
                const dialectPhonemic = modal.querySelector('#modalDialectPhoneticMainEdit').value.trim();
                modal.querySelector('#modalDialectIPAMainEdit').value = generateSimpleIPA(dialectPhonemic);
            });


            modal.querySelector('#saveDialectWordFormBtnMainEdit').onclick = () => {
                const region = modal.querySelector('#modalDialectRegionMainEdit').value;
                const dialectPhonetic = modal.querySelector('#modalDialectPhoneticMainEdit').value.trim();
                const dialectOrthographic = modal.querySelector('#modalDialectOrthographicMainEdit').value.trim();
                const dialectPhoneticsIPA = modal.querySelector('#modalDialectIPAMainEdit').value.trim();
                const dialectMeaning = modal.querySelector('#modalDialectMeaningMainEdit').value.trim();
                const notes = modal.querySelector('#modalDialectNotesMainEdit').value.trim();

                if (!region || !dialectPhonetic) {
                    alert("กรุณาระบุภูมิภาคและรูปหน่วยเสียงถิ่น");
                    return;
                }

                if (!currentLanguage.dialects.dialectWords) {
                    currentLanguage.dialects.dialectWords = [];
                }

                const existingIndex = currentLanguage.dialects.dialectWords.findIndex(
                    dw => dw.standardWordId === standardWordId && dw.region === region
                );

                const newDialectEntry = {
                    standardWordId,
                    region,
                    dialectPhonetic,
                    dialectOrthographic: dialectOrthographic || phonemicToOrthographic(dialectPhonetic), 
                    dialectPhoneticsIPA: dialectPhoneticsIPA || generateSimpleIPA(dialectPhonetic), 
                    dialectMeaning,
                    notes
                };

                if (existingIndex > -1) {
                    currentLanguage.dialects.dialectWords[existingIndex] = newDialectEntry;
                } else {
                    currentLanguage.dialects.dialectWords.push(newDialectEntry);
                }

                saveData();
                if (activeTab === 'dialects' && document.getElementById('selectedWordDialectFormsContainer')) {
                     renderDialectFormsForStandardWord(standardWordId, document.getElementById('selectedWordDialectFormsContainer'));
                }
                if (!wordDialectFormsModal.classList.contains('hidden')) { 
                    renderDialectFormsForStandardWord(standardWordId, wordDialectFormsContent);
                }
                if (!wordDetailModal.classList.contains('hidden') && parseInt(wordDetailModal.dataset.wordId) === standardWordId) {
                    showWordDetailPopup(standardWordId); 
                }
                modal.remove();
            };
        };

        window.deleteDialectWordForm = (standardWordId, region) => {
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบรูปคำภาษาถิ่นสำหรับภูมิภาค "${region}"?`)) {
                if (currentLanguage.dialects.dialectWords) {
                    currentLanguage.dialects.dialectWords = currentLanguage.dialects.dialectWords.filter(
                        dw => !(dw.standardWordId === standardWordId && dw.region === region)
                    );
                    saveData();
                    if (activeTab === 'dialects' && document.getElementById('selectedWordDialectFormsContainer')) {
                        renderDialectFormsForStandardWord(standardWordId, document.getElementById('selectedWordDialectFormsContainer'));
                    }
                    if (!wordDialectFormsModal.classList.contains('hidden')) {
                         renderDialectFormsForStandardWord(standardWordId, wordDialectFormsContent);
                    }
                    if (!wordDetailModal.classList.contains('hidden') && parseInt(wordDetailModal.dataset.wordId) === standardWordId) {
                         showWordDetailPopup(standardWordId);
                    }
                }
            }
        };


        function showWordEvolutionLineagePopup(lineageId, baseWordOrtho) {
            const lineage = (currentLanguage.wordLineages || []).find(l => l.lineageId === lineageId);
            if (!lineage) {
                alert("ไม่พบสายวิวัฒนาการนี้");
                return;
            }

            wordEvolutionDisplayTitle.textContent = `สายวิวัฒนาการของ: ${baseWordOrtho} (แนวคิด: ${lineage.baseName})`;
            wordEvolutionDisplayTitle.style.color = "var(--link-color)";
            wordEvolutionDisplayContent.innerHTML = '';

            (currentLanguage.languageEras || []).forEach((eraName, eraIndex) => {
                const form = lineage.forms[eraName] || { orthographic: '', phonemic_override: '', notes: '' };
                const displayOrtho = form.orthographic;
                const displayPhonemic = form.phonemic_override || orthographicToImpliedPhonemic(form.orthographic);

                const eraNodeDiv = document.createElement('div');
                eraNodeDiv.className = 'lineage-era-node'; 
                eraNodeDiv.innerHTML = `
                    <strong class="block text-sm" style="color: var(--section-title-color);">${eraName}</strong>
                    <p class="text-md font-semibold my-1" title="รูปหน่วยเสียง: ${displayPhonemic || 'N/A'}">${displayOrtho || 'N/A'}</p>
                    <p class="text-xs text-gray-500 truncate" title="${form.notes || 'ไม่มีหมายเหตุ'}">${form.notes || '-'}</p>
                `;
                wordEvolutionDisplayContent.appendChild(eraNodeDiv);

                if (eraIndex < (currentLanguage.languageEras || []).length - 1) {
                    const arrowSpan = document.createElement('span');
                    arrowSpan.className = 'lineage-arrow fas fa-long-arrow-alt-right'; 
                    wordEvolutionDisplayContent.appendChild(arrowSpan);
                }
            });
            wordEvolutionDisplayModal.classList.remove('hidden');
        }



        function renderSentenceGeneratorUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'sentenceGen').sectionClass);
            const existingSection = container.querySelector('.sentence-gen-main-section');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'sentence-gen-main-section p-3 border rounded-md space-y-4'; 
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            const currentDefinedStructure = currentLanguage.grammar.sentenceStructure || 'SVO';
            const sentenceStructures = [
                'SVO', 'SOV', 'VSO', 'VOS', 'OSV', 'OVS', 'FREE', currentDefinedStructure
            ].filter((v, i, a) => a.indexOf(v) === i && v); 


            let sentenceStructureOptions = '';
            sentenceStructures.forEach(s => {
                 sentenceStructureOptions += `<option value="${s}" ${s === currentDefinedStructure ? 'selected' : ''}>${s}</option>`;
            });


            section.innerHTML = `
                <div>
                    <label for="sentenceStructureGenSelect" class="block text-sm font-medium">เลือกโครงสร้างประโยค:</label>
                    <select id="sentenceStructureGenSelect" class="w-full p-2 border rounded-md mb-2">
                        ${sentenceStructureOptions}
                    </select>
                </div>
                <button id="generateSentenceButton" class="btn-primary py-2 px-4 rounded-md">สร้างประโยค 🎲</button>
                <div class="mt-4">
                    <h4 class="font-semibold">ประโยคภาษา <span style="color: var(--link-color);">${currentLanguage.name || ''}</span>:</h4>
                    <textarea id="generatedConlangSentence" class="w-full p-2 border rounded-md" rows="2" placeholder="ประโยคที่สร้าง..."></textarea>
                </div>
                <div>
                    <h4 class="font-semibold">คำแปลภาษาไทย (โดยประมาณ):</h4>
                    <textarea id="generatedThaiTranslation" class="w-full p-2 border rounded-md" rows="2" placeholder="คำแปลภาษาไทย..."></textarea>
                </div>
                <button id="saveSentenceAsExampleBtn" class="btn-secondary py-1 px-3 rounded-md text-sm">บันทึกเป็นตัวอย่าง (ของคำแรก)</button>
                <div id="exampleSentencesList" class="mt-3 p-2 bg-white rounded shadow">
                     <h5 class="text-sm font-semibold">คลังประโยคตัวอย่าง:</h5>
                     <ul class="list-disc list-inside text-xs">
                        ${(currentLanguage.exampleSentences || []).map(ex => `<li>${ex.conlang} <span class="text-gray-500">- "${ex.translation}"</span></li>`).join('')}
                     </ul>
                </div>
            `;

            document.getElementById('generateSentenceButton').addEventListener('click', handleGenerateSentence);
            document.getElementById('saveSentenceAsExampleBtn').addEventListener('click', handleSaveSentenceAsExample);
        }

        function handleGenerateSentence() {
            const structure = document.getElementById('sentenceStructureGenSelect').value;
            if (!structure) {
                alert("กรุณาเลือกโครงสร้างประโยค");
                return;
            }

            const conlangSentenceEl = document.getElementById('generatedConlangSentence');
            const thaiTranslationEl = document.getElementById('generatedThaiTranslation');
            conlangSentenceEl.value = "";
            thaiTranslationEl.value = "";

            let conlangParts = [];
            let thaiParts = [];
            let firstContentWordId = null;


            const getWordByPOS = (targetPOS) => {
                const eligibleWords = (currentLanguage.lexicon || []).filter(w => w.partOfSpeech === targetPOS);
                if (eligibleWords.length > 0) {
                    return eligibleWords[Math.floor(Math.random() * eligibleWords.length)];
                }
                return null;
            };

            for (const part of structure) { 
                let wordEntry = null;
                let posToFind = '';
                switch (part.toUpperCase()) {
                    case 'S': posToFind = 'คำนาม'; break; 
                    case 'V': posToFind = 'คำกริยา'; break;
                    case 'O': posToFind = 'คำนาม'; break; 
                    default:
                        if (getPartsOfSpeech().includes(part)) {
                            posToFind = part;
                        }
                        break;
                }

                if (posToFind) {
                    if (posToFind === 'คำนาม' && Math.random() < 0.3) { 
                        wordEntry = getWordByPOS('คำสรรพนาม') || getWordByPOS('คำนาม'); 
                    } else {
                        wordEntry = getWordByPOS(posToFind);
                    }
                }

                if (wordEntry) {
                    conlangParts.push(wordEntry.word);
                    thaiParts.push(wordEntry.meaning.split(/[,;]/)[0].trim()); 
                    if (!firstContentWordId && (posToFind === 'คำนาม' || posToFind === 'คำกริยา' || posToFind === 'คำสรรพนาม')) {
                        firstContentWordId = wordEntry.id;
                    }
                } else { 
                    conlangParts.push(`(${part}?)`);
                    thaiParts.push(`(${part}?)`);
                }
            }

            conlangSentenceEl.value = conlangParts.join(' ');
            thaiTranslationEl.value = thaiParts.join(' ');
            document.getElementById('saveSentenceAsExampleBtn').dataset.firstWordId = firstContentWordId || '';
        }

        function handleSaveSentenceAsExample() {
            const conlangSentence = document.getElementById('generatedConlangSentence').value.trim();
            const thaiTranslation = document.getElementById('generatedThaiTranslation').value.trim();
            const firstWordId = parseInt(document.getElementById('saveSentenceAsExampleBtn').dataset.firstWordId);


            if (!conlangSentence) {
                alert("ไม่มีประโยคให้บันทึก");
                return;
            }

            if (!currentLanguage.exampleSentences) {
                currentLanguage.exampleSentences = [];
            }
            currentLanguage.exampleSentences.push({ conlang: conlangSentence, translation: thaiTranslation, relatedWordId: firstWordId || null });

            if (firstWordId) {
                const wordIndex = (currentLanguage.lexicon || []).findIndex(w => w.id === firstWordId);
                if (wordIndex > -1) {
                    if (!currentLanguage.lexicon[wordIndex].example) {
                        currentLanguage.lexicon[wordIndex].example = conlangSentence;
                    } else { 
                        currentLanguage.lexicon[wordIndex].example += `\n// ${conlangSentence}`;
                    }
                }
            }

            saveData();
            renderSentenceGeneratorUI(tabContentContainer); 
            alert("บันทึกประโยคตัวอย่างแล้ว");
        }


        function renderLangFamilyUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'langFamily').sectionClass);
            const existingSection = container.querySelector('.lang-family-main-section');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'lang-family-main-section p-3 border rounded-md space-y-4'; 
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            currentLanguage.info = currentLanguage.info || JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.info));


            section.innerHTML = `
                <p class="text-sm text-gray-600">ส่วนนี้แสดงรายการภาษาทั้งหมดที่คุณได้สร้างขึ้น และสามารถกำหนดความสัมพันธ์ระหว่างภาษาได้ (เบื้องต้น)</p>
                <div class="mb-4">
                    <label for="parentLangSelect" class="block text-sm font-medium">กำหนดภาษาแม่สำหรับ <strong style="color: var(--link-color);">${currentLanguage.name || 'ภาษานี้'}</strong>:</label>
                    <select id="parentLangSelect" class="w-full p-2 border rounded-md">
                        <option value="">-- ไม่มีภาษาแม่ --</option>
                    </select>
                </div>
                <div>
                    <h4 class="font-semibold">รายการภาษาที่สร้างแล้ว (คลิกเพื่อสลับ):</h4>
                    <div id="createdLangListContainer" class="max-h-60 overflow-y-auto bg-white p-2 rounded shadow"></div>
                </div>
                <h4 class="font-semibold pt-2 border-t">ผังตระกูลภาษา (เบื้องต้น):</h4>
                 <div id="langFamilyTreeContainer" class="pedigree-chart p-2 bg-white rounded-md shadow min-h-[150px] overflow-auto">
                    <p class="text-center text-gray-400">ผังจะแสดงเมื่อมีการกำหนดภาษาแม่</p>
                </div>
            `;


            const parentLangSelect = document.getElementById('parentLangSelect');
            allLanguages.forEach(lang => {
                if (lang.name !== currentLanguage.name) { 
                    const option = document.createElement('option');
                    option.value = lang.name;
                    option.textContent = lang.name;
                    if (currentLanguage.info && currentLanguage.info.parentLanguageName === lang.name) {
                        option.selected = true;
                    }
                    parentLangSelect.appendChild(option);
                }
            });
            parentLangSelect.addEventListener('change', (e) => {
                if (!currentLanguage.info) currentLanguage.info = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.info));
                currentLanguage.info.parentLanguageName = e.target.value || null; 
                saveData();
                renderLangFamilyTree(); 
            });

            renderCreatedLanguageListForFamilyTab();
            renderLangFamilyTree();
        }

        function renderCreatedLanguageListForFamilyTab() {
            const listContainer = document.getElementById('createdLangListContainer');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            if (allLanguages.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center">ยังไม่มีภาษาที่สร้างไว้</p>';
                return;
            }
            const ul = document.createElement('ul');
            ul.className = 'list-none';
            allLanguages.forEach((lang) => {
                const li = document.createElement('li');
                li.className = 'p-1 mb-1 text-sm';
                const langDisplayName = lang.name;
                li.innerHTML = `<span class="pedigree-node cursor-pointer hover:bg-purple-200" onclick="switchToLanguageFromFamilyView('${lang.name.replace(/'/g, "\\'")}')">${langDisplayName} ${lang.name === currentLanguage.name ? '<i class="fas fa-check-circle text-green-500 ml-1"></i>' : ''}</span>`;
                ul.appendChild(li);
            });
            listContainer.appendChild(ul);
        }

        function renderLangFamilyTree() {
            const container = document.getElementById('langFamilyTreeContainer');
            if (!container) return;
            container.innerHTML = ''; 

            const roots = allLanguages.filter(lang =>
                !lang.info || !lang.info.parentLanguageName || !allLanguages.find(p => p.name === lang.info.parentLanguageName)
            );

            if (roots.length === 0 && allLanguages.length > 0) {
                 let renderedInTree = new Set();
                 allLanguages.forEach(lang => {
                    if (!renderedInTree.has(lang.name)) { 
                        let currentRootCandidate = lang;
                        let path = new Set([currentRootCandidate.name]); 
                        while(currentRootCandidate.info && currentRootCandidate.info.parentLanguageName) {
                            const parent = allLanguages.find(p => p.name === currentRootCandidate.info.parentLanguageName);
                            if (!parent || path.has(parent.name)) break; 
                            currentRootCandidate = parent;
                            path.add(currentRootCandidate.name);
                        }
                        if (!renderedInTree.has(currentRootCandidate.name)) {
                             container.appendChild(buildLangNode(currentRootCandidate, new Set(), renderedInTree));
                        }
                    }
                 });
                 if(container.innerHTML === '') container.innerHTML = "<p class='text-xs text-orange-500'>ไม่สามารถสร้างผังได้ อาจมีโครงสร้างแบบวนซ้ำ หรือไม่มีภาษาที่เป็นรากฐานชัดเจน</p>";


            } else if (roots.length === 0) { 
                 container.innerHTML = '<p class="text-center text-gray-400">ยังไม่มีภาษา หรือยังไม่ได้กำหนดความสัมพันธ์</p>';
                 return;
            } else { 
                let renderedInTreeGlobal = new Set(); 
                roots.forEach(rootLang => {
                    container.appendChild(buildLangNode(rootLang, new Set(), renderedInTreeGlobal));
                });
            }
        }

        function buildLangNode(lang, visitedThisBranch, alreadyRenderedGlobally) {
            if (!lang) return document.createElement('ul'); 

            if (visitedThisBranch.has(lang.name)) { 
                const li = document.createElement('li');
                li.innerHTML = `<span class="pedigree-node italic text-xs">วงจร: ${lang.name}</span>`;
                const ul = document.createElement('ul'); ul.appendChild(li); return ul;
            }
             if (alreadyRenderedGlobally.has(lang.name) && visitedThisBranch.size !== 0 ) {
                return document.createElement('ul'); 
             }

            visitedThisBranch.add(lang.name);
            alreadyRenderedGlobally.add(lang.name);


            const ul = document.createElement('ul');
            const li = document.createElement('li');
            const langDisplayName = lang.name;
            li.innerHTML = `<span class="pedigree-node ${lang.name === currentLanguage.name ? 'font-bold border-purple-500 ring-2 ring-purple-300' : ''}">${langDisplayName}</span>`;

            const children = allLanguages.filter(childLang => childLang.info && childLang.info.parentLanguageName === lang.name);
            if (children.length > 0) {
                const childrenUl = document.createElement('ul'); 
                children.forEach(child => {
                    const childNodeUl = buildLangNode(child, new Set(visitedThisBranch), alreadyRenderedGlobally); 
                    if (childNodeUl.firstChild) { 
                        childrenUl.appendChild(childNodeUl.firstChild);
                    }
                });
                 if (childrenUl.hasChildNodes()) {
                    li.appendChild(childrenUl);
                }
            }
            ul.appendChild(li);
            return ul;
        }


        window.switchToLanguageFromFamilyView = (langName) => {
            if (languageSelector) {
                saveData();
                switchLanguage(langName);
            }
        };

        function renderSoundChangeUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'soundChange').sectionClass);
            const existingSection = container.querySelector('.sound-change-main-section');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'sound-change-main-section p-3 border rounded-md space-y-4'; 
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            if (!currentLanguage.soundChangeRules) { 
                currentLanguage.soundChangeRules = [];
            }


            let currentLangOption = `<option value="${currentLanguage.name}">${currentLanguage.name} (Current)</option>`;
            let sourceLangOptions = currentLangOption + allLanguages.filter(l => l.name !== currentLanguage.name).map(l => `<option value="${l.name}">${l.name}</option>`).join('');
            let targetLangOptions = allLanguages.map(l => `<option value="${l.name}">${l.name}</option>`).join('');


            section.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="soundChangeSourceLang" class="block text-sm font-medium">ภาษาต้นทาง (Source Language):</label>
                        <select id="soundChangeSourceLang" class="w-full p-2 border rounded-md">
                            <option value="">-- เลือกภาษาต้นทาง (ใช้ภาษาปัจจุบันหากว่าง) --</option>
                            ${sourceLangOptions}
                        </select>
                    </div>
                    <div>
                        <label for="soundChangeTargetLang" class="block text-sm font-medium">ภาษาปลายทาง (Target Language):</label>
                        <select id="soundChangeTargetLang" class="w-full p-2 border rounded-md">
                             <option value="">-- เลือกภาษาปลายทาง --</option>
                            ${targetLangOptions}
                        </select>
                    </div>
                </div>

                <h4 class="font-semibold">กำหนดกฎการเปลี่ยนแปลง (ใช้กับภาษาปัจจุบัน):</h4>
                <div id="soundChangeRuleDefinition" class="space-y-2 p-2 bg-white rounded shadow">
                    <div class="flex flex-wrap gap-2 items-end">
                        <div class="flex-grow min-w-[80px]"><label class="text-xs">จาก (From):</label><input type="text" id="scFrom" placeholder="p, t, a" class="w-full p-1 border rounded"></div>
                        <div class="flex-grow min-w-[80px]"><label class="text-xs">ไปเป็น (To):</label><input type="text" id="scTo" placeholder="f, d, o, ɛ (ปล่อยว่างเพื่อลบ)" class="w-full p-1 border rounded"></div>
                        <div class="flex-grow min-w-[80px]"><label class="text-xs">Context ก่อนหน้า:</label><input type="text" id="scContextBefore" placeholder="V_, #_, C_" class="w-full p-1 border rounded"></div>
                        <div class="flex-grow min-w-[80px]"><label class="text-xs">Context หลัง:</label><input type="text" id="scContextAfter" placeholder="_V, _#, _C" class="w-full p-1 border rounded"></div>
                        <button id="addSoundChangeRuleBtn" class="btn-secondary px-2 py-1 rounded text-xs self-end">เพิ่มกฎ</button>
                    </div>
                     <p class="text-xs text-gray-500">ใช้ V แทนสระ, C แทนพยัญชนะ, # แทนขอบคำ. เช่น: V_V (ระหว่างสระ), #_ (ต้นคำ)</p>
                </div>
                <div id="soundChangeRulesList" class="text-sm space-y-1 mt-2 max-h-40 overflow-y-auto p-1 bg-red-50 rounded"></div>

                <div class="mt-4">
                    <label for="soundChangeSourceWord" class="block text-sm font-medium">ป้อนคำจากภาษาต้นทาง (รูปหน่วยเสียง):</label>
                    <input type="text" id="soundChangeSourceWord" class="w-full p-2 border rounded-md mb-1">
                    <button id="applySoundChangesBtn" class="btn-primary px-3 py-1 rounded-md text-sm">ใช้กฎ</button>
                </div>
                <div id="soundChangeResult" class="mt-2 p-3 bg-white rounded shadow">
                    <h5 class="font-semibold">ผลลัพธ์ในภาษาปลายทาง:</h5>
                    <p><strong>รูปหน่วยเสียง:</strong> <span id="scResultPhonemic"></span></p>
                    <p><strong>รูปอักขรวิธี:</strong> <span id="scResultOrthographic" class="text-lg font-semibold"></span></p>
                </div>
            `;

            document.getElementById('addSoundChangeRuleBtn').addEventListener('click', addSoundChangeRuleHandler);
            document.getElementById('applySoundChangesBtn').addEventListener('click', applySoundChangesHandler);
            renderSoundChangeRulesList();
        }

        function addSoundChangeRuleHandler() {
            const from = document.getElementById('scFrom').value.trim();
            const to = document.getElementById('scTo').value; 
            const contextBefore = document.getElementById('scContextBefore').value.trim();
            const contextAfter = document.getElementById('scContextAfter').value.trim();

            if (!from) {
                alert("กรุณาระบุ 'จาก (From)'");
                return;
            }
            if (!Array.isArray(currentLanguage.soundChangeRules)) {
                currentLanguage.soundChangeRules = [];
            }

            currentLanguage.soundChangeRules.push({ from, to, contextBefore, contextAfter });
            saveData();
            renderSoundChangeRulesList();
            document.getElementById('scFrom').value = '';
            document.getElementById('scTo').value = '';
            document.getElementById('scContextBefore').value = '';
            document.getElementById('scContextAfter').value = '';
        }

        function renderSoundChangeRulesList() {
            const listEl = document.getElementById('soundChangeRulesList');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (!currentLanguage.soundChangeRules || currentLanguage.soundChangeRules.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-500 italic">ยังไม่มีกฎการเปลี่ยนแปลงเสียงสำหรับภาษาปัจจุบัน</p>';
                return;
            }
            currentLanguage.soundChangeRules.forEach((rule, index) => {
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'flex justify-between items-center p-1 bg-white border rounded'; 
                ruleDiv.style.borderColor = 'var(--border-color-light)';
                let ruleDisplay = '';
                if (rule.contextBefore) ruleDisplay += rule.contextBefore.replace('_', '<u>&nbsp;</u>') + " ";
                ruleDisplay += `<strong>${rule.from}</strong>`;
                if (rule.contextAfter) ruleDisplay += " " + rule.contextAfter.replace('_', '<u>&nbsp;</u>');
                ruleDisplay += ` <i class="fas fa-arrow-right text-red-500 mx-1"></i> `;
                if (rule.contextBefore) ruleDisplay += rule.contextBefore.replace('_', '<u>&nbsp;</u>') + " ";
                ruleDisplay += `<strong>${rule.to || 'Ø'}</strong>`; 
                if (rule.contextAfter) ruleDisplay += " " + rule.contextAfter.replace('_', '<u>&nbsp;</u>');


                ruleDiv.innerHTML = `
                    <span>${ruleDisplay}</span>
                    <button class="text-xs text-red-400 hover:text-red-600" onclick="removeSoundChangeRule(${index})">&times;</button>
                `;
                listEl.appendChild(ruleDiv);
            });
        }

        window.removeSoundChangeRule = (index) => {
            currentLanguage.soundChangeRules.splice(index, 1);
            saveData();
            renderSoundChangeRulesList();
        };

        function applySoundChangesHandler() {
            const sourceLangName = document.getElementById('soundChangeSourceLang').value || currentLanguage.name; 
            const targetLangName = document.getElementById('soundChangeTargetLang').value;
            let sourceWordPhonemic = document.getElementById('soundChangeSourceWord').value.trim();

            const resultPhonemicEl = document.getElementById('scResultPhonemic');
            const resultOrthographicEl = document.getElementById('scResultOrthographic');
            resultPhonemicEl.textContent = '';
            resultOrthographicEl.textContent = '';


            if (!sourceWordPhonemic || !targetLangName) { 
                alert("กรุณาป้อนคำศัพท์ และเลือกภาษาปลายทาง");
                return;
            }

            let currentPhonemic = sourceWordPhonemic;
            const rulesToApply = currentLanguage.soundChangeRules || []; 

            rulesToApply.forEach(rule => {
                const V = `(${(currentLanguage.phonology.vowels || []).join('|')})`;
                const C = `(${(currentLanguage.phonology.consonants || []).join('|')})`;

                let pattern = rule.from.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 

                let prefix = rule.contextBefore.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                let suffix = rule.contextAfter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

                prefix = prefix.replace(/V/g, V).replace(/C/g, C).replace(/#/g, '(?:^|\\s)'); // # is word boundary (start or after space)
                suffix = suffix.replace(/V/g, V).replace(/C/g, C).replace(/#/g, '(?:$|\\s)'); // # is word boundary (end or before space)
                
                let finalPattern = pattern;
                if (prefix) {
                    if (prefix.endsWith('_')) finalPattern = `(?<=${prefix.slice(0, -1)})${finalPattern}`;
                    else finalPattern = `(?<=${prefix})${finalPattern}`; 
                }
                if (suffix) {
                    if (suffix.startsWith('_')) finalPattern = `${finalPattern}(?=${suffix.slice(1)})`;
                    else finalPattern = `${finalPattern}(?=${suffix})`; 
                }
                
                try {
                    const regex = new RegExp(finalPattern, 'g');
                    currentPhonemic = currentPhonemic.replace(regex, rule.to);
                } catch (e) {
                    console.warn("Error in sound change regex:", e, "Rule:", rule, "Pattern:", finalPattern);
                    // Fallback to simple replacement if regex fails (less accurate for context)
                    if(!prefix.includes("(?<=") && !suffix.includes("(?=")){ // Only simple replace if no complex lookarounds
                        currentPhonemic = currentPhonemic.split(rule.from).join(rule.to);
                    }
                }
            });

            resultPhonemicEl.textContent = currentPhonemic;

            const targetLang = allLanguages.find(l => l.name === targetLangName);
            if (targetLang) {
                const originalOrthoSettings = JSON.parse(JSON.stringify(currentLanguage.orthography));
                currentLanguage.orthography = JSON.parse(JSON.stringify(targetLang.orthography)); // Use target lang's ortho
                resultOrthographicEl.textContent = phonemicToOrthographic(currentPhonemic);
                currentLanguage.orthography = originalOrthoSettings; // Restore
            } else {
                resultOrthographicEl.textContent = phonemicToOrthographic(currentPhonemic) + " (ใช้ระบบอักษรภาษาปัจจุบัน)";
            }
        }


        function renderToolsUI(container) {
            container.classList.add(tabs.find(t=>t.id === 'tools').sectionClass);
            const existingSection = container.querySelector('.tools-main-section');
            if(existingSection) existingSection.remove();

            const section = document.createElement('div');
            section.className = 'tools-main-section p-3 border rounded-md space-y-4'; // Themed
            const titleElement = container.querySelector('h3.text-xl.font-semibold');
            if (titleElement) titleElement.insertAdjacentElement('afterend', section);
            else container.appendChild(section);


            currentLanguage.info = currentLanguage.info || JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE.info));

            const refLangContainer = document.createElement('div'); // Container for this list input
            section.appendChild(refLangContainer); // Add to the main tools section first

            createListInput(refLangContainer, '🌐 ภาษาอ้างอิง (Reference Languages)',
                currentLanguage.info.referenceLanguages || [],
                "เช่น บาลี, สันสกฤต, อังกฤษ",
                (item) => {
                    if (!currentLanguage.info.referenceLanguages) currentLanguage.info.referenceLanguages = [];
                    if (!currentLanguage.info.referenceLanguages.includes(item)) {
                        currentLanguage.info.referenceLanguages.push(item);
                    }
                    renderToolsUI(tabContentContainer); saveData(); // Re-render this tab specifically
                },
                (index) => { currentLanguage.info.referenceLanguages.splice(index, 1); renderToolsUI(tabContentContainer); saveData(); },
                { tooltip: "ภาษาเหล่านี้อาจมีอิทธิพลต่อการสร้างคำ (ในอนาคต) หรือเป็นแหล่งที่มาของคำยืม"}
            );


            const translatorHTML = `
                <div class="p-3 bg-white rounded shadow">
                    <h4 class="font-semibold text-gray-700 mb-2">🌍 ตัวแปลภาษา (อย่างง่าย)</h4>
                    <textarea id="translatorInput" class="w-full p-2 border rounded-md mb-2" rows="3" placeholder="ป้อนข้อความ (อังกฤษ หรือ ไทย) เพื่อแปล..."></textarea>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="translateFromLang" class="p-2 border rounded-md">
                            <option value="en">อังกฤษ</option>
                            <option value="th">ไทย</option>
                        </select>
                        <span> <i class="fas fa-arrow-right mx-1"></i> <strong id="translatorTargetLangName">${currentLanguage.name || 'ภาษาของคุณ'}</strong></span>
                    </div>
                    <button id="translateButton" class="btn-primary bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded-md text-sm">แปล</button>
                    <div class="mt-2">
                        <strong>ผลลัพธ์:</strong>
                        <p id="translatorOutput" class="p-2 bg-gray-50 rounded border min-h-[40px]"></p>
                    </div>
                </div>
            `;
            section.innerHTML += translatorHTML;

            const nameGeneratorHTML = `
                <div class="p-3 bg-white rounded shadow">
                    <h4 class="font-semibold text-gray-700 mb-2">👤🗺️ ระบบสร้างชื่อ (คน, สถานที่)</h4>
                    <div class="flex gap-2 mb-2 items-center flex-wrap">
                        <label for="nameTypeSelect" class="text-sm">ประเภท:</label>
                        <select id="nameTypeSelect" class="p-1 border rounded-md text-sm">
                            <option value="person">ชื่อคน</option>
                            <option value="place">ชื่อสถานที่</option>
                        </select>
                        <label for="numNamesToGenerate" class="text-sm ml-2">จำนวน:</label>
                        <input type="number" id="numNamesToGenerate" value="3" min="1" max="10" class="w-16 p-1 border rounded-md text-sm">
                        <button id="generateNamesButton" class="btn-primary bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded-md text-sm">สร้างชื่อ</button>
                    </div>
                    <ul id="generatedNamesList" class="list-disc list-inside text-sm min-h-[40px] p-2 bg-gray-50 rounded border"></ul>
                </div>
            `;
             section.innerHTML += nameGeneratorHTML;

            const themeHTML = `
                <div class="p-3 bg-white rounded shadow">
                    <h4 class="font-semibold text-gray-700 mb-2">🎨 ธีมภาษา (ตัวอย่าง)</h4>
                     <p class="text-xs text-gray-500 mb-2">การเปลี่ยนธีมอาจมีผลต่อการสร้างคำหรือรูปแบบบางอย่างในอนาคต (ปัจจุบันเป็นตัวเลือกเชิงแนวคิด)</p>
                    <select id="languageThemeSelect" class="w-full p-2 border rounded-md">
                        <option value="default" ${currentLanguage.theme === 'default' ? 'selected' : ''}>ปกติ (Default)</option>
                        <option value="elvish" ${currentLanguage.theme === 'elvish' ? 'selected' : ''}>ภาษาเอลฟ์</option>
                        <option value="orcish" ${currentLanguage.theme === 'orcish' ? 'selected' : ''}>ภาษาออร์ค</option>
                        <option value="draconic" ${currentLanguage.theme === 'draconic' ? 'selected' : ''}>ภาษามังกร</option>
                        <option value="ancient" ${currentLanguage.theme === 'ancient' ? 'selected' : ''}>ภาษาโบราณ</option>
                        <option value="tribal" ${currentLanguage.theme === 'tribal' ? 'selected' : ''}>ภาษาชนเผ่า</option>
                        <option value="serpent" ${currentLanguage.theme === 'serpent' ? 'selected' : ''}>ภาษางู</option>
                        <option value="human" ${currentLanguage.theme === 'human' ? 'selected' : ''}>ภาษามนุษย์ทั่วไป</option>
                    </select>
                </div>
            `;
            section.innerHTML += themeHTML;

            const dataManagementHTML = `
                <div class="p-3 bg-white rounded shadow">
                    <h4 class="font-semibold text-gray-700 mb-2">💾 จัดการข้อมูล</h4>
                    <div class="flex gap-2 flex-wrap">
                        <button id="exportAllDataBtn" class="btn-secondary bg-teal-500 hover:bg-teal-600 px-3 py-1 rounded-md text-sm">Export All Data (JSON)</button>
                        <div>
                             <label for="importAllDataInput" class="btn-secondary bg-orange-500 hover:bg-orange-600 px-3 py-1 rounded-md text-sm cursor-pointer">Import All Data (JSON)</label>
                             <input type="file" id="importAllDataInput" class="hidden" accept=".json">
                        </div>
                    </div>
                     <p class="text-xs text-gray-500 mt-2">ข้อมูลจะถูกบันทึกอัตโนมัติในเบราว์เซอร์ของคุณอยู่แล้ว</p>
                </div>
            `;
            section.innerHTML += dataManagementHTML;


            const translatorTargetLangNameEl = document.getElementById('translatorTargetLangName');
            if(translatorTargetLangNameEl) translatorTargetLangNameEl.textContent = currentLanguage.name || 'ภาษาของคุณ';


            document.getElementById('translateButton').addEventListener('click', translateText);
            document.getElementById('generateNamesButton').addEventListener('click', generateNames);
            document.getElementById('languageThemeSelect').addEventListener('change', (e) => {
                currentLanguage.theme = e.target.value;
                alert(`เลือกธีม: ${e.target.options[e.target.selectedIndex].text}. การปรับใช้ธีมอาจมีผลในอนาคต`);
                saveData();
            });

            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importAllDataInput').addEventListener('change', importAllData);
        }

        function translateText() {
            const input = document.getElementById('translatorInput').value.toLowerCase();
            const fromLang = document.getElementById('translateFromLang').value;
            const outputP = document.getElementById('translatorOutput');
            let translatedText = '';

            const words = input.split(/\s+/);
            words.forEach(word => {
                if (!word) return;
                let foundEntry = null;
                if (fromLang === 'th') {
                    foundEntry = (currentLanguage.lexicon || []).find(entry => (entry.meaning || "").toLowerCase().includes(word));
                } else { // from 'en' or other future source languages
                     foundEntry = (currentLanguage.lexicon || []).find(entry =>
                        (entry.synonyms && entry.synonyms.some(s => s.toLowerCase() === word)) || // Check synonyms first
                         (entry.meaning || "").toLowerCase().includes(word) // Then check if English word is in meaning
                    );
                    if (!foundEntry) { // Fallback to check if input matches conlang word directly (e.g. user types conlang word)
                        foundEntry = (currentLanguage.lexicon || []).find(entry => entry.word.toLowerCase() === word);
                    }
                }

                if (foundEntry) {
                    translatedText += foundEntry.word + ' ';
                } else {
                    translatedText += `(${word}?) `; // Placeholder for unfound words
                }
            });
            outputP.textContent = translatedText.trim();
        }

        function generateNames() {
            const nameType = document.getElementById('nameTypeSelect').value;
            const numNames = parseInt(document.getElementById('numNamesToGenerate').value);
            const listElement = document.getElementById('generatedNamesList');
            listElement.innerHTML = '';

            if (!currentLanguage.phonology.consonants || currentLanguage.phonology.consonants.length === 0 ||
                !currentLanguage.phonology.vowels || currentLanguage.phonology.vowels.length === 0) {
                alert("กรุณากำหนดพยัญชนะและสระในระบบเสียงก่อน");
                return;
            }


            for (let i = 0; i < numNames; i++) {
                // Adjust syllable count based on name type (simple example)
                const numSyll = (nameType === 'person') ?
                    Math.floor(Math.random() * 2) + 2 : // 2-3 syllables for person names
                    Math.floor(Math.random() * 3) + 2;  // 2-4 syllables for place names

                let phonemicName = '';
                for (let j = 0; j < numSyll; j++) {
                    phonemicName += generateSyllable();
                }
                // Capitalize the first letter of the phonemic name before converting to orthographic
                const capitalizedPhonemicName = phonemicName.charAt(0).toUpperCase() + phonemicName.slice(1);
                const orthographicDisplayName = phonemicToOrthographic(capitalizedPhonemicName);


                const listItem = document.createElement('li');
                listItem.textContent = orthographicDisplayName;
                if (orthographicDisplayName !== capitalizedPhonemicName) { // Show phonemic if different
                    listItem.title = `รูปหน่วยเสียง: ${capitalizedPhonemicName}`;
                }
                listElement.appendChild(listItem);
            }
        }

        function exportAllData() {
            saveData(); // Ensure current state is saved to allLanguages
            const dataToExport = {
                allLanguages: allLanguages,
                currentLanguageName: currentLanguage.name // Also save which language was active
            };
            const jsonData = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conlang_backup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("ข้อมูลทั้งหมดถูก Export แล้ว!");
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.allLanguages && Array.isArray(importedData.allLanguages)) {
                            allLanguages = importedData.allLanguages.map(lang =>
                                deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), lang)
                            );

                            let langToLoadName = importedData.currentLanguageName;
                            let langToLoad = allLanguages.find(l => l.name === langToLoadName);

                            if (langToLoad) {
                                currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), langToLoad);
                            } else if (allLanguages.length > 0) {
                                currentLanguage = deepMerge(JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE)), allLanguages[0]);
                            } else { // No languages in imported data, or currentLanguageName was invalid
                                currentLanguage = JSON.parse(JSON.stringify(DEFAULT_LANGUAGE_STATE));
                                // If modal is hidden and it shouldn't be (because no lang is active)
                                if (languageNameModal.classList.contains('hidden')) {
                                     languageNameModal.classList.remove('hidden');
                                     existingLanguageLoaderSectionModal.classList.add('hidden');
                                     mainContent.classList.add('disabled-section');
                                }
                            }

                            saveData(); // Save the newly imported data to localStorage
                            renderLanguageSelector(); // Update main language selector
                            currentLanguageNameDisplay.textContent = currentLanguage.name || "N/A";
                            if (languageSelector && currentLanguage.name) languageSelector.value = currentLanguage.name;


                            // Update initial modal state based on imported data
                            if (!currentLanguage.name && allLanguages.length === 0) {
                                languageNameModal.classList.remove('hidden');
                                existingLanguageLoaderSectionModal.classList.add('hidden');
                                mainContent.classList.add('disabled-section');
                            } else {
                                languageNameModal.classList.add('hidden'); // Hide if a language is now active
                                if (allLanguages.length > 0) {
                                    modalExistingLanguageSelector.innerHTML = '<option value="">-- เลือกภาษา --</option>';
                                    allLanguages.forEach(lang => {
                                        const option = document.createElement('option');
                                        option.value = lang.name;
                                        option.textContent = lang.name;
                                        modalExistingLanguageSelector.appendChild(option);
                                    });
                                    if (currentLanguage.name) modalExistingLanguageSelector.value = currentLanguage.name;
                                    existingLanguageLoaderSectionModal.classList.remove('hidden');
                                } else {
                                    existingLanguageLoaderSectionModal.classList.add('hidden');
                                }
                                mainContent.classList.remove('disabled-section');
                            }
                            updateUI(); // Refresh the entire UI
                            alert("นำเข้าข้อมูลสำเร็จ!");
                        } else {
                            alert("ไฟล์ไม่ถูกต้อง: ไม่พบ 'allLanguages' array หรือรูปแบบไม่ถูกต้อง");
                        }
                    } catch (error) {
                        console.error("Error importing data:", error);
                        alert("เกิดข้อผิดพลาดในการนำเข้าข้อมูล: " + error.message);
                    } finally {
                        // Reset file input to allow importing the same file again if needed
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            }
        }

    </script>
</body>
</html>
